<div class="main-container">
  <!-- Routes Card -->
  <div class="card-modern animate-fade-in">
    <div class="card-header-modern">
      <h2><i class="fa fa-sitemap"></i> <%= __('routes.title') %></h2>
      <div class="d-flex gap-2">
        <button type="button" class="btn-modern btn-modern-danger" id="bulkDeleteBtn" onclick="openBulkDeleteModal()" style="display: none;">
          <i class="fa fa-trash"></i> <span id="bulkDeleteCount"></span>
        </button>
        <div class="dropdown-modern">
          <button type="button" class="btn-modern btn-modern-secondary dropdown-toggle" onclick="toggleToolsDropdown()">
            <i class="fa fa-cog"></i> <%= __('routes.tools') %>
          </button>
          <div class="dropdown-menu-modern" id="toolsDropdownMenu">
            <button type="button" class="dropdown-item-modern" onclick="normalizeOrder(); closeToolsDropdown();">
              <i class="fa fa-sort-numeric-asc"></i> <%= __('routes.normalize') %>
            </button>
            <button type="button" class="dropdown-item-modern" onclick="openTagManager(); closeToolsDropdown();">
              <i class="fa fa-tags"></i> <%= __('form.manageTags') %>
            </button>
            <button type="button" class="dropdown-item-modern" onclick="openExportImportModal(); closeToolsDropdown();">
              <i class="fa fa-exchange"></i> <%= __('exportImport.title') %>
            </button>
          </div>
        </div>
        <button type="button" class="btn-modern btn-modern-secondary" onclick="openList()" style="position: relative;">
          <i class="fa fa-list"></i> <%= __('routes.pendingList') %>
          <% if (listaEspera.length > 0) { %>
          <span id="pendingBadge" class="pending-badge"><%=listaEspera.length %></span>
          <% } else { %>
          <span id="pendingBadge" class="pending-badge" style="display: none;">0</span>
          <% } %>
        </button>
        <button type="button" class="btn-modern btn-modern-secondary" onclick="openImportModal()">
          <i class="fa fa-upload"></i> <%= __('routes.importOpenApi') %>
        </button>
        <button type="button" class="btn-modern btn-modern-primary" onclick="openModal('create')">
          <i class="fa fa-plus"></i> <%= __('routes.newRoute') %>
        </button>
      </div>
    </div>
    <div class="card-body-modern">
      <!-- Filtros de tabla -->
      <div class="table-filters">
        <div class="filter-group">
          <label class="filter-label" for="filterMethod"><%= __('filters.method') %></label>
          <select id="filterMethod" name="filterMethod" class="filter-select" onchange="applyFilters()">
            <option value=""><%= __('filters.all') %></option>
            <option value="get">GET</option>
            <option value="post">POST</option>
            <option value="put">PUT</option>
            <option value="delete">DELETE</option>
            <option value="patch">PATCH</option>
            <option value="options">OPTIONS</option>
            <option value="head">HEAD</option>
            <option value="any">ANY</option>
          </select>
        </div>
        <div class="filter-group filter-group-large">
          <label class="filter-label" for="filterRouteValue"><%= __('filters.route') %></label>
          <div class="filter-route-wrapper">
            <select id="filterRouteType" name="filterRouteType" class="filter-select filter-route-type" onchange="applyFilters()">
              <option value="contains"><%= __('filters.contains') %></option>
              <option value="startsWith"><%= __('filters.startsWith') %></option>
              <option value="endsWith"><%= __('filters.endsWith') %></option>
              <option value="equals"><%= __('filters.equals') %></option>
              <option value="regex"><%= __('filters.regexOption') %></option>
            </select>
            <input type="text" id="filterRouteValue" name="filterRouteValue" class="filter-input" placeholder="<%= __('filters.searchRoute') %>" oninput="applyFilters()">
          </div>
        </div>
        <div class="filter-group">
          <label class="filter-label" for="filterType"><%= __('filters.responseType') %></label>
          <select id="filterType" name="filterType" class="filter-select" onchange="applyFilters()">
            <option value=""><%= __('filters.all') %></option>
            <option value="json">JSON</option>
            <option value="xml">XML</option>
            <option value="soap">SOAP</option>
            <option value="text">Texto</option>
            <option value="html">HTML</option>
            <option value="page">Page</option>
            <option value="file">Archivo</option>
            <option value="proxy">Proxy</option>
            <option value="graphql">GraphQL</option>
            <option value="empty">Empty</option>
          </select>
        </div>
        <div class="filter-group">
          <label class="filter-label" for="filterCode"><%= __('filters.code') %></label>
          <select id="filterCode" name="filterCode" class="filter-select" onchange="applyFilters()">
            <option value=""><%= __('filters.all') %></option>
            <option value="2xx"><%= __('filters.success2xx') %></option>
            <option value="3xx"><%= __('filters.redirect3xx') %></option>
            <option value="4xx"><%= __('filters.clientError4xx') %></option>
            <option value="5xx"><%= __('filters.serverError5xx') %></option>
          </select>
        </div>
        <div class="filter-group">
          <label class="filter-label" for="filterRegex"><%= __('filters.regex') %></label>
          <select id="filterRegex" name="filterRegex" class="filter-select" onchange="applyFilters()">
            <option value=""><%= __('filters.all') %></option>
            <option value="1"><%= __('filters.yes') %></option>
            <option value="0"><%= __('filters.no') %></option>
          </select>
        </div>
        <div class="filter-group">
          <label class="filter-label" for="filterWait"><%= __('filters.wait') %></label>
          <select id="filterWait" name="filterWait" class="filter-select" onchange="applyFilters()">
            <option value=""><%= __('filters.all') %></option>
            <option value="1"><%= __('filters.yes') %></option>
            <option value="0"><%= __('filters.no') %></option>
          </select>
        </div>
        <div class="filter-group">
          <label class="filter-label" for="filterActivo"><%= __('filters.active') %></label>
          <select id="filterActivo" name="filterActivo" class="filter-select" onchange="applyFilters()">
            <option value=""><%= __('filters.all') %></option>
            <option value="1"><%= __('filters.yes') %></option>
            <option value="0"><%= __('filters.no') %></option>
          </select>
        </div>
        <div class="filter-group">
          <label class="filter-label"><%= __('filters.tags') %></label>
          <div class="tags-filter-dropdown" id="tagsFilterDropdown">
            <button type="button" class="tags-filter-button" onclick="toggleTagsFilterDropdown()">
              <span id="tagsFilterLabel"><%= __('filters.all') %></span>
              <i class="fa fa-chevron-down"></i>
            </button>
            <div class="tags-filter-menu" id="tagsFilterMenu">
              <!-- Options populated by JS -->
            </div>
          </div>
        </div>
        <div class="filter-group filter-actions">
          <button class="btn-filter-clear" onclick="clearFilters()" title="<%= __('filters.clear') %>">
            <i class="fa fa-times"></i> <%= __('filters.clear') %>
          </button>
        </div>
      </div>

      <div class="table-modern-wrapper">
        <table id="dtList" class="table-modern" style="width:100%">
          <thead>
            <tr>
              <th><%= __('table.id') %></th>
              <th><input type="checkbox" id="selectAllRoutes" onchange="toggleSelectAllRoutes(this.checked)" title="<%= __('bulk.selectAll') %>"></th>
              <th><%= __('table.order') %></th>
              <th><%= __('table.method') %></th>
              <th><%= __('table.route') %></th>
              <th><%= __('table.type') %></th>
              <th><%= __('table.code') %></th>
              <th><%= __('table.regex') %></th>
              <th><%= __('table.wait') %></th>
              <th><%= __('table.active') %></th>
              <th><%= __('table.actions') %></th>
            </tr>
          </thead>
          <tbody>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Terminal Card -->
  <div class="card-modern animate-fade-in" style="margin-top: 2rem;">
    <div class="card-body terminal" style="height: 650px; padding: 0; border-radius: var(--border-radius);">
      <div class="terminal-header">
        <div class="dots">
          <span class="dot red"></span>
          <span class="dot yellow"></span>
          <span class="dot green"></span>
        </div>
        <span class="title"><%= __('terminal.title') %></span>
        <div class="terminal-actions">
          <button onclick="Terminal.clear()" title="<%= __('terminal.clearTitle') %>">
            <i class="fa fa-trash"></i> <%= __('buttons.clear') %>
          </button>
          <button onclick="Terminal.toggleAutoScroll()" id="btnAutoScroll" title="<%= __('terminal.autoScrollTitle') %>">
            <i class="fa fa-arrow-down"></i> <%= __('buttons.auto') %>
          </button>
          <button onclick="Terminal.exportLogs()" title="<%= __('terminal.exportTitle') %>">
            <i class="fa fa-download"></i> <%= __('buttons.export') %>
          </button>
        </div>
      </div>
      <div class="console">
        <div class="output" id="salidaconsola">
        </div>
      </div>
    </div>
  </div>
</div>

<%- include('modals/import-openapi') %>

<%- include('modals/route-form') %>

<%- include('modals/pending-list') %>

<%- include('modals/curl-example') %>
<%- include('modals/delete') %>
<%- include('modals/bulk-delete') %>
<%- include('modals/connection') %>
<%- include('modals/duplicate') %>
<%- include('modals/criteria-help') %>
<%- include('modals/request-tester') %>
<%- include('modals/graphiql-tester') %>
<%- include('modals/tag-manager') %>
<%- include('modals/export-import') %>

<script src="/js/socket.io.js"></script>

<script>
  let totalPending = Number('<%=listaEspera.length %>');
  // Socket.io usa el mismo puerto que la web
  const socket = io();

  // ===== TERMINAL MODULE =====
  const Terminal = {
    container: null,
    autoScroll: true,
    logs: [],
    maxLogs: 1000,

    init() {
      this.container = document.getElementById("salidaconsola");
      this.updateAutoScrollButton();
    },

    addEntry(data) {
      const entry = document.createElement('div');
      entry.className = `log-entry ${data.type || 'info'}`;

      let message = data.texto || data;
      let timestamp = '';

      const timestampMatch = message.match(/^\[(\d{2}:\d{2}:\d{2}\.\d{3})\]\s*/);
      if (timestampMatch) {
        timestamp = timestampMatch[1];
        message = message.replace(timestampMatch[0], '');
      }

      // Si es un log colapsable (proxy detallado)
      if (data.collapsible && data.details) {
        const detailsId = 'proxy-details-' + Date.now();
        entry.classList.add('log-collapsible');
        entry.innerHTML = `
          ${timestamp ? `<span class="timestamp">${timestamp}</span>` : ''}
          <span class="message">${this.escapeHtml(message)}</span>
          <button class="log-toggle-btn" onclick="Terminal.toggleDetails('${detailsId}')" title="Ver detalles">
            <i class="fa fa-chevron-down"></i>
          </button>
          <div id="${detailsId}" class="log-details" style="display: none;">
            ${this.renderProxyDetails(data.details)}
          </div>
        `;
      } else {
        entry.innerHTML = `
          ${timestamp ? `<span class="timestamp">${timestamp}</span>` : ''}
          <span class="message">${this.escapeHtml(message)}</span>
        `;
      }

      this.container.appendChild(entry);
      this.logs.push({ timestamp: new Date(), type: data.type, message, details: data.details });

      if (this.logs.length > this.maxLogs) {
        this.logs.shift();
        if (this.container.firstChild) {
          this.container.removeChild(this.container.firstChild);
        }
      }

      if (this.autoScroll) {
        this.scrollToBottom();
      }
    },

    toggleDetails(id) {
      const details = document.getElementById(id);
      const btn = details.previousElementSibling;
      if (details.style.display === 'none') {
        details.style.display = 'block';
        btn.innerHTML = '<i class="fa fa-chevron-up"></i>';
        btn.classList.add('active');
      } else {
        details.style.display = 'none';
        btn.innerHTML = '<i class="fa fa-chevron-down"></i>';
        btn.classList.remove('active');
      }
    },

    renderProxyDetails(details) {
      const { request, response } = details;
      return `
        <div class="proxy-details-container">
          <div class="proxy-details-section">
            <div class="proxy-details-header" onclick="this.parentElement.classList.toggle('expanded')">
              <i class="fa fa-arrow-up"></i> Outgoing Request
              <i class="fa fa-chevron-right toggle-icon"></i>
            </div>
            <div class="proxy-details-content">
              <div class="proxy-details-row">
                <span class="proxy-details-label">URL:</span>
                <code class="proxy-details-value">${this.escapeHtml(request.target || request.url)}</code>
              </div>
              <div class="proxy-details-row">
                <span class="proxy-details-label">Method:</span>
                <span class="proxy-details-value">${request.method}</span>
              </div>
              <div class="proxy-details-subsection">
                <div class="proxy-details-subheader" onclick="this.parentElement.classList.toggle('expanded')">
                  <i class="fa fa-list"></i> Headers
                  <i class="fa fa-chevron-right toggle-icon"></i>
                </div>
                <div class="proxy-details-subcontent">
                  <pre class="proxy-details-pre">${this.escapeHtml(JSON.stringify(request.headers, null, 2))}</pre>
                </div>
              </div>
              ${request.body ? `
              <div class="proxy-details-subsection">
                <div class="proxy-details-subheader" onclick="this.parentElement.classList.toggle('expanded')">
                  <i class="fa fa-file-text-o"></i> Body
                  <i class="fa fa-chevron-right toggle-icon"></i>
                </div>
                <div class="proxy-details-subcontent">
                  <pre class="proxy-details-pre">${this.escapeHtml(typeof request.body === 'object' ? JSON.stringify(request.body, null, 2) : request.body)}</pre>
                </div>
              </div>
              ` : ''}
            </div>
          </div>
          <div class="proxy-details-section">
            <div class="proxy-details-header" onclick="this.parentElement.classList.toggle('expanded')">
              <i class="fa fa-arrow-down"></i> Incoming Response
              <span class="proxy-status-badge status-${Math.floor(response.statusCode / 100)}xx">${response.statusCode}</span>
              <i class="fa fa-chevron-right toggle-icon"></i>
            </div>
            <div class="proxy-details-content">
              <div class="proxy-details-subsection">
                <div class="proxy-details-subheader" onclick="this.parentElement.classList.toggle('expanded')">
                  <i class="fa fa-list"></i> Headers
                  <i class="fa fa-chevron-right toggle-icon"></i>
                </div>
                <div class="proxy-details-subcontent">
                  <pre class="proxy-details-pre">${this.escapeHtml(JSON.stringify(response.headers, null, 2))}</pre>
                </div>
              </div>
              ${response.body ? `
              <div class="proxy-details-subsection">
                <div class="proxy-details-subheader" onclick="this.parentElement.classList.toggle('expanded')">
                  <i class="fa fa-file-text-o"></i> Body ${response.body.truncated ? '<span class="truncated-badge">(truncado)</span>' : ''}
                  <i class="fa fa-chevron-right toggle-icon"></i>
                </div>
                <div class="proxy-details-subcontent">
                  <pre class="proxy-details-pre ${response.body.type === 'json' ? 'json-body' : ''}">${this.escapeHtml(
                    response.body.type === 'json'
                      ? JSON.stringify(response.body.data, null, 2)
                      : (response.body.data || '')
                  )}</pre>
                </div>
              </div>
              ` : ''}
            </div>
          </div>
        </div>
      `;
    },

    clear() {
      this.container.innerHTML = '';
      this.logs = [];
      this.addEntry({ texto: t('terminal.cleared'), type: 'info' });
    },

    toggleAutoScroll() {
      this.autoScroll = !this.autoScroll;
      this.updateAutoScrollButton();
      if (this.autoScroll) {
        this.scrollToBottom();
      }
    },

    updateAutoScrollButton() {
      const btn = document.getElementById('btnAutoScroll');
      if (btn) {
        btn.style.background = this.autoScroll ? 'rgba(39, 202, 64, 0.3)' : 'rgba(255, 255, 255, 0.1)';
      }
    },

    scrollToBottom() {
      const consoleEl = this.container.parentElement;
      consoleEl.scrollTo({ top: consoleEl.scrollHeight, behavior: 'smooth' });
    },

    exportLogs() {
      const content = this.logs.map(l =>
        `[${l.timestamp.toISOString()}] [${l.type}] ${l.message}`
      ).join('\n');

      const blob = new Blob([content], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `mockserver-logs-${new Date().toISOString().slice(0,10)}.txt`;
      a.click();
      URL.revokeObjectURL(url);
    },

    escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
  };

  document.addEventListener('DOMContentLoaded', () => Terminal.init());

  // ===== CONNECTION METRICS MODULE =====
  const ConnectionMetrics = {
    status: 'disconnected',
    connectedSince: null,
    messagesReceived: 0,
    messagesSent: 0,
    consoleEvents: 0,
    reconnects: 0,
    lastReconnect: null,
    latency: null,
    pingInterval: null,
    durationInterval: null,

    init() {
      this.startPingInterval();
    },

    startPingInterval() {
      // Medir latencia cada 5 segundos
      this.pingInterval = setInterval(() => {
        if (this.status === 'connected') {
          const start = Date.now();
          socket.emit('ping', () => {
            this.latency = Date.now() - start;
            this.updateModalLatency();
          });
        }
      }, 5000);

      // Actualizar duración cada segundo
      this.durationInterval = setInterval(() => {
        this.updateModalDuration();
      }, 1000);
    },

    setStatus(status) {
      this.status = status;
      if (status === 'connected' && !this.connectedSince) {
        this.connectedSince = new Date();
      } else if (status === 'disconnected') {
        this.connectedSince = null;
        this.latency = null;
      }
      this.updateNavbarStatus();
      this.updateModalStatus();
    },

    incrementReceived() {
      this.messagesReceived++;
      this.updateElement('connMsgReceived', this.messagesReceived);
    },

    incrementSent() {
      this.messagesSent++;
      this.updateElement('connMsgSent', this.messagesSent);
    },

    incrementConsoleEvents() {
      this.consoleEvents++;
      this.updateElement('connConsoleEvents', this.consoleEvents);
    },

    incrementReconnects() {
      this.reconnects++;
      this.lastReconnect = new Date();
      this.updateElement('connReconnects', this.reconnects);
      this.updateElement('connLastReconnect', this.formatTime(this.lastReconnect));
    },

    updateNavbarStatus() {
      const statusDot = document.getElementById('statusDot');
      const statusText = document.getElementById('statusText');
      const serverStatus = document.getElementById('serverStatus');

      if (!statusDot || !statusText) return;

      serverStatus.classList.remove('status-connected', 'status-disconnected', 'status-reconnecting');

      switch(this.status) {
        case 'connected':
          statusDot.style.background = 'var(--success)';
          statusDot.style.boxShadow = '0 0 8px var(--success)';
          statusText.textContent = t('nav.serverActive');
          serverStatus.classList.add('status-connected');
          break;
        case 'disconnected':
          statusDot.style.background = 'var(--danger)';
          statusDot.style.boxShadow = '0 0 8px var(--danger)';
          statusText.textContent = t('nav.serverInactive');
          serverStatus.classList.add('status-disconnected');
          break;
        case 'reconnecting':
          statusDot.style.background = 'var(--warning)';
          statusDot.style.boxShadow = '0 0 8px var(--warning)';
          statusText.textContent = t('nav.reconnecting');
          serverStatus.classList.add('status-reconnecting');
          break;
      }
    },

    updateModalStatus() {
      const connDot = document.getElementById('connDot');
      const connLabel = document.getElementById('connLabel');

      if (!connDot || !connLabel) return;

      connDot.classList.remove('connected', 'disconnected', 'reconnecting');

      switch(this.status) {
        case 'connected':
          connDot.classList.add('connected');
          connLabel.textContent = t('connection.connected');
          break;
        case 'disconnected':
          connDot.classList.add('disconnected');
          connLabel.textContent = t('connection.disconnected');
          break;
        case 'reconnecting':
          connDot.classList.add('reconnecting');
          connLabel.textContent = t('connection.reconnecting');
          break;
      }

      // Actualizar info general
      this.updateElement('connType', socket.io?.engine?.transport?.name || 'WebSocket');
      this.updateElement('connUrl', window.location.origin);
      this.updateElement('connSessionId', socket.id || '-');
      this.updateElement('connSince', this.connectedSince ? this.formatTime(this.connectedSince) : '-');
    },

    updateModalLatency() {
      this.updateElement('connLatency', this.latency !== null ? `${this.latency} ms` : '-');
    },

    updateModalDuration() {
      if (this.connectedSince && this.status === 'connected') {
        const duration = Date.now() - this.connectedSince.getTime();
        this.updateElement('connDuration', this.formatDuration(duration));
      } else {
        this.updateElement('connDuration', '-');
      }
    },

    updateElement(id, value) {
      const el = document.getElementById(id);
      if (el) el.textContent = value;
    },

    formatTime(date) {
      return date.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
    },

    formatDuration(ms) {
      const seconds = Math.floor(ms / 1000);
      const minutes = Math.floor(seconds / 60);
      const hours = Math.floor(minutes / 60);

      if (hours > 0) {
        return `${hours}h ${minutes % 60}m ${seconds % 60}s`;
      } else if (minutes > 0) {
        return `${minutes}m ${seconds % 60}s`;
      } else {
        return `${seconds}s`;
      }
    }
  };

  // Inicializar métricas
  ConnectionMetrics.init();

  function openConnectionModal() {
    ConnectionMetrics.updateModalStatus();
    ConnectionMetrics.updateModalDuration();
    ConnectionMetrics.updateModalLatency();
    $('#connectionModal').modal('show');
  }

  // ===== CONNECTION STATUS =====
  // Nota: El mensaje "Conectado al servidor" lo envía el backend via socket
  socket.on('connect', function() {
    ConnectionMetrics.setStatus('connected');
    ConnectionMetrics.incrementReceived();
  });

  socket.on('disconnect', function() {
    ConnectionMetrics.setStatus('disconnected');
    ConnectionMetrics.incrementReceived();
    Terminal.addEntry({ texto: t('terminal.disconnected'), type: 'error' });
  });

  socket.on('reconnecting', function() {
    ConnectionMetrics.setStatus('reconnecting');
    ConnectionMetrics.incrementReceived();
    Terminal.addEntry({ texto: t('terminal.reconnecting'), type: 'warning' });
  });

  socket.on('reconnect', function() {
    ConnectionMetrics.setStatus('connected');
    ConnectionMetrics.incrementReconnects();
    ConnectionMetrics.incrementReceived();
  });

  socket.on('reconnect_failed', function() {
    ConnectionMetrics.setStatus('disconnected');
    ConnectionMetrics.incrementReceived();
    Terminal.addEntry({ texto: t('terminal.reconnectFailed'), type: 'error' });
  });

  // ===== SOCKET EVENTS =====
  socket.on("console", (arg) => {
    Terminal.addEntry(arg);
    ConnectionMetrics.incrementReceived();
    ConnectionMetrics.incrementConsoleEvents();
  });
  socket.on("addItem", (arg) => {
    addItemToPendingList(arg);
    ConnectionMetrics.incrementReceived();
  });
  socket.on("deleteItem", (arg) => {
    deleteItemFromPendingList(arg);
    ConnectionMetrics.incrementReceived();
  });

  // ===== DATATABLE =====
  let tabla = $('#dtList').DataTable({
    ajax: {
      type: "GET",
      url: '/api/routes',
      dataType: 'json',
      dataSrc: ''
    },
    language: {
      search: t('table.search'),
      lengthMenu: t('table.showEntries'),
      info: t('table.info'),
      infoEmpty: t('table.noResults'),
      emptyTable: t('table.emptyTable'),
      paginate: { first: "<<", previous: "<", next: ">", last: ">>" }
    },
    dom: '<"top"l>rt<"bottom"ip>', // Ocultar busqueda global, usamos filtros custom
    order: [[2, 'asc']], // Ordenar por columna orden (índice 2) por defecto
    columnDefs: [
      { target: 0, visible: false, searchable: false },
      { "width": "3%", "targets": 1, "orderable": false, "searchable": false }, // Checkbox
      { "width": "7%", "targets": 2, "type": "num" }, // Orden - tipo numérico para ordenar correctamente
      { "width": "7%", "targets": 3 },
      { "width": "28%", "targets": 4 },
      { "width": "8%", "targets": 5 },
      { "width": "7%", "targets": 6 },
      { "width": "5%", "targets": 7 },
      { "width": "5%", "targets": 8 },
      { "width": "5%", "targets": 9 },
      { "width": "19%", "targets": 10 },
      { "className": "dt-center", "targets": [1,2,3,5,6,7,8,9,10] }
    ],
    columns: [
      { data: 'id' },
      { data: null, render: function(data) {
        return `<input type="checkbox" class="route-select-check" data-id="${data.id}" onchange="updateBulkSelection()">`;
      }},
      {
        data: 'orden', // Usar el campo orden para ordenar numéricamente
        render: function (data, type, row) {
          const orden = row.orden || row.id;
          // Para ordenación, devolver el número directamente
          if (type === 'sort' || type === 'type') {
            return orden;
          }
          // Para display, devolver el HTML con controles
          return `<div class="order-controls">
            <button class="btn-order btn-order-up" onclick="moveUp(${row.id})" title="Subir prioridad"><i class="fa fa-chevron-up"></i></button>
            <input type="number" class="order-input" value="${orden}" min="1"
              onchange="updateOrden(${row.id}, this.value)"
              onclick="this.select()"
              title="Editar orden manualmente">
            <button class="btn-order btn-order-down" onclick="moveDown(${row.id})" title="Bajar prioridad"><i class="fa fa-chevron-down"></i></button>
          </div>`;
        }
      },
      { data: null, render: function (data) {
        return `<span class="badge-modern badge-${data.tipo}">${data.tipo.toUpperCase()}</span>`;
      }},
      { data: null, render: function (data) {
        let html = `<div class="route-cell">`;
        html += `<span class="route-path">${escapeHtml(data.ruta)}</span>`;

        // Parse and render tags
        if (data.tags) {
          try {
            const tags = JSON.parse(data.tags);
            if (tags.length > 0) {
              html += `<div class="route-tags">`;
              tags.forEach(tag => {
                html += `<span class="badge-tag badge-tag-sm" style="background: ${tag.color};">${escapeHtml(tag.name)}</span>`;
              });
              html += `</div>`;
            }
          } catch (e) {}
        }

        html += `</div>`;
        return html;
      }},
      { data: null, render: function (data) {
        const icons = { json: 'fa-code', xml: 'fa-file-code-o', soap: 'fa-envelope-o', text: 'fa-align-left', html: 'fa-html5', page: 'fa-file-text-o', file: 'fa-file-o', proxy: 'fa-exchange', graphql: 'fa-share-alt', empty: 'fa-circle-o' };
        return `<span class="response-type type-${data.tiporespuesta}"><i class="fa ${icons[data.tiporespuesta] || 'fa-question'}"></i> ${data.tiporespuesta}</span>`;
      }},
      { data: null, render: function (data) {
        let badgeClass = 'badge-status-2xx';
        if (data.codigo >= 300 && data.codigo < 400) badgeClass = 'badge-status-3xx';
        if (data.codigo >= 400 && data.codigo < 500) badgeClass = 'badge-status-4xx';
        if (data.codigo >= 500) badgeClass = 'badge-status-5xx';
        return `<span class="badge-modern ${badgeClass}">${data.codigo}</span>`;
      }},
      { data: null, render: function (data) {
        return data.isRegex === 1
          ? '<span class="badge-modern badge-regex">.*</span>'
          : '<span class="badge-modern badge-inactive">-</span>';
      }},
      { data: null, render: function (data) {
        const isWait = data.esperaActiva === 1;
        const isProxy = data.tiporespuesta === 'proxy';

        // Los proxy no pueden tener espera activa
        if (isProxy) {
          return `<span class="badge-modern badge-na" title="Los proxy no soportan espera activa">-</span>`;
        }

        return isWait
          ? `<span class="badge-modern badge-wait badge-clickable" onclick="toggleEsperaActiva(${data.id}, false)" title="Desactivar espera activa"><i class="fa fa-pause"></i></span>`
          : `<span class="badge-modern badge-inactive badge-clickable" onclick="toggleEsperaActiva(${data.id}, true)" title="Activar espera activa">-</span>`;
      }},
      { data: null, render: function (data) {
        const isActive = data.activo !== 0;
        return isActive
          ? `<span class="badge-modern badge-active badge-clickable" onclick="toggleActivo(${data.id}, false)" title="Desactivar ruta"><i class="fa fa-check"></i></span>`
          : `<span class="badge-modern badge-disabled badge-clickable" onclick="toggleActivo(${data.id}, true)" title="Activar ruta"><i class="fa fa-ban"></i></span>`;
      }},
      { data: null, render: function (data) {
        return `<div class="btn-group-modern">
          <button class="btn-icon btn-icon-primary" onclick="openCurlModal(${data.id})" title="${t('actions.viewExample')}"><i class="fa fa-terminal"></i></button>
          <button class="btn-icon btn-icon-success" onclick="openRequestTester(${data.id})" title="${t('actions.testRequest')}"><i class="fa fa-paper-plane"></i></button>
          <button class="btn-icon btn-icon-info" onclick="openDuplicateModal(${data.id})" title="${t('actions.duplicate')}"><i class="fa fa-copy"></i></button>
          <button class="btn-icon btn-icon-warning" onclick="openModal('edit', ${data.id})" title="${t('actions.edit')}"><i class="fa fa-pencil"></i></button>
          <button class="btn-icon btn-icon-danger" onclick="openDeleteModal(${data.id})" title="${t('actions.deleteRoute')}"><i class="fa fa-trash"></i></button>
        </div>`;
      }}
    ]
  });

  // ===== FILTROS PERSONALIZADOS =====
  // Filtro custom para DataTables
  $.fn.dataTable.ext.search.push(function(settings, data, dataIndex) {
    const rowData = tabla.row(dataIndex).data();
    if (!rowData) return true;

    // Filtro Metodo
    const filterMethod = document.getElementById('filterMethod').value;
    if (filterMethod && rowData.tipo !== filterMethod) return false;

    // Filtro Ruta
    const filterRouteType = document.getElementById('filterRouteType').value;
    const filterRouteValue = document.getElementById('filterRouteValue').value.toLowerCase();
    if (filterRouteValue) {
      const ruta = rowData.ruta.toLowerCase();
      switch (filterRouteType) {
        case 'contains':
          if (!ruta.includes(filterRouteValue)) return false;
          break;
        case 'startsWith':
          if (!ruta.startsWith(filterRouteValue)) return false;
          break;
        case 'endsWith':
          if (!ruta.endsWith(filterRouteValue)) return false;
          break;
        case 'equals':
          if (ruta !== filterRouteValue) return false;
          break;
        case 'regex':
          try {
            const regex = new RegExp(filterRouteValue, 'i');
            if (!regex.test(rowData.ruta)) return false;
          } catch (e) {
            // Regex invalida, no filtrar
          }
          break;
      }
    }

    // Filtro Tipo Respuesta
    const filterType = document.getElementById('filterType').value;
    if (filterType && rowData.tiporespuesta !== filterType) return false;

    // Filtro Codigo
    const filterCode = document.getElementById('filterCode').value;
    if (filterCode) {
      const code = parseInt(rowData.codigo);
      switch (filterCode) {
        case '2xx': if (code < 200 || code >= 300) return false; break;
        case '3xx': if (code < 300 || code >= 400) return false; break;
        case '4xx': if (code < 400 || code >= 500) return false; break;
        case '5xx': if (code < 500 || code >= 600) return false; break;
      }
    }

    // Filtro Regex
    const filterRegex = document.getElementById('filterRegex').value;
    if (filterRegex !== '') {
      const isRegex = rowData.isRegex === 1 ? '1' : '0';
      if (isRegex !== filterRegex) return false;
    }

    // Filtro Espera
    const filterWait = document.getElementById('filterWait').value;
    if (filterWait !== '') {
      const esperaActiva = rowData.esperaActiva === 1 ? '1' : '0';
      if (esperaActiva !== filterWait) return false;
    }

    // Filtro Activo
    const filterActivo = document.getElementById('filterActivo').value;
    if (filterActivo !== '') {
      const activo = rowData.activo !== 0 ? '1' : '0';
      if (activo !== filterActivo) return false;
    }

    // Filtro Tags
    const filterTags = getSelectedFilterTags();
    if (filterTags.length > 0) {
      let routeTags = [];
      try {
        routeTags = rowData.tags ? JSON.parse(rowData.tags).map(t => t.id) : [];
      } catch (e) {}

      // OR logic - route matches if it has ANY of the selected tags
      const hasMatch = filterTags.some(tagId => routeTags.includes(tagId));
      if (!hasMatch) return false;
    }

    return true;
  });

  function applyFilters() {
    tabla.draw();
    updateActiveFiltersCount();
  }

  function clearFilters() {
    document.getElementById('filterMethod').value = '';
    document.getElementById('filterRouteType').value = 'contains';
    document.getElementById('filterRouteValue').value = '';
    document.getElementById('filterType').value = '';
    document.getElementById('filterCode').value = '';
    document.getElementById('filterRegex').value = '';
    document.getElementById('filterWait').value = '';
    document.getElementById('filterActivo').value = '';
    // Clear tags filter dropdown
    clearTagFilter();
    applyFilters();
  }

  function updateActiveFiltersCount() {
    let count = 0;
    if (document.getElementById('filterMethod').value) count++;
    if (document.getElementById('filterRouteValue').value) count++;
    if (document.getElementById('filterType').value) count++;
    if (document.getElementById('filterCode').value) count++;
    if (document.getElementById('filterRegex').value) count++;
    if (document.getElementById('filterWait').value) count++;
    if (document.getElementById('filterActivo').value) count++;
    // Count selected tags from dropdown
    if (getSelectedFilterTags().length > 0) count++;

    const btn = document.querySelector('.btn-filter-clear');
    if (count > 0) {
      btn.innerHTML = `<i class="fa fa-times"></i> Limpiar (${count})`;
      btn.classList.add('has-filters');
    } else {
      btn.innerHTML = `<i class="fa fa-times"></i> Limpiar`;
      btn.classList.remove('has-filters');
    }
  }

  // Tags filter state
  let selectedFilterTags = [];
  let allFilterTags = [];

  // Initialize tag filter options
  async function initTagFilter() {
    const menu = document.getElementById('tagsFilterMenu');
    if (!menu) return;

    try {
      const response = await fetch('/api/tags');
      const data = await response.json();

      if (data.success) {
        allFilterTags = data.tags;
        renderTagFilterMenu();
      }
    } catch (e) {
      console.error('Error loading tag filter:', e);
    }
  }

  function renderTagFilterMenu() {
    const menu = document.getElementById('tagsFilterMenu');
    if (!menu) return;

    if (allFilterTags.length === 0) {
      menu.innerHTML = '<div style="padding: 0.75rem; color: var(--text-muted); text-align: center;">No tags</div>';
      return;
    }

    menu.innerHTML = allFilterTags.map(tag => `
      <label class="tags-filter-option">
        <input type="checkbox" value="${tag.id}"
          ${selectedFilterTags.includes(tag.id) ? 'checked' : ''}
          onchange="toggleTagFilter('${tag.id}')">
        <span class="badge-tag badge-tag-sm" style="background: ${tag.color};">${escapeHtml(tag.name)}</span>
      </label>
    `).join('');
  }

  function toggleTagsFilterDropdown() {
    const menu = document.getElementById('tagsFilterMenu');
    menu.classList.toggle('show');
  }

  function toggleTagFilter(tagId) {
    const index = selectedFilterTags.indexOf(tagId);
    if (index >= 0) {
      selectedFilterTags.splice(index, 1);
    } else {
      selectedFilterTags.push(tagId);
    }
    updateTagFilterLabel();
    applyFilters();
  }

  function updateTagFilterLabel() {
    const label = document.getElementById('tagsFilterLabel');
    if (!label) return;

    if (selectedFilterTags.length === 0) {
      label.innerHTML = '<%= __("filters.all") %>';
    } else {
      label.innerHTML = `${selectedFilterTags.length} <span class="selected-count">${selectedFilterTags.length}</span>`;
    }
  }

  function getSelectedFilterTags() {
    return selectedFilterTags;
  }

  function clearTagFilter() {
    selectedFilterTags = [];
    renderTagFilterMenu();
    updateTagFilterLabel();
  }

  // Close dropdown when clicking outside
  document.addEventListener('click', function(e) {
    const dropdown = document.getElementById('tagsFilterDropdown');
    if (dropdown && !dropdown.contains(e.target)) {
      document.getElementById('tagsFilterMenu').classList.remove('show');
    }
  });

  // Initialize tag filter on page load
  document.addEventListener('DOMContentLoaded', initTagFilter);

  // ===== FORM FUNCTIONS =====
  const responsePlaceholders = {
    json: '{"message": "Hello World", "status": "ok"}',
    xml: '<?xml version="1.0" encoding="UTF-8"?>\n<response>\n  <message>Hello World</message>\n  <status>ok</status>\n</response>',
    soap: '<?xml version="1.0" encoding="UTF-8"?>\n<soap:Envelope xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/">\n  <soap:Body>\n    <Response>\n      <Message>Hello World</Message>\n    </Response>\n  </soap:Body>\n</soap:Envelope>',
    html: '<!DOCTYPE html>\n<html>\n<head>\n  <title>Mock Response</title>\n</head>\n<body>\n  <h1>Hello World</h1>\n</body>\n</html>',
    text: 'Hello World',
    page: '<h1>Hello World</h1>\n<p>This is a rendered page.</p>',
    empty: '',
    proxy: '',
    graphql: ''
  };

  function checkRespuesta() {
    const tipoResp = document.getElementById("tiporespuesta").value;
    showElements(['#divtresp', '#divtipo', '#divruta', '#divcodresp', '#divresp', '#divEsperaActiva', '#divMetadata', '#divHeaders', '#divConditions']);
    hideElements(['#divDestino', '#divFile', '#divProxyTimeout', '#divFallbacks', '#divGraphQL']);

    // Nav panel: show conditions/fallbacks/graphql dividers based on type
    document.getElementById('navDividerConditions').style.display = '';
    document.getElementById('routeNavConditions').style.display = '';
    document.getElementById('navDividerFallbacks').style.display = 'none';
    document.getElementById('routeNavFallbacks').style.display = 'none';
    document.getElementById('navDividerGraphQL').style.display = 'none';
    document.getElementById('routeNavGraphQL').style.display = 'none';

    if (tipoResp === 'proxy') {
      // For proxy: hide response fields, metadata, headers, conditions (those are per-fallback)
      hideElements(['#divtipo', '#divcodresp', '#divEsperaActiva', '#divresp', '#divFile', '#divMetadata', '#divHeaders', '#divConditions']);
      showElements(['#divDestino', '#divProxyTimeout', '#divFallbacks']);
      document.getElementById('navDividerConditions').style.display = 'none';
      document.getElementById('routeNavConditions').style.display = 'none';
      document.getElementById('navDividerFallbacks').style.display = '';
      document.getElementById('routeNavFallbacks').style.display = '';
    } else if (tipoResp === 'graphql') {
      // For graphql: hide response textarea, code, wait, conditions; show graphql operations
      hideElements(['#divcodresp', '#divresp', '#divFile', '#divEsperaActiva', '#divConditions']);
      showElements(['#divGraphQL']);
      // Auto-set POST method and code 200
      document.getElementById('tipoSelect').value = '1'; // POST
      document.getElementById('crespuestaInput').value = '200';
      updateCodeDescription();
      // Nav panel: hide conditions, show graphql
      document.getElementById('navDividerConditions').style.display = 'none';
      document.getElementById('routeNavConditions').style.display = 'none';
      document.getElementById('navDividerGraphQL').style.display = '';
      document.getElementById('routeNavGraphQL').style.display = '';
      // Auto-expand graphql section
      const gqlBody = document.getElementById('graphqlCollapsibleBody');
      if (gqlBody) gqlBody.style.display = 'block';
    } else if (tipoResp === 'file') {
      hideElements(['#divresp']);
      showElements(['#divFile']);
    } else if (tipoResp === 'empty') {
      hideElements(['#divresp', '#divFile']);
    }

    // Actualizar placeholder según tipo
    const textarea = document.getElementById('respuesta');
    if (textarea) {
      textarea.placeholder = responsePlaceholders[tipoResp] || '';
    }

    // Mostrar/ocultar botón formatear
    const formatBtn = document.getElementById('btnFormatJson');
    if (formatBtn) {
      const canFormat = ['json', 'xml', 'soap', 'html'].includes(tipoResp);
      formatBtn.style.display = canFormat ? '' : 'none';
    }
  }

  function formatResponseJson() {
    const textarea = document.getElementById('respuesta');
    const tipoResp = document.getElementById('tiporespuesta').value;

    if (!textarea || !textarea.value.trim()) return;

    try {
      if (tipoResp === 'json') {
        const parsed = JSON.parse(textarea.value);
        textarea.value = JSON.stringify(parsed, null, 2);
      } else if (tipoResp === 'xml' || tipoResp === 'soap') {
        textarea.value = formatXml(textarea.value);
      } else if (tipoResp === 'html') {
        textarea.value = formatHtml(textarea.value);
      }
    } catch (e) {
      showToast(`${t('responseTypes.' + tipoResp) || tipoResp.toUpperCase()} ${t('validation.' + tipoResp + 'Invalid')}: ${e.message}`, 'error');
    }
  }

  function formatRequestBodyJson() {
    const textarea = document.getElementById('requestBodyExample');
    if (!textarea || !textarea.value.trim()) return;

    try {
      const parsed = JSON.parse(textarea.value);
      textarea.value = JSON.stringify(parsed, null, 2);
    } catch (e) {
      showToast(`JSON ${t('validation.jsonInvalid')}: ${e.message}`, 'error');
    }
  }

  // Usar httpCodes de las traducciones
  const httpCodes = t('httpCodes') || {};

  function updateCodeDescription() {
    const code = document.getElementById("crespuestaInput").value;
    document.getElementById("codeDescription").textContent = httpCodes[code] || 'Custom';
  }

  // ===== ORDER FUNCTIONS =====
  async function normalizeOrder() {
    if (!confirm(t('confirm.normalizeOrder'))) {
      return;
    }

    try {
      const response = await fetch('/api/normalize-order', { method: 'POST' });
      const data = await response.json();
      if (data.success) {
        tabla.ajax.reload(null, false);
        console.log(`Normalizado: ${data.rutas} rutas, ${data.proxies} proxies`);
      } else {
        showToast(data.error || t('errors.normalizing'), 'error');
      }
    } catch (e) {
      console.error(t('errors.normalizing') + ':', e);
    }
  }

  async function moveUp(id) {
    try {
      const response = await fetch(`/api/move-up/${id}`, { method: 'PUT' });
      const data = await response.json();
      if (data.success) {
        tabla.ajax.reload(null, false);
      }
    } catch (e) {
      console.error('Error moviendo ruta:', e);
    }
  }

  async function moveDown(id) {
    try {
      const response = await fetch(`/api/move-down/${id}`, { method: 'PUT' });
      const data = await response.json();
      if (data.success) {
        tabla.ajax.reload(null, false);
      }
    } catch (e) {
      console.error('Error moviendo ruta:', e);
    }
  }

  async function updateOrden(id, orden) {
    const ordenNum = parseInt(orden);
    if (isNaN(ordenNum) || ordenNum < 1) {
      showToast(t('validation.orderPositive'), 'warning');
      tabla.ajax.reload(null, false);
      return;
    }

    try {
      const response = await fetch(`/api/update-order/${id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ orden: ordenNum })
      });
      const data = await response.json();
      if (data.success) {
        tabla.ajax.reload(null, false);
      } else {
        showToast(data.error || t('errors.updatingOrder'), 'error');
      }
    } catch (e) {
      console.error(t('errors.updatingOrder') + ':', e);
    }
  }

  function toggleRegexMode() {
    const isRegex = document.getElementById("isRegex").checked;
    document.getElementById("divRegexValidator").style.display = isRegex ? "block" : "none";
    if (isRegex) validateRegexIfEnabled();
    else document.getElementById("regexResult").innerHTML = "";
  }

  function validateRegexIfEnabled() {
    if (document.getElementById("isRegex").checked) testRegex();
  }

  async function testRegex() {
    const regex = document.getElementById("ruta").value;
    const testUrl = document.getElementById("regexTestUrl").value;
    const resultDiv = document.getElementById("regexResult");

    if (!regex) {
      resultDiv.innerHTML = `<span style="color: var(--text-muted);">${t('validation.enterRegex')}</span>`;
      return;
    }

    try {
      const response = await fetch('/api/validateRegex', {
        method: 'POST',
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ regex, testUrl })
      });
      const data = await response.json();

      if (data.valid) {
        let html = `<span class="badge-modern" style="background: var(--success); color: white;">${t('validation.regexValid')}</span>`;
        if (testUrl) {
          html += data.matches
            ? ` <span class="badge-modern" style="background: var(--info); color: white;">${t('validation.urlMatches')}</span>`
            : ` <span class="badge-modern" style="background: var(--warning); color: white;">${t('validation.urlNoMatch')}</span>`;
        }
        resultDiv.innerHTML = html;
      } else {
        resultDiv.innerHTML = `<span class="badge-modern" style="background: var(--danger); color: white;">${t('validation.regexInvalid')}</span> <small style="color: var(--danger);">${data.error}</small>`;
      }
    } catch (e) {
      resultDiv.innerHTML = `<span class="badge-modern" style="background: var(--danger); color: white;">${t('validation.errorValidating')}</span>`;
    }
  }

  // ===== XML/SOAP UTILITIES =====
  function validateXml(xmlString) {
    const parser = new DOMParser();
    const doc = parser.parseFromString(xmlString, 'application/xml');
    const parseError = doc.querySelector('parsererror');
    if (parseError) {
      return { valid: false, error: parseError.textContent };
    }
    return { valid: true, doc };
  }

  function formatXml(xmlString, indent = 2) {
    const result = validateXml(xmlString);
    if (!result.valid) {
      throw new Error(result.error);
    }

    // Serializar y formatear
    const serializer = new XMLSerializer();
    let xml = serializer.serializeToString(result.doc);

    // Formateo manual con indentación
    const PADDING = ' '.repeat(indent);
    let formatted = '';
    let pad = 0;

    xml = xml.replace(/(>)(<)(\/*)/g, '$1\n$2$3');
    xml.split('\n').forEach(node => {
      let indentLevel = 0;
      if (node.match(/.+<\/\w[^>]*>$/)) {
        indentLevel = 0;
      } else if (node.match(/^<\/\w/) && pad > 0) {
        pad -= 1;
      } else if (node.match(/^<\w[^>]*[^\/]>.*$/)) {
        indentLevel = 1;
      } else {
        indentLevel = 0;
      }
      formatted += PADDING.repeat(pad) + node + '\n';
      pad += indentLevel;
    });

    return formatted.trim();
  }

  function formatHtml(htmlString) {
    // Validar que sea HTML básico
    const parser = new DOMParser();
    const doc = parser.parseFromString(htmlString, 'text/html');

    // Si el parseador genera errores significativos, lanzar error
    const body = doc.body;
    if (!body || (body.children.length === 0 && !body.textContent.trim())) {
      throw new Error('HTML vacío o inválido');
    }

    // Formateo manual con indentación
    const PADDING = '  ';
    let formatted = '';
    let pad = 0;

    // Normalizar y dividir por tags
    let html = htmlString.trim();
    html = html.replace(/(>)\s*(<)/g, '$1\n$2');

    const lines = html.split('\n');
    lines.forEach(line => {
      line = line.trim();
      if (!line) return;

      // Tag de cierre
      if (line.match(/^<\/\w/)) {
        pad = Math.max(0, pad - 1);
      }

      formatted += PADDING.repeat(pad) + line + '\n';

      // Tag de apertura (no auto-cerrado y no cierre)
      if (line.match(/^<\w[^>]*[^\/]>$/) && !line.match(/^<(br|hr|img|input|meta|link|area|base|col|embed|param|source|track|wbr)/i)) {
        pad += 1;
      }
    });

    return formatted.trim();
  }

  // ===== HEADERS =====
  let headerCounter = 0;

  function addHeaderRow(name = '', value = '', action = 'set') {
    headerCounter++;
    const container = document.getElementById('headersContainer');
    document.getElementById('noHeadersMsg').style.display = 'none';

    const row = document.createElement('div');
    row.className = 'd-flex gap-2 mb-2 align-items-center';
    row.id = `header-row-${headerCounter}`;
    row.innerHTML = `
      <select class="form-control-modern form-select-modern" style="width: 100px;" id="header-action-${headerCounter}">
        <option value="set" ${action === 'set' ? 'selected' : ''}>Set</option>
        <option value="remove" ${action === 'remove' ? 'selected' : ''}>Remove</option>
      </select>
      <input type="text" class="form-control-modern" placeholder="Header name" id="header-name-${headerCounter}" value="${escapeHtml(name)}" style="width: 180px;">
      <input type="text" class="form-control-modern" placeholder="Header value" id="header-value-${headerCounter}" value="${escapeHtml(value)}" style="flex: 1;">
      <button class="btn-icon btn-icon-danger" type="button" onclick="removeHeaderRow(${headerCounter})">
        <i class="fa fa-trash"></i>
      </button>
    `;
    container.appendChild(row);
    updateHeaderValueVisibility(headerCounter);

    document.getElementById(`header-action-${headerCounter}`).addEventListener('change', function() {
      updateHeaderValueVisibility(this.id.replace('header-action-', ''));
    });
  }

  function updateHeaderValueVisibility(rowId) {
    const action = document.getElementById(`header-action-${rowId}`).value;
    const valueInput = document.getElementById(`header-value-${rowId}`);
    valueInput.style.display = action === 'remove' ? 'none' : 'block';
    if (action === 'remove') valueInput.value = '';
  }

  function removeHeaderRow(id) {
    const row = document.getElementById(`header-row-${id}`);
    if (row) row.remove();

    const container = document.getElementById('headersContainer');
    if (container.children.length === 0) {
      document.getElementById('noHeadersMsg').style.display = 'block';
    }
  }

  function getCustomHeaders() {
    const headers = [];
    const rows = document.getElementById('headersContainer').querySelectorAll('[id^="header-row-"]');
    rows.forEach(row => {
      const id = row.id.replace('header-row-', '');
      const action = document.getElementById(`header-action-${id}`).value;
      const name = document.getElementById(`header-name-${id}`).value.trim();
      const value = document.getElementById(`header-value-${id}`).value;
      if (name) headers.push({ action, name, value });
    });
    return headers.length > 0 ? headers : null;
  }

  function setCustomHeaders(headers) {
    clearHeaders();
    if (headers && Array.isArray(headers)) {
      headers.forEach(h => addHeaderRow(h.name, h.value, h.action));
    }
  }

  function clearHeaders() {
    document.getElementById('headersContainer').innerHTML = '';
    document.getElementById('noHeadersMsg').style.display = 'block';
    headerCounter = 0;
  }

  // ===== TAGS MODULE =====
  const TagsModule = {
    availableTags: [],
    selectedTags: [],
    predefinedColors: [
      '#6366f1', '#8b5cf6', '#ec4899', '#ef4444', '#f97316', '#f59e0b',
      '#10b981', '#14b8a6', '#06b6d4', '#3b82f6', '#374151', '#1e293b'
    ],

    async init() {
      await this.loadTags();
      this.renderColorPalette();
    },

    async loadTags() {
      try {
        const response = await fetch('/api/tags');
        const data = await response.json();
        if (data.success) {
          this.availableTags = data.tags;
          this.renderTagSelector();
        }
      } catch (e) {
        console.error('Error loading tags:', e);
      }
    },

    renderTagSelector() {
      const container = document.getElementById('tagsSelector');
      const noTagsMsg = document.getElementById('noTagsMsg');
      if (!container) return;

      // Only show selected tags with remove buttons
      if (this.selectedTags.length === 0) {
        container.innerHTML = '';
        if (noTagsMsg) noTagsMsg.style.display = 'block';
        return;
      }

      if (noTagsMsg) noTagsMsg.style.display = 'none';

      let html = '<div class="selected-tags-display">';
      this.selectedTags.forEach(tag => {
        html += `<span class="badge-tag badge-tag-removable" style="background: ${tag.color};">
          ${this.escapeHtml(tag.name)}
          <button type="button" class="tag-remove" onclick="TagsModule.removeTag('${tag.id}')" title="Eliminar">
            <i class="fa fa-times"></i>
          </button>
        </span>`;
      });
      html += '</div>';

      container.innerHTML = html;
    },

    removeTag(tagId) {
      const index = this.selectedTags.findIndex(t => t.id === tagId);
      if (index >= 0) {
        this.selectedTags.splice(index, 1);
        this.renderTagSelector();
      }
    },

    addTag(tagId) {
      const tag = this.availableTags.find(t => t.id === tagId);
      if (!tag) return;

      // Don't add if already selected
      if (this.selectedTags.find(t => t.id === tagId)) {
        this.closeCreator();
        return;
      }

      this.selectedTags.push(tag);
      this.renderTagSelector();
      this.closeCreator();
    },

    setTags(tags) {
      this.selectedTags = tags || [];
      this.renderTagSelector();
    },

    getTags() {
      return this.selectedTags;
    },

    clear() {
      this.selectedTags = [];
      this.renderTagSelector();
    },

    renderColorPalette() {
      const container = document.getElementById('colorPalette');
      if (!container) return;

      container.innerHTML = this.predefinedColors.map((color, i) => `
        <button type="button" class="color-swatch ${i === 0 ? 'selected' : ''}"
          style="background: ${color};"
          data-color="${color}"
          onclick="TagsModule.selectColor('${color}')">
        </button>
      `).join('');
    },

    selectColor(color) {
      document.querySelectorAll('.color-swatch').forEach(el => el.classList.remove('selected'));
      const swatch = document.querySelector(`.color-swatch[data-color="${color}"]`);
      if (swatch) swatch.classList.add('selected');
      document.getElementById('customTagColor').value = color;
    },

    async createOrAddTag() {
      const name = document.getElementById('newTagName').value.trim();
      const color = document.getElementById('customTagColor').value;

      if (!name) {
        showToast(t('validation.tagNameRequired'), 'warning');
        return;
      }

      // Check if tag already exists (case insensitive)
      const existingTag = this.availableTags.find(t =>
        t.name.toLowerCase() === name.toLowerCase()
      );

      if (existingTag) {
        // Tag exists, just add it to selected
        if (!this.selectedTags.find(t => t.id === existingTag.id)) {
          this.selectedTags.push(existingTag);
          this.renderTagSelector();
        }
        this.closeCreator();
        return;
      }

      // Create new tag
      try {
        const response = await fetch('/api/tags', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, color })
        });
        const data = await response.json();

        if (data.success) {
          this.availableTags.push(data.tag);
          this.selectedTags.push(data.tag);
          this.renderTagSelector();
          this.closeCreator();
          initTagFilter();
        } else {
          showToast(data.error || t('errors.creatingTag'), 'error');
        }
      } catch (e) {
        showToast(t('errors.creatingTag'), 'error');
      }
    },

    openCreator() {
      document.getElementById('newTagName').value = '';
      document.getElementById('customTagColor').value = '#6366f1';
      this.selectColor('#6366f1');
      this.renderTagSuggestions();
      document.getElementById('tagCreatorPopup').style.display = 'flex';
    },

    closeCreator() {
      document.getElementById('tagCreatorPopup').style.display = 'none';
    },

    renderTagSuggestions(filter = '') {
      const container = document.getElementById('tagSuggestions');
      if (!container) return;

      // Filter tags that are not already selected
      let availableToAdd = this.availableTags.filter(tag =>
        !this.selectedTags.find(t => t.id === tag.id)
      );

      // Apply text filter if provided
      if (filter) {
        const lowerFilter = filter.toLowerCase();
        availableToAdd = availableToAdd.filter(tag =>
          tag.name.toLowerCase().includes(lowerFilter)
        );
      }

      if (availableToAdd.length === 0) {
        container.innerHTML = filter
          ? `<div class="tag-suggestions-empty">${t('form.noMatchingTags')}</div>`
          : '';
        return;
      }

      container.innerHTML = availableToAdd.map(tag => `
        <button type="button" class="tag-suggestion" style="--tag-color: ${tag.color};"
          onclick="TagsModule.addTag('${tag.id}')">
          <span class="badge-tag" style="background: ${tag.color};">${this.escapeHtml(tag.name)}</span>
        </button>
      `).join('');
    },

    filterSuggestions() {
      const input = document.getElementById('newTagName');
      this.renderTagSuggestions(input.value.trim());
    },

    escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
  };

  function toggleTagsSection() {
    const body = document.querySelector('#divTags .collapsible-body');
    body.style.display = body.style.display === 'none' ? 'block' : 'none';
  }

  function toggleMetadataSection() {
    const body = document.querySelector('#divMetadata .collapsible-body');
    body.style.display = body.style.display === 'none' ? 'block' : 'none';
  }

  // Initialize TagsModule on page load
  document.addEventListener('DOMContentLoaded', () => TagsModule.init());

  // ===== ROUTE NAVIGATION PANEL =====
  const RouteNavigation = {
    navContainer: null,
    navFallbacksContainer: null,
    contentPanel: null,
    navSortable: null,
    navFallbacksSortable: null,

    init() {
      this.navContainer = document.getElementById('routeNavConditions');
      this.navFallbacksContainer = document.getElementById('routeNavFallbacks');
      this.contentPanel = document.getElementById('routeContentPanel');

      // Limpiar items de navegación existentes
      if (this.navContainer) {
        this.navContainer.innerHTML = '';
      }
      if (this.navFallbacksContainer) {
        this.navFallbacksContainer.innerHTML = '';
      }

      // Ocultar sección de fallbacks por defecto
      this.hideFallbacksSection();

      // Inicializar SortableJS para el árbol de navegación
      if (this.navContainer && typeof Sortable !== 'undefined' && !this.navSortable) {
        this.navSortable = new Sortable(this.navContainer, {
          handle: '.nav-drag-handle',
          animation: 150,
          ghostClass: 'sortable-ghost',
          onEnd: () => this.syncOrderFromNav()
        });
      }
    },

    // ===== CONDITIONAL RESPONSES =====
    addNavItem(conditionId, name, isActive = true) {
      if (!this.navContainer) {
        this.navContainer = document.getElementById('routeNavConditions');
      }
      if (!this.navContainer) return;

      const item = document.createElement('div');
      item.className = 'route-nav-item';
      item.id = `nav-condition-${conditionId}`;
      item.dataset.conditionId = conditionId;
      item.dataset.target = `condition-${conditionId}`;

      item.innerHTML = `
        <span class="nav-drag-handle"><i class="fa fa-grip-vertical"></i></span>
        <label class="switch-mini" onclick="event.stopPropagation()">
          <input type="checkbox" id="nav-switch-condition-${conditionId}" ${isActive ? 'checked' : ''}>
          <span class="slider-mini"></span>
        </label>
        <span class="nav-item-name">${this.escapeHtml(name) || t('form.condition') + ' ' + conditionId}</span>
      `;

      // Click para navegar (excepto en drag handle y switch)
      item.addEventListener('click', (e) => {
        if (!e.target.closest('.nav-drag-handle') && !e.target.closest('.switch-mini')) {
          this.navigateTo(`condition-${conditionId}`);
        }
      });

      // Sincronizar switch del árbol con el de la tarjeta
      const navSwitch = item.querySelector(`#nav-switch-condition-${conditionId}`);
      if (navSwitch) {
        navSwitch.addEventListener('change', (e) => {
          const cardSwitch = document.getElementById(`condition-active-${conditionId}`);
          if (cardSwitch) {
            cardSwitch.checked = e.target.checked;
            cardSwitch.dispatchEvent(new Event('change'));
          }
        });
      }

      this.navContainer.appendChild(item);
    },

    updateNavItemName(conditionId, name) {
      const navItem = document.getElementById(`nav-condition-${conditionId}`);
      if (navItem) {
        const nameSpan = navItem.querySelector('.nav-item-name');
        if (nameSpan) {
          nameSpan.textContent = name || t('form.condition') + ' ' + conditionId;
        }
      }
    },

    updateNavItemStatus(conditionId, isActive) {
      const navSwitch = document.getElementById(`nav-switch-condition-${conditionId}`);
      if (navSwitch) {
        navSwitch.checked = isActive;
      }
    },

    removeNavItem(conditionId) {
      const navItem = document.getElementById(`nav-condition-${conditionId}`);
      if (navItem) navItem.remove();
    },

    clearNavItems() {
      if (this.navContainer) {
        this.navContainer.innerHTML = '';
      }
    },

    // ===== FALLBACKS =====
    showFallbacksSection() {
      const divider = document.getElementById('navDividerFallbacks');
      const container = document.getElementById('routeNavFallbacks');
      if (divider) divider.style.display = '';
      if (container) container.style.display = '';
    },

    hideFallbacksSection() {
      const divider = document.getElementById('navDividerFallbacks');
      const container = document.getElementById('routeNavFallbacks');
      if (divider) divider.style.display = 'none';
      if (container) container.style.display = 'none';
    },

    addFallbackNavItem(fallbackId, name, isActive = true) {
      if (!this.navFallbacksContainer) {
        this.navFallbacksContainer = document.getElementById('routeNavFallbacks');
      }
      if (!this.navFallbacksContainer) return;

      this.showFallbacksSection();

      // Wrapper para el fallback y sus criterios (permite reordenar juntos)
      const wrapper = document.createElement('div');
      wrapper.className = 'route-nav-fallback-wrapper';
      wrapper.id = `nav-fallback-wrapper-${fallbackId}`;
      wrapper.dataset.fallbackId = fallbackId;

      const item = document.createElement('div');
      item.className = 'route-nav-item route-nav-fallback';
      item.id = `nav-fallback-${fallbackId}`;
      item.dataset.fallbackId = fallbackId;
      item.dataset.target = `fallback-${fallbackId}`;

      item.innerHTML = `
        <span class="nav-drag-handle"><i class="fa fa-grip-vertical"></i></span>
        <label class="switch-mini" onclick="event.stopPropagation()">
          <input type="checkbox" id="nav-switch-fallback-${fallbackId}" ${isActive ? 'checked' : ''}>
          <span class="slider-mini"></span>
        </label>
        <span class="nav-item-name">${this.escapeHtml(name) || 'Fallback ' + fallbackId}</span>
      `;

      // Click para navegar (excepto en drag handle y switch)
      item.addEventListener('click', (e) => {
        if (!e.target.closest('.nav-drag-handle') && !e.target.closest('.switch-mini')) {
          this.navigateTo(`fallback-${fallbackId}`);
        }
      });

      // Sincronizar switch del árbol con el de la tarjeta
      const navSwitch = item.querySelector(`#nav-switch-fallback-${fallbackId}`);
      if (navSwitch) {
        navSwitch.addEventListener('change', (e) => {
          const cardSwitch = document.getElementById(`fallback-active-${fallbackId}`);
          if (cardSwitch) {
            cardSwitch.checked = e.target.checked;
            cardSwitch.dispatchEvent(new Event('change'));
          }
        });
      }

      // Contenedor para los criterios de este fallback
      const criteriaContainer = document.createElement('div');
      criteriaContainer.className = 'route-nav-fallback-criteria';
      criteriaContainer.id = `nav-fallback-criteria-${fallbackId}`;

      wrapper.appendChild(item);
      wrapper.appendChild(criteriaContainer);
      this.navFallbacksContainer.appendChild(wrapper);

      // Inicializar sortable para el contenedor de fallbacks (solo una vez)
      if (typeof Sortable !== 'undefined' && !this.navFallbacksSortable) {
        this.navFallbacksSortable = new Sortable(this.navFallbacksContainer, {
          handle: '.route-nav-fallback .nav-drag-handle',
          animation: 150,
          ghostClass: 'sortable-ghost',
          onEnd: () => this.syncFallbacksOrderFromNav()
        });
      }

      // Inicializar sortable para los criterios de este fallback
      if (typeof Sortable !== 'undefined') {
        new Sortable(criteriaContainer, {
          handle: '.nav-drag-handle',
          animation: 150,
          ghostClass: 'sortable-ghost',
          onEnd: () => this.syncFallbackConditionsOrder(fallbackId)
        });
      }
    },

    updateFallbackNavItemName(fallbackId, name) {
      const navItem = document.getElementById(`nav-fallback-${fallbackId}`);
      if (navItem) {
        const nameSpan = navItem.querySelector('.nav-item-name');
        if (nameSpan) {
          nameSpan.textContent = name || 'Fallback ' + fallbackId;
        }
      }
    },

    updateFallbackNavItemStatus(fallbackId, isActive) {
      const navSwitch = document.getElementById(`nav-switch-fallback-${fallbackId}`);
      if (navSwitch) {
        navSwitch.checked = isActive;
      }
    },

    removeFallbackNavItem(fallbackId) {
      // Remover el wrapper completo (contiene el item y sus criterios)
      const wrapper = document.getElementById(`nav-fallback-wrapper-${fallbackId}`);
      if (wrapper) wrapper.remove();

      // Ocultar sección si no hay más fallbacks
      if (this.navFallbacksContainer && this.navFallbacksContainer.children.length === 0) {
        this.hideFallbacksSection();
      }
    },

    clearFallbackNavItems() {
      if (this.navFallbacksContainer) {
        this.navFallbacksContainer.innerHTML = '';
      }
      this.hideFallbacksSection();
    },

    // ===== FALLBACK CONDITIONS (CRITERIA) =====
    addFallbackConditionNavItem(fallbackId, condId, name, order, isActive = true) {
      const criteriaContainer = document.getElementById(`nav-fallback-criteria-${fallbackId}`);
      if (!criteriaContainer) return;

      const displayName = name || t('form.criteria') + ' ' + order;

      const item = document.createElement('div');
      item.className = 'route-nav-item route-nav-criteria';
      item.id = `nav-fc-${fallbackId}-${condId}`;
      item.dataset.fallbackId = fallbackId;
      item.dataset.condId = condId;
      item.dataset.target = `fc-${fallbackId}-${condId}`;

      item.innerHTML = `
        <span class="nav-drag-handle"><i class="fa fa-grip-vertical"></i></span>
        <label class="switch-mini" onclick="event.stopPropagation()">
          <input type="checkbox" id="nav-switch-fc-${fallbackId}-${condId}" ${isActive ? 'checked' : ''}>
          <span class="slider-mini"></span>
        </label>
        <span class="nav-item-name">${this.escapeHtml(displayName)}</span>
      `;

      // Click para navegar (excepto en drag handle y switch)
      item.addEventListener('click', (e) => {
        if (!e.target.closest('.nav-drag-handle') && !e.target.closest('.switch-mini')) {
          this.navigateTo(`fc-${fallbackId}-${condId}`, fallbackId);
        }
      });

      // Sincronizar switch del árbol con el de la tarjeta
      const navSwitch = item.querySelector(`#nav-switch-fc-${fallbackId}-${condId}`);
      if (navSwitch) {
        navSwitch.addEventListener('change', (e) => {
          const cardSwitch = document.getElementById(`fc-active-${fallbackId}-${condId}`);
          if (cardSwitch) {
            cardSwitch.checked = e.target.checked;
            cardSwitch.dispatchEvent(new Event('change'));
          }
        });
      }

      criteriaContainer.appendChild(item);
    },

    updateFallbackConditionNavItemName(fallbackId, condId, name, order) {
      const navItem = document.getElementById(`nav-fc-${fallbackId}-${condId}`);
      if (navItem) {
        const nameSpan = navItem.querySelector('.nav-item-name');
        if (nameSpan) {
          nameSpan.textContent = name || t('form.criteria') + ' ' + order;
        }
      }
    },

    updateFallbackConditionNavItemStatus(fallbackId, condId, isActive) {
      const navSwitch = document.getElementById(`nav-switch-fc-${fallbackId}-${condId}`);
      if (navSwitch) {
        navSwitch.checked = isActive;
      }
    },

    // Sincronizar orden de criterios desde el árbol
    syncFallbackConditionsOrder(fallbackId) {
      const criteriaNavContainer = document.getElementById(`nav-fallback-criteria-${fallbackId}`);
      const criteriaContainer = document.getElementById(`fallback-conditions-container-${fallbackId}`);
      if (!criteriaNavContainer || !criteriaContainer) return;

      const navItems = Array.from(criteriaNavContainer.querySelectorAll('.route-nav-criteria'));

      navItems.forEach((navItem, index) => {
        const condId = navItem.dataset.condId;
        const card = document.getElementById(`fc-${fallbackId}-${condId}`);
        if (card) {
          card.dataset.order = index + 1;
          criteriaContainer.appendChild(card);
          // Actualizar nombre por defecto si no tiene nombre personalizado
          const nameInput = document.getElementById(`fc-name-${fallbackId}-${condId}`);
          if (nameInput && !nameInput.value.trim()) {
            this.updateFallbackConditionNavItemName(fallbackId, condId, '', index + 1);
          }
        }
      });
    },

    // Sincronizar orden de fallbacks desde el árbol
    syncFallbacksOrderFromNav() {
      if (!this.navFallbacksContainer) return;

      const fallbacksContainer = document.getElementById('fallbacksContainer');
      if (!fallbacksContainer) return;

      const navWrappers = Array.from(this.navFallbacksContainer.querySelectorAll('.route-nav-fallback-wrapper'));

      navWrappers.forEach((wrapper, index) => {
        const fallbackId = wrapper.dataset.fallbackId;
        const fallbackCard = document.getElementById(`fallback-${fallbackId}`);
        if (fallbackCard) {
          fallbackCard.dataset.order = index + 1;
          fallbacksContainer.appendChild(fallbackCard);
        }
      });
    },

    removeFallbackConditionNavItem(fallbackId, condId) {
      const navItem = document.getElementById(`nav-fc-${fallbackId}-${condId}`);
      if (navItem) navItem.remove();
    },

    clearFallbackConditionNavItems(fallbackId) {
      const criteriaContainer = document.getElementById(`nav-fallback-criteria-${fallbackId}`);
      if (criteriaContainer) {
        criteriaContainer.innerHTML = '';
      }
    },

    // ===== NAVIGATION =====
    navigateTo(targetId, fallbackId = null) {
      const target = document.getElementById(targetId);
      if (!target) return;

      if (!this.contentPanel) {
        this.contentPanel = document.getElementById('routeContentPanel');
      }
      if (!this.contentPanel) return;

      // Actualizar item activo en navegación
      document.querySelectorAll('.route-nav-item').forEach(item => {
        item.classList.remove('active');
      });

      const navItem = document.querySelector(`[data-target="${targetId}"]`);
      if (navItem) navItem.classList.add('active');

      // Si es una condition-card colapsada, expandirla primero
      if (targetId.startsWith('condition-')) {
        const condId = targetId.replace('condition-', '');
        expandCondition(condId);
        // Asegurar que la sección de condiciones esté visible
        const conditionsBody = document.querySelector('#divConditions .collapsible-body');
        if (conditionsBody && conditionsBody.style.display === 'none') {
          conditionsBody.style.display = 'block';
        }
      }

      // Si es un fallback, expandirlo
      if (targetId.startsWith('fallback-') && !targetId.startsWith('fallback-condition')) {
        const fbId = targetId.replace('fallback-', '');
        expandFallback(fbId);
        // Asegurar que la sección de fallbacks esté visible
        const fallbacksBody = document.querySelector('#divFallbacks .collapsible-body');
        if (fallbacksBody && fallbacksBody.style.display === 'none') {
          fallbacksBody.style.display = 'block';
        }
      }

      // Si es un criterio de fallback (fc-X-Y), expandir el fallback y el criterio
      if (targetId.startsWith('fc-')) {
        const parts = targetId.replace('fc-', '').split('-');
        const fbId = parts[0];
        const condId = parts[1];
        // Expandir el fallback padre
        expandFallback(fbId);
        // Expandir el criterio
        expandFallbackCondition(fbId, condId);
        // Asegurar que la sección de fallbacks esté visible
        const fallbacksBody = document.querySelector('#divFallbacks .collapsible-body');
        if (fallbacksBody && fallbacksBody.style.display === 'none') {
          fallbacksBody.style.display = 'block';
        }
        // Asegurar que la sección de conditions del fallback esté visible
        const fcBody = document.getElementById(`fallback-conditions-body-${fbId}`);
        if (fcBody && fcBody.style.display === 'none') {
          fcBody.style.display = 'block';
        }
      }

      // Scroll suave al elemento
      const offsetTop = target.offsetTop - 20;
      this.contentPanel.scrollTo({
        top: offsetTop,
        behavior: 'smooth'
      });

      // Efecto flash
      target.classList.add('flash-highlight');
      setTimeout(() => {
        target.classList.remove('flash-highlight');
      }, 1000);
    },

    syncOrderFromNav() {
      if (!this.navContainer) return;

      const navItems = Array.from(this.navContainer.querySelectorAll('.route-nav-item'));
      const conditionsContainer = document.getElementById('conditionsContainer');

      navItems.forEach((navItem, index) => {
        const conditionId = navItem.dataset.conditionId;
        const conditionCard = document.getElementById(`condition-${conditionId}`);
        if (conditionCard) {
          conditionCard.dataset.order = index + 1;
          conditionsContainer.appendChild(conditionCard);
        }
      });
    },

    // ===== GRAPHQL OPERATIONS =====
    addGraphQLOpNavItem(opId, name, isActive = true) {
      const container = document.getElementById('routeNavGraphQL');
      if (!container) return;

      const item = document.createElement('div');
      item.className = 'route-nav-item';
      item.id = `nav-graphql-op-${opId}`;
      item.dataset.graphqlOpId = opId;
      item.dataset.target = `graphql-op-${opId}`;

      item.innerHTML = `
        <label class="switch-mini" onclick="event.stopPropagation()">
          <input type="checkbox" id="nav-switch-graphql-op-${opId}" ${isActive ? 'checked' : ''}>
          <span class="slider-mini"></span>
        </label>
        <span class="nav-item-name">${this.escapeHtml(name) || 'Operation ' + opId}</span>
      `;

      item.addEventListener('click', (e) => {
        if (!e.target.closest('.switch-mini')) {
          this.navigateTo(`graphql-op-${opId}`);
        }
      });

      const navSwitch = item.querySelector(`#nav-switch-graphql-op-${opId}`);
      if (navSwitch) {
        navSwitch.addEventListener('change', (e) => {
          const cardSwitch = document.getElementById(`graphql-op-active-${opId}`);
          if (cardSwitch) {
            cardSwitch.checked = e.target.checked;
          }
        });
      }

      container.appendChild(item);
    },

    updateGraphQLOpNavItemName(opId, name) {
      const navItem = document.getElementById(`nav-graphql-op-${opId}`);
      if (navItem) {
        const nameSpan = navItem.querySelector('.nav-item-name');
        if (nameSpan) {
          nameSpan.textContent = name || 'Operation ' + opId;
        }
      }
    },

    removeGraphQLOpNavItem(opId) {
      const navItem = document.getElementById(`nav-graphql-op-${opId}`);
      if (navItem) navItem.remove();
    },

    clearGraphQLOpNavItems() {
      const container = document.getElementById('routeNavGraphQL');
      if (container) container.innerHTML = '';
    },

    escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
  };

  // ===== CONDITION COLLAPSE FUNCTIONS =====
  function toggleConditionCollapse(conditionId) {
    const body = document.getElementById(`condition-body-${conditionId}`);
    const toggleBtn = document.getElementById(`condition-toggle-${conditionId}`);

    if (!body) return;

    const isCollapsed = body.classList.contains('collapsed');

    if (isCollapsed) {
      expandCondition(conditionId);
    } else {
      collapseCondition(conditionId);
    }
  }

  function expandCondition(conditionId) {
    const body = document.getElementById(`condition-body-${conditionId}`);
    const toggleBtn = document.getElementById(`condition-toggle-${conditionId}`);

    if (body) body.classList.remove('collapsed');
    if (toggleBtn) toggleBtn.classList.remove('collapsed');
  }

  function collapseCondition(conditionId) {
    const body = document.getElementById(`condition-body-${conditionId}`);
    const toggleBtn = document.getElementById(`condition-toggle-${conditionId}`);

    if (body) body.classList.add('collapsed');
    if (toggleBtn) toggleBtn.classList.add('collapsed');
  }

  // ===== CONDITIONAL RESPONSES =====
  let conditionCounter = 0;

  function toggleConditionsSection() {
    const body = document.querySelector('#divConditions .collapsible-body');
    body.style.display = body.style.display === 'none' ? 'block' : 'none';
  }

  function showCriteriaHelp() {
    // Quitar foco del elemento actual para evitar warning de aria-hidden
    if (document.activeElement) {
      document.activeElement.blur();
    }
    const modal = new bootstrap.Modal(document.getElementById('criteriaHelpModal'));
    modal.show();
  }

  function addConditionRow(data = {}) {
    conditionCounter++;
    const container = document.getElementById('conditionsContainer');
    document.getElementById('noConditionsMsg').style.display = 'none';

    const card = document.createElement('div');
    card.className = 'condition-card';
    card.id = `condition-${conditionCounter}`;
    card.dataset.order = conditionCounter;

    card.innerHTML = `
      <div class="condition-header">
        <div class="condition-drag-handle" title="${t('actions.moveUp')}/${t('actions.moveDown')}">
          <i class="fa fa-bars"></i>
        </div>
        <button class="btn-condition-toggle" type="button" id="condition-toggle-${conditionCounter}"
                onclick="toggleConditionCollapse(${conditionCounter})" title="${t('buttons.toggleCollapse')}">
          <i class="fa fa-chevron-down"></i>
        </button>
        <input type="text" class="form-control-modern condition-name"
               placeholder="${t('form.conditionName')}"
               id="condition-name-${conditionCounter}"
               value="${escapeHtml(data.nombre || '')}">
        <label class="switch-modern" style="margin-left: auto;">
          <input type="checkbox" id="condition-active-${conditionCounter}" ${data.activo !== false ? 'checked' : ''}>
          <span class="slider"></span>
        </label>
        <button class="btn-icon btn-icon-danger" type="button" onclick="removeConditionRow(${conditionCounter})" title="${t('buttons.delete')}">
          <i class="fa fa-trash"></i>
        </button>
      </div>
      <div class="condition-body condition-body-collapsible" id="condition-body-${conditionCounter}">
        <div class="form-group-modern">
          <label class="form-label-modern">${t('form.criteria')} <span style="color: var(--danger);">*</span></label>
          <div class="d-flex gap-2">
            <textarea class="form-control-modern condition-criteria"
                      id="condition-criteria-${conditionCounter}"
                      placeholder="${t('form.placeholder.criteria')}"
                      rows="2">${escapeHtml(data.criteria || '')}</textarea>
            <button class="btn-modern btn-modern-secondary" type="button"
                    onclick="validateConditionCriteria(${conditionCounter})"
                    title="${t('buttons.validate')}" style="align-self: flex-start;">
              <i class="fa fa-check"></i>
            </button>
          </div>
          <div id="condition-validation-${conditionCounter}" class="condition-validation"></div>
        </div>

        <div class="condition-overrides">
          <div class="override-row">
            <div class="form-group-modern" style="flex: 0 0 100px;">
              <label class="form-label-modern">${t('table.code')}</label>
              <input type="text" class="form-control-modern"
                     id="condition-code-${conditionCounter}"
                     placeholder="-"
                     value="${escapeHtml(data.codigo || '')}">
            </div>
            <div class="form-group-modern" style="flex: 0 0 150px;">
              <label class="form-label-modern">${t('table.type')}</label>
              <select class="form-control-modern form-select-modern"
                      id="condition-type-${conditionCounter}">
                <option value="">${t('form.useDefault')}</option>
                <option value="json" ${data.tiporespuesta === 'json' ? 'selected' : ''}>JSON</option>
                <option value="xml" ${data.tiporespuesta === 'xml' ? 'selected' : ''}>XML</option>
                <option value="text" ${data.tiporespuesta === 'text' ? 'selected' : ''}>Text</option>
                <option value="html" ${data.tiporespuesta === 'html' ? 'selected' : ''}>HTML</option>
                <option value="empty" ${data.tiporespuesta === 'empty' ? 'selected' : ''}>Empty</option>
              </select>
            </div>
          </div>

          <div class="form-group-modern">
            <label class="form-label-modern">${t('form.response')}</label>
            <textarea class="form-control-modern"
                      id="condition-response-${conditionCounter}"
                      placeholder="${t('form.placeholder.leaveEmpty')}"
                      rows="3">${escapeHtml(data.respuesta || '')}</textarea>
          </div>

          <!-- Custom Headers for this condition -->
          <div class="condition-headers-section">
            <div class="condition-headers-header" onclick="toggleConditionHeaders(${conditionCounter})">
              <span><i class="fa fa-list-ul"></i> ${t('form.customHeaders')}</span>
              <i class="fa fa-chevron-down condition-headers-chevron" id="condition-headers-chevron-${conditionCounter}"></i>
            </div>
            <div class="condition-headers-body" id="condition-headers-body-${conditionCounter}" style="display: none;">
              <div id="condition-headers-container-${conditionCounter}"></div>
              <div id="condition-no-headers-${conditionCounter}" class="empty-state-mini">
                <small>${t('empty.noHeaders')}</small>
              </div>
              <button type="button" class="btn-modern btn-modern-outline btn-sm" onclick="addConditionHeaderRow(${conditionCounter})">
                <i class="fa fa-plus"></i> ${t('buttons.addHeader')}
              </button>
            </div>
          </div>
        </div>
      </div>
    `;

    container.appendChild(card);

    // Cargar headers si existen
    if (data.customHeaders) {
      let headers = data.customHeaders;
      if (typeof headers === 'string') {
        try { headers = JSON.parse(headers); } catch (e) { headers = []; }
      }
      if (Array.isArray(headers) && headers.length > 0) {
        headers.forEach(h => addConditionHeaderRow(conditionCounter, h.name, h.value, h.action));
        document.getElementById(`condition-headers-body-${conditionCounter}`).style.display = 'block';
        const chevron = document.getElementById(`condition-headers-chevron-${conditionCounter}`);
        if (chevron) chevron.classList.add('rotated');
      }
    }

    // Inicializar sortable si es la primera condición
    if (container.children.length === 1 && typeof Sortable !== 'undefined') {
      new Sortable(container, {
        handle: '.condition-drag-handle',
        animation: 150,
        ghostClass: 'condition-ghost',
        onEnd: function() {
          Array.from(container.children).forEach((el, idx) => {
            el.dataset.order = idx + 1;
          });
        }
      });
    }

    // Agregar al árbol de navegación con estado
    const isActive = data.activo !== false;
    RouteNavigation.addNavItem(conditionCounter, data.nombre || '', isActive);

    // Escuchar cambios en el nombre para actualizar el árbol
    const nameInput = document.getElementById(`condition-name-${conditionCounter}`);
    if (nameInput) {
      nameInput.addEventListener('input', (e) => {
        const condId = e.target.id.replace('condition-name-', '');
        RouteNavigation.updateNavItemName(condId, e.target.value);
      });
    }

    // Escuchar cambios en el estado activo para actualizar el icono
    const activeSwitch = document.getElementById(`condition-active-${conditionCounter}`);
    if (activeSwitch) {
      activeSwitch.addEventListener('change', (e) => {
        const condId = e.target.id.replace('condition-active-', '');
        RouteNavigation.updateNavItemStatus(condId, e.target.checked);
      });
    }
  }

  function removeConditionRow(id) {
    // Eliminar del árbol de navegación
    RouteNavigation.removeNavItem(id);

    const card = document.getElementById(`condition-${id}`);
    if (card) card.remove();

    const container = document.getElementById('conditionsContainer');
    if (container.children.length === 0) {
      document.getElementById('noConditionsMsg').style.display = 'block';
    }
  }

  async function validateConditionCriteria(id) {
    const criteria = document.getElementById(`condition-criteria-${id}`).value;
    const resultDiv = document.getElementById(`condition-validation-${id}`);

    if (!criteria.trim()) {
      resultDiv.innerHTML = `<span class="text-warning"><i class="fa fa-warning"></i> ${t('validation.enterCriteria')}</span>`;
      return;
    }

    try {
      const response = await fetch('/api/validateCriteria', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ criteria })
      });
      const result = await response.json();

      if (result.valid) {
        resultDiv.innerHTML = `<span class="text-success"><i class="fa fa-check"></i> ${t('validation.criteriaValid')}</span>`;
      } else {
        resultDiv.innerHTML = `<span class="text-danger"><i class="fa fa-times"></i> ${result.error}</span>`;
      }
    } catch (e) {
      resultDiv.innerHTML = `<span class="text-danger"><i class="fa fa-times"></i> ${t('validation.errorValidating')}</span>`;
    }
  }

  function getConditions() {
    const conditions = [];
    const container = document.getElementById('conditionsContainer');
    const cards = Array.from(container.querySelectorAll('.condition-card'))
      .sort((a, b) => (parseInt(a.dataset.order) || 0) - (parseInt(b.dataset.order) || 0));

    cards.forEach((card, idx) => {
      const id = card.id.replace('condition-', '');
      const criteria = document.getElementById(`condition-criteria-${id}`).value.trim();

      if (!criteria) return; // Saltar condiciones vacías

      conditions.push({
        orden: idx,
        nombre: document.getElementById(`condition-name-${id}`).value.trim() || null,
        criteria: criteria,
        codigo: document.getElementById(`condition-code-${id}`).value.trim() || null,
        tiporespuesta: document.getElementById(`condition-type-${id}`).value || null,
        respuesta: document.getElementById(`condition-response-${id}`).value || null,
        customHeaders: getConditionHeaders(id),
        activo: document.getElementById(`condition-active-${id}`).checked
      });
    });

    return conditions;
  }

  function setConditions(conditions) {
    clearConditions();
    if (conditions && Array.isArray(conditions)) {
      conditions.forEach(c => addConditionRow(c));
    }
  }

  function clearConditions() {
    document.getElementById('conditionsContainer').innerHTML = '';
    document.getElementById('noConditionsMsg').style.display = 'block';
    conditionCounter = 0;
    // Limpiar árbol de navegación
    RouteNavigation.clearNavItems();
  }

  // Condition header row counters per condition
  const conditionHeaderCounters = {};

  function toggleConditionHeaders(conditionId) {
    const body = document.getElementById(`condition-headers-body-${conditionId}`);
    const chevron = document.getElementById(`condition-headers-chevron-${conditionId}`);
    if (body) {
      const isHidden = body.style.display === 'none';
      body.style.display = isHidden ? 'block' : 'none';
      if (chevron) chevron.classList.toggle('rotated', isHidden);
    }
  }

  function addConditionHeaderRow(conditionId, name = '', value = '', action = 'set') {
    if (!conditionHeaderCounters[conditionId]) conditionHeaderCounters[conditionId] = 0;
    conditionHeaderCounters[conditionId]++;
    const rowId = conditionHeaderCounters[conditionId];

    const container = document.getElementById(`condition-headers-container-${conditionId}`);
    const noHeadersMsg = document.getElementById(`condition-no-headers-${conditionId}`);
    if (noHeadersMsg) noHeadersMsg.style.display = 'none';

    const row = document.createElement('div');
    row.className = 'd-flex gap-2 mb-2 align-items-center';
    row.id = `condition-header-${conditionId}-${rowId}`;
    row.innerHTML = `
      <select class="form-control-modern form-select-modern" style="width: 90px;" id="ch-action-${conditionId}-${rowId}">
        <option value="set" ${action === 'set' ? 'selected' : ''}>Set</option>
        <option value="remove" ${action === 'remove' ? 'selected' : ''}>Remove</option>
      </select>
      <input type="text" class="form-control-modern" placeholder="Header name" id="ch-name-${conditionId}-${rowId}" value="${escapeHtml(name)}" style="width: 140px;">
      <input type="text" class="form-control-modern" placeholder="Value" id="ch-value-${conditionId}-${rowId}" value="${escapeHtml(value)}" style="flex: 1;">
      <button class="btn-icon btn-icon-danger" type="button" onclick="removeConditionHeaderRow(${conditionId}, ${rowId})">
        <i class="fa fa-times"></i>
      </button>
    `;
    container.appendChild(row);

    // Update value visibility based on action
    const actionSelect = document.getElementById(`ch-action-${conditionId}-${rowId}`);
    const valueInput = document.getElementById(`ch-value-${conditionId}-${rowId}`);
    if (action === 'remove') valueInput.style.display = 'none';
    actionSelect.addEventListener('change', function() {
      valueInput.style.display = this.value === 'remove' ? 'none' : 'block';
      if (this.value === 'remove') valueInput.value = '';
    });
  }

  function removeConditionHeaderRow(conditionId, rowId) {
    const row = document.getElementById(`condition-header-${conditionId}-${rowId}`);
    if (row) row.remove();

    const container = document.getElementById(`condition-headers-container-${conditionId}`);
    const noHeadersMsg = document.getElementById(`condition-no-headers-${conditionId}`);
    if (container && container.children.length === 0 && noHeadersMsg) {
      noHeadersMsg.style.display = 'block';
    }
  }

  function getConditionHeaders(conditionId) {
    const headers = [];
    const container = document.getElementById(`condition-headers-container-${conditionId}`);
    if (!container) return null;

    const rows = container.querySelectorAll('[id^="condition-header-"]');
    rows.forEach(row => {
      const parts = row.id.split('-'); // condition-header-{conditionId}-{rowId}
      const rowId = parts[parts.length - 1];
      const action = document.getElementById(`ch-action-${conditionId}-${rowId}`)?.value || 'set';
      const name = document.getElementById(`ch-name-${conditionId}-${rowId}`)?.value.trim() || '';
      const value = document.getElementById(`ch-value-${conditionId}-${rowId}`)?.value || '';
      if (name) headers.push({ action, name, value });
    });
    return headers.length > 0 ? headers : null;
  }

  async function loadConditionsForRoute(routeId) {
    try {
      const response = await fetch(`/api/conditions/${routeId}`);
      const data = await response.json();
      if (data.success && data.conditions) {
        setConditions(data.conditions);
        // Mostrar la sección si hay condiciones
        if (data.conditions.length > 0) {
          document.querySelector('#divConditions .collapsible-body').style.display = 'block';
        }
      }
    } catch (e) {
      console.error('Error cargando condiciones:', e);
    }
  }

  // ===== PROXY FALLBACK FUNCTIONS =====
  let fallbackCounter = 0;

  function toggleFallbacksSection() {
    const body = document.querySelector('#divFallbacks .collapsible-body');
    body.style.display = body.style.display === 'none' ? 'block' : 'none';
  }

  function addFallbackRow(data = {}) {
    fallbackCounter++;
    const container = document.getElementById('fallbacksContainer');
    document.getElementById('noFallbacksMsg').style.display = 'none';

    // Parsear error_types si es string
    let errorTypes = data.error_types || ['all'];
    if (typeof errorTypes === 'string') {
      try {
        errorTypes = JSON.parse(errorTypes);
      } catch (e) {
        errorTypes = ['all'];
      }
    }

    const card = document.createElement('div');
    card.className = 'fallback-card';
    card.id = `fallback-${fallbackCounter}`;
    card.dataset.order = fallbackCounter;

    card.innerHTML = `
      <div class="fallback-header">
        <div class="fallback-drag-handle" title="${t('actions.moveUp')}/${t('actions.moveDown')}">
          <i class="fa fa-bars"></i>
        </div>
        <button class="btn-condition-toggle" type="button" id="fallback-toggle-${fallbackCounter}"
                onclick="toggleFallbackCollapse(${fallbackCounter})" title="${t('buttons.toggleCollapse')}">
          <i class="fa fa-chevron-down"></i>
        </button>
        <input type="text" class="form-control-modern fallback-name"
               placeholder="${t('form.fallbackName')}"
               id="fallback-name-${fallbackCounter}"
               value="${escapeHtml(data.nombre || '')}">
        <label class="switch-modern" style="margin-left: auto;">
          <input type="checkbox" id="fallback-active-${fallbackCounter}" ${data.activo !== 0 ? 'checked' : ''}>
          <span class="slider"></span>
        </label>
        <button class="btn-icon btn-icon-danger" type="button" onclick="removeFallbackRow(${fallbackCounter})" title="${t('buttons.delete')}">
          <i class="fa fa-trash"></i>
        </button>
      </div>
      <div class="fallback-body fallback-body-collapsible" id="fallback-body-${fallbackCounter}">
        <div class="form-group-modern">
          <label class="form-label-modern">${t('form.pathPattern')} <span style="color: var(--danger);">*</span></label>
          <input type="text" class="form-control-modern"
                 id="fallback-pattern-${fallbackCounter}"
                 placeholder=".*"
                 value="${escapeHtml(data.path_pattern || '.*')}">
          <div id="fallback-pattern-validation-${fallbackCounter}" class="condition-validation"></div>
        </div>

        <div class="form-group-modern">
          <label class="form-label-modern">${t('form.errorTypesLabel')}</label>
          <div class="error-types-checkboxes">
            <label class="checkbox-modern">
              <input type="checkbox" id="fallback-error-timeout-${fallbackCounter}" ${errorTypes.includes('timeout') ? 'checked' : ''}>
              <span>${t('errorTypes.timeout')}</span>
            </label>
            <label class="checkbox-modern">
              <input type="checkbox" id="fallback-error-connection-${fallbackCounter}" ${errorTypes.includes('connection') ? 'checked' : ''}>
              <span>${t('errorTypes.connection')}</span>
            </label>
            <label class="checkbox-modern">
              <input type="checkbox" id="fallback-error-http5xx-${fallbackCounter}" ${errorTypes.includes('http5xx') ? 'checked' : ''}>
              <span>${t('errorTypes.http5xx')}</span>
            </label>
            <label class="checkbox-modern">
              <input type="checkbox" id="fallback-error-all-${fallbackCounter}" ${errorTypes.includes('all') ? 'checked' : ''}>
              <span>${t('errorTypes.all')}</span>
            </label>
          </div>
        </div>

        <div class="fallback-overrides">
          <div class="override-row">
            <div class="form-group-modern" style="flex: 0 0 100px;">
              <label class="form-label-modern">${t('table.code')}</label>
              <input type="text" class="form-control-modern"
                     id="fallback-code-${fallbackCounter}"
                     placeholder="200"
                     value="${escapeHtml(data.codigo || '200')}">
            </div>
            <div class="form-group-modern" style="flex: 0 0 150px;">
              <label class="form-label-modern">${t('table.type')}</label>
              <select class="form-control-modern form-select-modern"
                      id="fallback-type-${fallbackCounter}">
                <option value="json" ${(data.tiporespuesta || 'json') === 'json' ? 'selected' : ''}>JSON</option>
                <option value="xml" ${data.tiporespuesta === 'xml' ? 'selected' : ''}>XML</option>
                <option value="text" ${data.tiporespuesta === 'text' ? 'selected' : ''}>Text</option>
                <option value="html" ${data.tiporespuesta === 'html' ? 'selected' : ''}>HTML</option>
                <option value="empty" ${data.tiporespuesta === 'empty' ? 'selected' : ''}>Empty</option>
              </select>
            </div>
          </div>

          <div class="form-group-modern">
            <label class="form-label-modern">${t('form.response')}</label>
            <textarea class="form-control-modern"
                      id="fallback-response-${fallbackCounter}"
                      placeholder="${t('form.placeholder.fallbackResponse')}"
                      rows="3">${escapeHtml(data.respuesta || '')}</textarea>
          </div>

          <!-- Custom Headers for this fallback -->
          <div class="fallback-headers-section">
            <div class="fallback-headers-header" onclick="toggleFallbackHeaders(${fallbackCounter})">
              <span><i class="fa fa-list-ul"></i> ${t('form.customHeaders')}</span>
              <i class="fa fa-chevron-down fallback-headers-chevron" id="fallback-headers-chevron-${fallbackCounter}"></i>
            </div>
            <div class="fallback-headers-body" id="fallback-headers-body-${fallbackCounter}" style="display: none;">
              <div id="fallback-headers-container-${fallbackCounter}"></div>
              <div id="fallback-no-headers-${fallbackCounter}" class="empty-state-mini">
                <small>${t('empty.noHeaders')}</small>
              </div>
              <button type="button" class="btn-modern btn-modern-outline btn-sm" onclick="addFallbackHeaderRow(${fallbackCounter})">
                <i class="fa fa-plus"></i> ${t('buttons.addHeader')}
              </button>
            </div>
          </div>

          <!-- Conditional Responses for this fallback -->
          <div class="fallback-conditions-section">
            <div class="fallback-conditions-header" onclick="toggleFallbackConditions(${fallbackCounter})">
              <span><i class="fa fa-code-branch"></i> ${t('form.conditionalResponses')}</span>
              <i class="fa fa-chevron-down fallback-conditions-chevron" id="fallback-conditions-chevron-${fallbackCounter}"></i>
            </div>
            <div class="fallback-conditions-body" id="fallback-conditions-body-${fallbackCounter}" style="display: none;">
              <small style="color: var(--text-muted); margin-bottom: 0.5rem; display: block;">
                ${t('form.help.conditionsHelp')}
              </small>
              <div id="fallback-conditions-container-${fallbackCounter}" class="sortable-fallback-conditions"></div>
              <div id="fallback-no-conditions-${fallbackCounter}" class="empty-state-mini">
                <small>${t('empty.noConditions')}</small>
              </div>
              <button type="button" class="btn-modern btn-modern-outline btn-sm" onclick="addFallbackConditionRow(${fallbackCounter})">
                <i class="fa fa-plus"></i> ${t('buttons.addCondition')}
              </button>
            </div>
          </div>
        </div>
      </div>
    `;

    container.appendChild(card);

    // Agregar al árbol de navegación con estado
    const isActive = data.activo !== 0;
    RouteNavigation.addFallbackNavItem(fallbackCounter, data.nombre || '', isActive);

    // Escuchar cambios en el nombre para actualizar el árbol
    const nameInput = document.getElementById(`fallback-name-${fallbackCounter}`);
    if (nameInput) {
      nameInput.addEventListener('input', (e) => {
        const fbId = e.target.id.replace('fallback-name-', '');
        RouteNavigation.updateFallbackNavItemName(fbId, e.target.value);
      });
    }

    // Escuchar cambios en el estado activo para actualizar el icono
    const activeSwitch = document.getElementById(`fallback-active-${fallbackCounter}`);
    if (activeSwitch) {
      activeSwitch.addEventListener('change', (e) => {
        const fbId = e.target.id.replace('fallback-active-', '');
        RouteNavigation.updateFallbackNavItemStatus(fbId, e.target.checked);
      });
    }

    // Cargar headers si existen
    if (data.customHeaders) {
      let headers = data.customHeaders;
      if (typeof headers === 'string') {
        try { headers = JSON.parse(headers); } catch (e) { headers = []; }
      }
      if (Array.isArray(headers) && headers.length > 0) {
        headers.forEach(h => addFallbackHeaderRow(fallbackCounter, h.name, h.value, h.action));
        document.getElementById(`fallback-headers-body-${fallbackCounter}`).style.display = 'block';
        const chevron = document.getElementById(`fallback-headers-chevron-${fallbackCounter}`);
        if (chevron) chevron.classList.add('rotated');
      }
    }

    // Cargar condiciones si existen
    if (data.conditions && Array.isArray(data.conditions) && data.conditions.length > 0) {
      data.conditions.forEach(c => addFallbackConditionRow(fallbackCounter, c));
      document.getElementById(`fallback-conditions-body-${fallbackCounter}`).style.display = 'block';
      const chevron = document.getElementById(`fallback-conditions-chevron-${fallbackCounter}`);
      if (chevron) chevron.classList.add('rotated');
    }

    // Inicializar sortable si es la primera condición
    if (fallbackCounter === 1 && typeof Sortable !== 'undefined') {
      new Sortable(container, {
        animation: 150,
        handle: '.fallback-drag-handle',
        onEnd: function(evt) {
          Array.from(container.children).forEach((card, i) => {
            card.dataset.order = i + 1;
          });
        }
      });
    }
  }

  function removeFallbackRow(id) {
    // Eliminar del árbol de navegación
    RouteNavigation.removeFallbackNavItem(id);

    const card = document.getElementById(`fallback-${id}`);
    if (card) card.remove();

    const container = document.getElementById('fallbacksContainer');
    if (container.children.length === 0) {
      document.getElementById('noFallbacksMsg').style.display = 'block';
    }
  }

  function getFallbacks() {
    const fallbacks = [];
    const container = document.getElementById('fallbacksContainer');
    const cards = Array.from(container.querySelectorAll('.fallback-card'))
      .sort((a, b) => (parseInt(a.dataset.order) || 0) - (parseInt(b.dataset.order) || 0));

    cards.forEach((card, idx) => {
      const id = card.id.replace('fallback-', '');
      const pathPattern = document.getElementById(`fallback-pattern-${id}`).value.trim();

      if (!pathPattern) return; // Saltar fallbacks vacíos

      // Recoger tipos de error seleccionados
      const errorTypes = [];
      if (document.getElementById(`fallback-error-timeout-${id}`).checked) errorTypes.push('timeout');
      if (document.getElementById(`fallback-error-connection-${id}`).checked) errorTypes.push('connection');
      if (document.getElementById(`fallback-error-http5xx-${id}`).checked) errorTypes.push('http5xx');
      if (document.getElementById(`fallback-error-all-${id}`).checked) errorTypes.push('all');

      // Si no hay ninguno seleccionado, usar 'all'
      if (errorTypes.length === 0) errorTypes.push('all');

      fallbacks.push({
        orden: idx,
        nombre: document.getElementById(`fallback-name-${id}`).value.trim() || null,
        path_pattern: pathPattern,
        error_types: errorTypes,
        codigo: document.getElementById(`fallback-code-${id}`).value.trim() || '200',
        tiporespuesta: document.getElementById(`fallback-type-${id}`).value || 'json',
        respuesta: document.getElementById(`fallback-response-${id}`).value || null,
        customHeaders: getFallbackHeaders(id),
        conditions: getFallbackConditions(id),
        activo: document.getElementById(`fallback-active-${id}`).checked ? 1 : 0
      });
    });

    return fallbacks;
  }

  function setFallbacks(fallbacks) {
    clearFallbacks();
    if (fallbacks && Array.isArray(fallbacks)) {
      fallbacks.forEach(f => addFallbackRow(f));
    }
  }

  function clearFallbacks() {
    document.getElementById('fallbacksContainer').innerHTML = '';
    document.getElementById('noFallbacksMsg').style.display = 'block';
    fallbackCounter = 0;
    // Limpiar árbol de navegación de fallbacks
    RouteNavigation.clearFallbackNavItems();
  }

  async function loadFallbacksForRoute(routeId) {
    try {
      const response = await fetch(`/api/fallbacks/${routeId}`);
      const data = await response.json();
      if (data.success && data.fallbacks) {
        setFallbacks(data.fallbacks);
        // Mostrar la sección si hay fallbacks
        if (data.fallbacks.length > 0) {
          document.querySelector('#divFallbacks .collapsible-body').style.display = 'block';
        }
      }
    } catch (e) {
      console.error('Error cargando fallbacks:', e);
    }
  }

  async function saveFallbacksForRoute(routeId) {
    const fallbacks = getFallbacks();
    if (fallbacks.length === 0) return true;

    try {
      const response = await fetch(`/api/fallbacks/${routeId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ fallbacks })
      });
      const data = await response.json();
      if (!data.success) {
        showToast(data.error || 'Error guardando fallbacks', 'error');
        return false;
      }
      return true;
    } catch (e) {
      console.error('Error guardando fallbacks:', e);
      showToast('Error guardando fallbacks', 'error');
      return false;
    }
  }

  // ===== FALLBACK COLLAPSE FUNCTIONS =====
  function toggleFallbackCollapse(fallbackId) {
    const body = document.getElementById(`fallback-body-${fallbackId}`);
    const toggleBtn = document.getElementById(`fallback-toggle-${fallbackId}`);

    if (!body) return;

    const isCollapsed = body.classList.contains('collapsed');

    if (isCollapsed) {
      expandFallback(fallbackId);
    } else {
      collapseFallback(fallbackId);
    }
  }

  function expandFallback(fallbackId) {
    const body = document.getElementById(`fallback-body-${fallbackId}`);
    const toggleBtn = document.getElementById(`fallback-toggle-${fallbackId}`);

    if (body) body.classList.remove('collapsed');
    if (toggleBtn) toggleBtn.classList.remove('collapsed');
  }

  function collapseFallback(fallbackId) {
    const body = document.getElementById(`fallback-body-${fallbackId}`);
    const toggleBtn = document.getElementById(`fallback-toggle-${fallbackId}`);

    if (body) body.classList.add('collapsed');
    if (toggleBtn) toggleBtn.classList.add('collapsed');
  }

  // Fallback header row counters per fallback
  const fallbackHeaderCounters = {};

  function toggleFallbackHeaders(fallbackId) {
    const body = document.getElementById(`fallback-headers-body-${fallbackId}`);
    const chevron = document.getElementById(`fallback-headers-chevron-${fallbackId}`);
    if (body) {
      const isHidden = body.style.display === 'none';
      body.style.display = isHidden ? 'block' : 'none';
      if (chevron) chevron.classList.toggle('rotated', isHidden);
    }
  }

  function addFallbackHeaderRow(fallbackId, name = '', value = '', action = 'set') {
    if (!fallbackHeaderCounters[fallbackId]) fallbackHeaderCounters[fallbackId] = 0;
    fallbackHeaderCounters[fallbackId]++;
    const rowId = fallbackHeaderCounters[fallbackId];

    const container = document.getElementById(`fallback-headers-container-${fallbackId}`);
    const noHeadersMsg = document.getElementById(`fallback-no-headers-${fallbackId}`);
    if (noHeadersMsg) noHeadersMsg.style.display = 'none';

    const row = document.createElement('div');
    row.className = 'd-flex gap-2 mb-2 align-items-center';
    row.id = `fallback-header-${fallbackId}-${rowId}`;
    row.innerHTML = `
      <select class="form-control-modern form-select-modern" style="width: 90px;" id="fh-action-${fallbackId}-${rowId}">
        <option value="set" ${action === 'set' ? 'selected' : ''}>Set</option>
        <option value="remove" ${action === 'remove' ? 'selected' : ''}>Remove</option>
      </select>
      <input type="text" class="form-control-modern" placeholder="Header name" id="fh-name-${fallbackId}-${rowId}" value="${escapeHtml(name)}" style="width: 140px;">
      <input type="text" class="form-control-modern" placeholder="Value" id="fh-value-${fallbackId}-${rowId}" value="${escapeHtml(value)}" style="flex: 1;">
      <button class="btn-icon btn-icon-danger" type="button" onclick="removeFallbackHeaderRow(${fallbackId}, ${rowId})">
        <i class="fa fa-times"></i>
      </button>
    `;
    container.appendChild(row);

    // Update value visibility based on action
    const actionSelect = document.getElementById(`fh-action-${fallbackId}-${rowId}`);
    const valueInput = document.getElementById(`fh-value-${fallbackId}-${rowId}`);
    if (action === 'remove') valueInput.style.display = 'none';
    actionSelect.addEventListener('change', function() {
      valueInput.style.display = this.value === 'remove' ? 'none' : 'block';
      if (this.value === 'remove') valueInput.value = '';
    });
  }

  function removeFallbackHeaderRow(fallbackId, rowId) {
    const row = document.getElementById(`fallback-header-${fallbackId}-${rowId}`);
    if (row) row.remove();

    const container = document.getElementById(`fallback-headers-container-${fallbackId}`);
    const noHeadersMsg = document.getElementById(`fallback-no-headers-${fallbackId}`);
    if (container && container.children.length === 0 && noHeadersMsg) {
      noHeadersMsg.style.display = 'block';
    }
  }

  function getFallbackHeaders(fallbackId) {
    const headers = [];
    const container = document.getElementById(`fallback-headers-container-${fallbackId}`);
    if (!container) return null;

    const rows = container.querySelectorAll('[id^="fallback-header-"]');
    rows.forEach(row => {
      const parts = row.id.split('-'); // fallback-header-{fallbackId}-{rowId}
      const rowId = parts[parts.length - 1];
      const action = document.getElementById(`fh-action-${fallbackId}-${rowId}`)?.value || 'set';
      const name = document.getElementById(`fh-name-${fallbackId}-${rowId}`)?.value.trim() || '';
      const value = document.getElementById(`fh-value-${fallbackId}-${rowId}`)?.value || '';
      if (name) headers.push({ action, name, value });
    });
    return headers.length > 0 ? headers : null;
  }

  // ===== FALLBACK CONDITIONS FUNCTIONS =====
  const fallbackConditionCounters = {};

  function toggleFallbackConditions(fallbackId) {
    const body = document.getElementById(`fallback-conditions-body-${fallbackId}`);
    const chevron = document.getElementById(`fallback-conditions-chevron-${fallbackId}`);
    if (body) {
      const isHidden = body.style.display === 'none';
      body.style.display = isHidden ? 'block' : 'none';
      if (chevron) chevron.classList.toggle('rotated', isHidden);
    }
  }

  function addFallbackConditionRow(fallbackId, data = {}) {
    if (!fallbackConditionCounters[fallbackId]) fallbackConditionCounters[fallbackId] = 0;
    fallbackConditionCounters[fallbackId]++;
    const condId = fallbackConditionCounters[fallbackId];

    const container = document.getElementById(`fallback-conditions-container-${fallbackId}`);
    const noConditionsMsg = document.getElementById(`fallback-no-conditions-${fallbackId}`);
    if (noConditionsMsg) noConditionsMsg.style.display = 'none';

    const card = document.createElement('div');
    card.className = 'fallback-condition-card';
    card.id = `fc-${fallbackId}-${condId}`;
    card.dataset.order = condId;

    card.innerHTML = `
      <div class="fallback-condition-header">
        <div class="fc-drag-handle" title="${t('actions.moveUp')}/${t('actions.moveDown')}">
          <i class="fa fa-bars"></i>
        </div>
        <button class="btn-condition-toggle" type="button" id="fc-toggle-${fallbackId}-${condId}"
                onclick="toggleFallbackConditionCollapse(${fallbackId}, ${condId})" title="${t('buttons.toggleCollapse')}">
          <i class="fa fa-chevron-down"></i>
        </button>
        <input type="text" class="form-control-modern fc-name"
               placeholder="${t('form.conditionName')}"
               id="fc-name-${fallbackId}-${condId}"
               value="${escapeHtml(data.nombre || '')}">
        <label class="switch-modern" style="margin-left: auto;">
          <input type="checkbox" id="fc-active-${fallbackId}-${condId}" ${data.activo !== 0 ? 'checked' : ''}>
          <span class="slider"></span>
        </label>
        <button class="btn-icon btn-icon-danger" type="button" onclick="removeFallbackConditionRow(${fallbackId}, ${condId})" title="${t('buttons.delete')}">
          <i class="fa fa-trash"></i>
        </button>
      </div>
      <div class="fallback-condition-body fc-body-collapsible" id="fc-body-${fallbackId}-${condId}">
        <div class="form-group-modern">
          <label class="form-label-modern">${t('form.criteria')} <span style="color: var(--danger);">*</span></label>
          <textarea class="form-control-modern"
                    id="fc-criteria-${fallbackId}-${condId}"
                    placeholder='header["X-Custom"] == "test" || body.userId == 123'
                    rows="2">${escapeHtml(data.criteria || '')}</textarea>
        </div>

        <div class="fc-overrides">
          <div class="override-row">
            <div class="form-group-modern" style="flex: 0 0 80px;">
              <label class="form-label-modern">${t('table.code')}</label>
              <input type="text" class="form-control-modern"
                     id="fc-code-${fallbackId}-${condId}"
                     placeholder="${t('form.inherit')}"
                     value="${escapeHtml(data.codigo || '')}">
            </div>
            <div class="form-group-modern" style="flex: 0 0 120px;">
              <label class="form-label-modern">${t('table.type')}</label>
              <select class="form-control-modern form-select-modern"
                      id="fc-type-${fallbackId}-${condId}">
                <option value="" ${!data.tiporespuesta ? 'selected' : ''}>${t('form.inherit')}</option>
                <option value="json" ${data.tiporespuesta === 'json' ? 'selected' : ''}>JSON</option>
                <option value="xml" ${data.tiporespuesta === 'xml' ? 'selected' : ''}>XML</option>
                <option value="text" ${data.tiporespuesta === 'text' ? 'selected' : ''}>Text</option>
                <option value="html" ${data.tiporespuesta === 'html' ? 'selected' : ''}>HTML</option>
              </select>
            </div>
          </div>

          <div class="form-group-modern">
            <label class="form-label-modern">${t('form.response')}</label>
            <textarea class="form-control-modern"
                      id="fc-response-${fallbackId}-${condId}"
                      placeholder="${t('form.placeholder.leaveEmptyInherit')}"
                      rows="2">${escapeHtml(data.respuesta || '')}</textarea>
          </div>

          <!-- Custom Headers for this fallback condition -->
          <div class="fc-headers-section">
            <div class="fc-headers-header" onclick="toggleFallbackConditionHeaders(${fallbackId}, ${condId})">
              <span><i class="fa fa-list-ul"></i> ${t('form.customHeaders')}</span>
              <i class="fa fa-chevron-down fc-headers-chevron" id="fc-headers-chevron-${fallbackId}-${condId}"></i>
            </div>
            <div class="fc-headers-body" id="fc-headers-body-${fallbackId}-${condId}" style="display: none;">
              <div id="fc-headers-container-${fallbackId}-${condId}"></div>
              <div id="fc-no-headers-${fallbackId}-${condId}" class="empty-state-mini">
                <small>${t('empty.noHeaders')}</small>
              </div>
              <button type="button" class="btn-modern btn-modern-outline btn-sm" onclick="addFallbackConditionHeaderRow(${fallbackId}, ${condId})">
                <i class="fa fa-plus"></i> ${t('buttons.addHeader')}
              </button>
            </div>
          </div>
        </div>
      </div>
    `;

    container.appendChild(card);

    // Agregar al árbol de navegación con nombre por defecto y estado
    const isActive = data.activo !== 0;
    RouteNavigation.addFallbackConditionNavItem(fallbackId, condId, data.nombre || '', condId, isActive);

    // Escuchar cambios en el nombre para actualizar el árbol
    const nameInput = document.getElementById(`fc-name-${fallbackId}-${condId}`);
    if (nameInput) {
      nameInput.addEventListener('input', (e) => {
        const order = document.getElementById(`fc-${fallbackId}-${condId}`)?.dataset.order || condId;
        RouteNavigation.updateFallbackConditionNavItemName(fallbackId, condId, e.target.value, order);
      });
    }

    // Escuchar cambios en el estado activo para actualizar el icono
    const activeSwitch = document.getElementById(`fc-active-${fallbackId}-${condId}`);
    if (activeSwitch) {
      activeSwitch.addEventListener('change', (e) => {
        RouteNavigation.updateFallbackConditionNavItemStatus(fallbackId, condId, e.target.checked);
      });
    }

    // Cargar headers si existen
    if (data.customHeaders) {
      let headers = data.customHeaders;
      if (typeof headers === 'string') {
        try { headers = JSON.parse(headers); } catch (e) { headers = []; }
      }
      if (Array.isArray(headers) && headers.length > 0) {
        headers.forEach(h => addFallbackConditionHeaderRow(fallbackId, condId, h.name, h.value, h.action));
        document.getElementById(`fc-headers-body-${fallbackId}-${condId}`).style.display = 'block';
        const chevron = document.getElementById(`fc-headers-chevron-${fallbackId}-${condId}`);
        if (chevron) chevron.classList.add('rotated');
      }
    }

    // Inicializar sortable para las condiciones de este fallback
    if (condId === 1 && typeof Sortable !== 'undefined') {
      new Sortable(container, {
        animation: 150,
        handle: '.fc-drag-handle',
        onEnd: function(evt) {
          Array.from(container.children).forEach((c, i) => {
            c.dataset.order = i + 1;
            // Actualizar nombre en el árbol si no tiene nombre personalizado
            const fcId = c.id.replace('fc-', '').split('-');
            const fbId = fcId[0];
            const cId = fcId[1];
            const nameInput = document.getElementById(`fc-name-${fbId}-${cId}`);
            if (nameInput && !nameInput.value.trim()) {
              RouteNavigation.updateFallbackConditionNavItemName(fbId, cId, '', i + 1);
            }
          });
        }
      });
    }
  }

  function removeFallbackConditionRow(fallbackId, condId) {
    // Eliminar del árbol de navegación
    RouteNavigation.removeFallbackConditionNavItem(fallbackId, condId);

    const card = document.getElementById(`fc-${fallbackId}-${condId}`);
    if (card) card.remove();

    const container = document.getElementById(`fallback-conditions-container-${fallbackId}`);
    const noConditionsMsg = document.getElementById(`fallback-no-conditions-${fallbackId}`);
    if (container && container.children.length === 0 && noConditionsMsg) {
      noConditionsMsg.style.display = 'block';
    }

    // Reordenar los nombres por defecto en el árbol
    if (container) {
      Array.from(container.children).forEach((c, i) => {
        const fcId = c.id.replace('fc-', '').split('-');
        const fbId = fcId[0];
        const cId = fcId[1];
        const nameInput = document.getElementById(`fc-name-${fbId}-${cId}`);
        if (nameInput && !nameInput.value.trim()) {
          RouteNavigation.updateFallbackConditionNavItemName(fbId, cId, '', i + 1);
        }
      });
    }
  }

  function getFallbackConditions(fallbackId) {
    const conditions = [];
    const container = document.getElementById(`fallback-conditions-container-${fallbackId}`);
    if (!container) return [];

    const cards = Array.from(container.querySelectorAll('.fallback-condition-card'))
      .sort((a, b) => (parseInt(a.dataset.order) || 0) - (parseInt(b.dataset.order) || 0));

    cards.forEach((card, idx) => {
      const parts = card.id.split('-'); // fc-{fallbackId}-{condId}
      const condId = parts[parts.length - 1];
      const criteria = document.getElementById(`fc-criteria-${fallbackId}-${condId}`)?.value.trim() || '';

      if (!criteria) return; // Skip empty conditions

      conditions.push({
        orden: idx,
        nombre: document.getElementById(`fc-name-${fallbackId}-${condId}`)?.value.trim() || null,
        criteria: criteria,
        codigo: document.getElementById(`fc-code-${fallbackId}-${condId}`)?.value.trim() || null,
        tiporespuesta: document.getElementById(`fc-type-${fallbackId}-${condId}`)?.value || null,
        respuesta: document.getElementById(`fc-response-${fallbackId}-${condId}`)?.value || null,
        customHeaders: getFallbackConditionHeaders(fallbackId, condId),
        activo: document.getElementById(`fc-active-${fallbackId}-${condId}`)?.checked ? 1 : 0
      });
    });

    return conditions;
  }

  // ===== FALLBACK CONDITION COLLAPSE FUNCTIONS =====
  function toggleFallbackConditionCollapse(fallbackId, condId) {
    const body = document.getElementById(`fc-body-${fallbackId}-${condId}`);
    const toggleBtn = document.getElementById(`fc-toggle-${fallbackId}-${condId}`);

    if (!body) return;

    const isCollapsed = body.classList.contains('collapsed');

    if (isCollapsed) {
      expandFallbackCondition(fallbackId, condId);
    } else {
      collapseFallbackCondition(fallbackId, condId);
    }
  }

  function expandFallbackCondition(fallbackId, condId) {
    const body = document.getElementById(`fc-body-${fallbackId}-${condId}`);
    const toggleBtn = document.getElementById(`fc-toggle-${fallbackId}-${condId}`);

    if (body) body.classList.remove('collapsed');
    if (toggleBtn) toggleBtn.classList.remove('collapsed');
  }

  function collapseFallbackCondition(fallbackId, condId) {
    const body = document.getElementById(`fc-body-${fallbackId}-${condId}`);
    const toggleBtn = document.getElementById(`fc-toggle-${fallbackId}-${condId}`);

    if (body) body.classList.add('collapsed');
    if (toggleBtn) toggleBtn.classList.add('collapsed');
  }

  // ===== FALLBACK CONDITION HEADERS FUNCTIONS =====
  const fcHeaderCounters = {};

  function toggleFallbackConditionHeaders(fallbackId, condId) {
    const body = document.getElementById(`fc-headers-body-${fallbackId}-${condId}`);
    const chevron = document.getElementById(`fc-headers-chevron-${fallbackId}-${condId}`);
    if (body) {
      const isHidden = body.style.display === 'none';
      body.style.display = isHidden ? 'block' : 'none';
      if (chevron) chevron.classList.toggle('rotated', isHidden);
    }
  }

  function addFallbackConditionHeaderRow(fallbackId, condId, name = '', value = '', action = 'set') {
    const key = `${fallbackId}-${condId}`;
    if (!fcHeaderCounters[key]) fcHeaderCounters[key] = 0;
    fcHeaderCounters[key]++;
    const rowId = fcHeaderCounters[key];

    const container = document.getElementById(`fc-headers-container-${fallbackId}-${condId}`);
    const noHeadersMsg = document.getElementById(`fc-no-headers-${fallbackId}-${condId}`);
    if (noHeadersMsg) noHeadersMsg.style.display = 'none';

    const row = document.createElement('div');
    row.className = 'd-flex gap-2 mb-2 align-items-center';
    row.id = `fch-${fallbackId}-${condId}-${rowId}`;
    row.innerHTML = `
      <select class="form-control-modern form-select-modern" style="width: 90px;" id="fch-action-${fallbackId}-${condId}-${rowId}">
        <option value="set" ${action === 'set' ? 'selected' : ''}>Set</option>
        <option value="remove" ${action === 'remove' ? 'selected' : ''}>Remove</option>
      </select>
      <input type="text" class="form-control-modern" placeholder="Header name" id="fch-name-${fallbackId}-${condId}-${rowId}" value="${escapeHtml(name)}" style="width: 140px;">
      <input type="text" class="form-control-modern" placeholder="Value" id="fch-value-${fallbackId}-${condId}-${rowId}" value="${escapeHtml(value)}" style="flex: 1;">
      <button class="btn-icon btn-icon-danger" type="button" onclick="removeFallbackConditionHeaderRow(${fallbackId}, ${condId}, ${rowId})">
        <i class="fa fa-times"></i>
      </button>
    `;
    container.appendChild(row);

    // Update value visibility based on action
    const actionSelect = document.getElementById(`fch-action-${fallbackId}-${condId}-${rowId}`);
    const valueInput = document.getElementById(`fch-value-${fallbackId}-${condId}-${rowId}`);
    if (action === 'remove') valueInput.style.display = 'none';
    actionSelect.addEventListener('change', function() {
      valueInput.style.display = this.value === 'remove' ? 'none' : 'block';
      if (this.value === 'remove') valueInput.value = '';
    });
  }

  function removeFallbackConditionHeaderRow(fallbackId, condId, rowId) {
    const row = document.getElementById(`fch-${fallbackId}-${condId}-${rowId}`);
    if (row) row.remove();

    const container = document.getElementById(`fc-headers-container-${fallbackId}-${condId}`);
    const noHeadersMsg = document.getElementById(`fc-no-headers-${fallbackId}-${condId}`);
    if (container && container.children.length === 0 && noHeadersMsg) {
      noHeadersMsg.style.display = 'block';
    }
  }

  function getFallbackConditionHeaders(fallbackId, condId) {
    const headers = [];
    const container = document.getElementById(`fc-headers-container-${fallbackId}-${condId}`);
    if (!container) return null;

    const rows = container.querySelectorAll(`[id^="fch-${fallbackId}-${condId}-"]`);
    rows.forEach(row => {
      const parts = row.id.split('-'); // fch-{fallbackId}-{condId}-{rowId}
      const rowId = parts[parts.length - 1];
      const action = document.getElementById(`fch-action-${fallbackId}-${condId}-${rowId}`)?.value || 'set';
      const name = document.getElementById(`fch-name-${fallbackId}-${condId}-${rowId}`)?.value.trim() || '';
      const value = document.getElementById(`fch-value-${fallbackId}-${condId}-${rowId}`)?.value || '';
      if (name) headers.push({ action, name, value });
    });
    return headers.length > 0 ? headers : null;
  }

  function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  function showElements(list) { list.forEach(el => $(el).show()); }
  function hideElements(list) { list.forEach(el => $(el).hide()); }

  // ===== FILE UPLOAD FUNCTIONS =====
  let selectedFile = null;
  let keepExistingFile = false;

  function handleFileSelect(event) {
    const file = event.target.files[0];
    if (file) {
      selectedFile = file;
      keepExistingFile = false;
      document.getElementById('fileInfo').style.display = 'flex';
      document.getElementById('fileName').textContent = file.name;
      document.getElementById('fileSize').textContent = formatFileSize(file.size);
      document.getElementById('currentFileInfo').style.display = 'none';
    }
  }

  function clearFileSelection() {
    selectedFile = null;
    keepExistingFile = false;
    document.getElementById('fileUpload').value = '';
    document.getElementById('fileInfo').style.display = 'none';
    document.getElementById('fileName').textContent = '';
    document.getElementById('fileSize').textContent = '';
  }

  function setCurrentFileInfo(fileName, fileSize) {
    if (fileName) {
      keepExistingFile = true;
      document.getElementById('currentFileInfo').style.display = 'flex';
      document.getElementById('currentFileName').textContent = fileName;
      document.getElementById('currentFileSize').textContent = fileSize ? formatFileSize(fileSize) : '';
    } else {
      document.getElementById('currentFileInfo').style.display = 'none';
    }
  }

  function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
  }

  // ===== GRAPHQL OPERATIONS FUNCTIONS =====
  let graphqlOpCounter = 0;

  function toggleGraphQLSection() {
    const body = document.getElementById('graphqlCollapsibleBody');
    if (body) body.style.display = body.style.display === 'none' ? 'block' : 'none';
  }

  function addGraphQLOperationRow(data = {}) {
    graphqlOpCounter++;
    const container = document.getElementById('graphqlOperationsContainer');
    const noMsg = document.getElementById('noGraphQLOpsMsg');
    if (noMsg) noMsg.style.display = 'none';

    const isActive = data.activo !== false && data.activo !== 0;
    const opId = graphqlOpCounter;

    const card = document.createElement('div');
    card.className = 'condition-card';
    card.id = `graphql-op-${opId}`;
    card.dataset.order = opId;

    const escapedName = escapeHtml(data.operationName || '');
    const escapedResponse = escapeHtml(data.respuesta || '');

    const isProxy = data.useProxy === true || data.useProxy === 1;

    card.innerHTML = `
      <div class="condition-header" onclick="toggleGraphQLOpCollapse(${opId})">
        <div style="display: flex; align-items: center; gap: 8px; flex: 1; min-width: 0;">
          <select class="form-control-modern" id="graphql-op-type-${opId}"
                  style="width: 120px; flex-shrink: 0;" onclick="event.stopPropagation()">
            <option value="query" ${data.operationType !== 'mutation' ? 'selected' : ''}>Query</option>
            <option value="mutation" ${data.operationType === 'mutation' ? 'selected' : ''}>Mutation</option>
          </select>
          <input type="text" class="form-control-modern condition-name"
                 placeholder="${t('form.operationName')}"
                 id="graphql-op-name-${opId}"
                 value="${escapedName}"
                 onclick="event.stopPropagation()"
                 oninput="RouteNavigation.updateGraphQLOpNavItemName(${opId}, this.value)">
        </div>
        <div style="display: flex; align-items: center; gap: 8px;">
          <select class="form-control-modern" id="graphql-op-mode-${opId}"
                  style="width: 100px; flex-shrink: 0;" onclick="event.stopPropagation()"
                  onchange="toggleGraphQLOpMode(${opId})">
            <option value="mock" ${!isProxy ? 'selected' : ''}>Mock</option>
            <option value="proxy" ${isProxy ? 'selected' : ''}>Proxy</option>
          </select>
          <label class="switch-modern" onclick="event.stopPropagation()">
            <input type="checkbox" id="graphql-op-active-${opId}" ${isActive ? 'checked' : ''}
                   onchange="RouteNavigation.updateGraphQLOpNavItemName(${opId}, document.getElementById('graphql-op-name-${opId}').value)">
            <span class="slider"></span>
          </label>
          <button class="btn-icon btn-icon-danger" type="button"
                  onclick="event.stopPropagation(); removeGraphQLOperationRow(${opId})">
            <i class="fa fa-trash"></i>
          </button>
        </div>
      </div>
      <div class="condition-body" id="graphql-op-body-${opId}">
        <div class="form-group-modern" id="graphql-op-response-group-${opId}" style="${isProxy ? 'display:none;' : ''}">
          <div class="form-label-row">
            <label class="form-label-modern">${t('form.response')} (JSON)</label>
            <button type="button" class="btn-modern btn-modern-secondary btn-sm"
                    onclick="formatGraphQLOpResponse(${opId})">
              <i class="fa fa-align-left"></i> ${t('buttons.format')}
            </button>
          </div>
          <textarea class="form-control-modern"
                    id="graphql-op-response-${opId}"
                    rows="5"
                    placeholder='{ "user": { "id": 1, "name": "John", "email": "john@example.com" } }'
          >${escapedResponse}</textarea>
        </div>
        <div id="graphql-op-proxy-info-${opId}" style="${isProxy ? '' : 'display:none;'} padding: 0.5rem 0;">
          <small style="color: var(--text-muted);">
            <i class="fa fa-exchange"></i> ${t('form.graphqlProxyInfo')}
          </small>
        </div>
      </div>
    `;

    container.appendChild(card);
    RouteNavigation.addGraphQLOpNavItem(opId, data.operationName || '', isActive);
  }

  function toggleGraphQLOpCollapse(opId) {
    const body = document.getElementById(`graphql-op-body-${opId}`);
    if (body) body.style.display = body.style.display === 'none' ? 'block' : 'none';
  }

  function toggleGraphQLOpMode(opId) {
    const mode = document.getElementById(`graphql-op-mode-${opId}`).value;
    const responseGroup = document.getElementById(`graphql-op-response-group-${opId}`);
    const proxyInfo = document.getElementById(`graphql-op-proxy-info-${opId}`);

    if (mode === 'proxy') {
      if (responseGroup) responseGroup.style.display = 'none';
      if (proxyInfo) proxyInfo.style.display = '';
    } else {
      if (responseGroup) responseGroup.style.display = '';
      if (proxyInfo) proxyInfo.style.display = 'none';
    }
    updateGraphQLProxyUrlVisibility();
  }

  function updateGraphQLProxyUrlVisibility() {
    const container = document.getElementById('graphqlProxyUrlContainer');
    if (!container) return;
    const opsContainer = document.getElementById('graphqlOperationsContainer');
    if (!opsContainer) return;
    const hasProxy = Array.from(opsContainer.querySelectorAll('.condition-card')).some(card => {
      const id = card.id.replace('graphql-op-', '');
      const modeEl = document.getElementById(`graphql-op-mode-${id}`);
      return modeEl && modeEl.value === 'proxy';
    });
    container.style.display = hasProxy ? 'block' : 'none';
  }

  function removeGraphQLOperationRow(id) {
    const card = document.getElementById(`graphql-op-${id}`);
    if (card) card.remove();
    RouteNavigation.removeGraphQLOpNavItem(id);
    const container = document.getElementById('graphqlOperationsContainer');
    if (container && container.children.length === 0) {
      const noMsg = document.getElementById('noGraphQLOpsMsg');
      if (noMsg) noMsg.style.display = 'block';
    }
  }

  function getGraphQLOperations() {
    const operations = [];
    const container = document.getElementById('graphqlOperationsContainer');
    if (!container) return operations;

    const cards = Array.from(container.querySelectorAll('.condition-card'));
    cards.forEach((card, idx) => {
      const id = card.id.replace('graphql-op-', '');
      const nameEl = document.getElementById(`graphql-op-name-${id}`);
      const operationName = nameEl ? nameEl.value.trim() : '';
      if (!operationName) return;

      const modeEl = document.getElementById(`graphql-op-mode-${id}`);
      const useProxy = modeEl && modeEl.value === 'proxy';
      operations.push({
        orden: idx,
        operationType: document.getElementById(`graphql-op-type-${id}`).value,
        operationName: operationName,
        respuesta: useProxy ? null : (document.getElementById(`graphql-op-response-${id}`).value || null),
        activo: document.getElementById(`graphql-op-active-${id}`).checked,
        useProxy: useProxy
      });
    });
    return operations;
  }

  function clearGraphQLOperations() {
    const container = document.getElementById('graphqlOperationsContainer');
    if (container) container.innerHTML = '';
    const noMsg = document.getElementById('noGraphQLOpsMsg');
    if (noMsg) noMsg.style.display = 'block';
    graphqlOpCounter = 0;
    RouteNavigation.clearGraphQLOpNavItems();
  }

  async function loadGraphQLOperationsForRoute(routeId) {
    try {
      const response = await fetch(`/api/graphql-operations/${routeId}`);
      const data = await response.json();
      if (data.success && data.operations) {
        clearGraphQLOperations();
        data.operations.forEach(op => addGraphQLOperationRow(op));
        if (data.operations.length > 0) {
          const gqlBody = document.getElementById('graphqlCollapsibleBody');
          if (gqlBody) gqlBody.style.display = 'block';
        }
      }
    } catch (e) {
      console.error('Error loading GraphQL operations:', e);
    }
  }

  async function saveGraphQLOperationsForRoute(routeId) {
    const operations = getGraphQLOperations();
    try {
      const response = await fetch(`/api/graphql-operations/${routeId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ operations })
      });
      const data = await response.json();
      if (!data.success) {
        showToast(data.error || t('errors.savingGraphQLOperations'), 'error');
        return false;
      }
      return true;
    } catch (e) {
      console.error('Error saving GraphQL operations:', e);
      return false;
    }
  }

  function formatGraphQLOpResponse(id) {
    const textarea = document.getElementById(`graphql-op-response-${id}`);
    if (!textarea || !textarea.value.trim()) return;
    try {
      const parsed = JSON.parse(textarea.value);
      textarea.value = JSON.stringify(parsed, null, 2);
    } catch (e) {
      showToast('JSON ' + t('validation.jsonInvalid') + ': ' + e.message, 'error');
    }
  }

  // ===== GRAPHQL SCHEMA IMPORT =====
  let currentGraphQLSchema = null;

  function openGraphQLSchemaImport() {
    const form = document.getElementById('graphqlSchemaImportForm');
    form.style.display = form.style.display === 'none' ? 'block' : 'none';
  }

  async function importGraphQLSchema() {
    const url = document.getElementById('graphqlSchemaUrl').value.trim();
    if (!url) {
      showToast(t('form.graphqlSchemaUrlRequired'), 'error');
      return;
    }

    const btn = document.getElementById('btnImportSchema');
    const progress = document.getElementById('schemaImportProgress');
    const statusEl = document.getElementById('schemaImportStatus');

    btn.disabled = true;
    progress.style.display = 'block';
    statusEl.textContent = t('form.importingSchema');

    try {
      const routeId = document.getElementById('idmodal').textContent || null;

      const response = await fetch('/api/graphql-schema/import', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ url, routeId: routeId && routeId.trim() ? routeId.trim() : undefined })
      });

      const data = await response.json();

      if (!data.success) {
        throw new Error(data.error || 'Unknown error');
      }

      currentGraphQLSchema = data.schema;

      // Auto-rellenar proxy URL con la URL del endpoint importado
      const proxyUrlInput = document.getElementById('graphqlProxyUrl');
      if (proxyUrlInput) proxyUrlInput.value = url;

      // Limpiar operaciones existentes y cargar las generadas
      clearGraphQLOperations();
      data.operations.forEach(op => addGraphQLOperationRow(op));
      updateGraphQLProxyUrlVisibility();

      // Auto-expandir sección GraphQL
      const gqlBody = document.getElementById('graphqlCollapsibleBody');
      if (gqlBody) gqlBody.style.display = 'block';

      // Ocultar formulario de import
      document.getElementById('graphqlSchemaImportForm').style.display = 'none';

      showToast(
        t('form.schemaImported').replace('{{count}}', data.operationCount),
        'success'
      );
    } catch (err) {
      showToast(err.message, 'error');
    } finally {
      btn.disabled = false;
      progress.style.display = 'none';
    }
  }

  async function loadGraphQLSchemaForRoute(routeId) {
    try {
      const response = await fetch(`/api/graphql-schema/${routeId}`);
      const data = await response.json();
      if (data.success && data.schema) {
        currentGraphQLSchema = data.schema;
      } else {
        currentGraphQLSchema = null;
      }
    } catch (e) {
      console.error('Error loading GraphQL schema:', e);
      currentGraphQLSchema = null;
    }
  }

  async function saveGraphQLSchemaForRoute(routeId) {
    if (!currentGraphQLSchema) return;
    try {
      await fetch(`/api/graphql-schema/${routeId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ schema: currentGraphQLSchema })
      });
    } catch (e) {
      console.error('Error saving GraphQL schema:', e);
    }
  }

  async function loadGraphQLProxyUrlForRoute(routeId) {
    try {
      const response = await fetch(`/api/graphql-proxy-url/${routeId}`);
      const data = await response.json();
      const proxyUrlInput = document.getElementById('graphqlProxyUrl');
      if (proxyUrlInput) {
        proxyUrlInput.value = data.success && data.proxyUrl ? data.proxyUrl : '';
      }
    } catch (e) {
      console.error('Error loading GraphQL proxy URL:', e);
    }
  }

  async function saveGraphQLProxyUrlForRoute(routeId) {
    const proxyUrlInput = document.getElementById('graphqlProxyUrl');
    const proxyUrl = proxyUrlInput ? proxyUrlInput.value.trim() : '';
    try {
      await fetch(`/api/graphql-proxy-url/${routeId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ proxyUrl: proxyUrl || null })
      });
    } catch (e) {
      console.error('Error saving GraphQL proxy URL:', e);
    }
  }

  // ===== GRAPHIQL TESTER =====
  function openGraphiQLTester(routeObj) {
    const baseUrl = window.location.origin;
    let route = routeObj.ruta;
    if (routeObj.isRegex) {
      route = regexToSampleUrl(route);
    }
    const graphqlUrl = baseUrl + route;

    // Mostrar endpoint en el header
    document.getElementById('graphiqlEndpointUrl').textContent = graphqlUrl;

    const container = document.getElementById('graphiqlContainer');
    container.innerHTML = '';

    const graphQLFetcher = (graphQLParams) => {
      return fetch(graphqlUrl, {
        method: 'POST',
        headers: {
          'Accept': 'application/json',
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(graphQLParams),
      }).then(response => response.json());
    };

    const modal = new bootstrap.Modal(document.getElementById('graphiqlTesterModal'));
    modal.show();

    // Renderizar GraphiQL cuando el modal esté visible (necesita dimensiones)
    document.getElementById('graphiqlTesterModal').addEventListener('shown.bs.modal', function onShown() {
      document.getElementById('graphiqlTesterModal').removeEventListener('shown.bs.modal', onShown);

      const root = ReactDOM.createRoot(container);
      root.render(
        React.createElement(GraphiQL, {
          fetcher: graphQLFetcher,
          defaultQuery: `# GraphiQL IDE\n#\n# Endpoint: ${graphqlUrl}\n#\nquery {\n  \n}\n`
        })
      );

      container._reactRoot = root;
    }, { once: true });

    // Cleanup al cerrar
    document.getElementById('graphiqlTesterModal').addEventListener('hidden.bs.modal', function onHidden() {
      document.getElementById('graphiqlTesterModal').removeEventListener('hidden.bs.modal', onHidden);
      if (container._reactRoot) {
        container._reactRoot.unmount();
        container._reactRoot = null;
      }
      container.innerHTML = '';
    }, { once: true });
  }

  // ===== MODAL FUNCTIONS =====
  function openModal(type = 'create', objId) {
    // Inicializar navegación del modal
    RouteNavigation.init();

    // Limpiar condiciones, operaciones GraphQL y schema siempre al abrir
    clearConditions();
    clearGraphQLOperations();
    currentGraphQLSchema = null;
    // Resetear proxy URL
    const proxyUrlInput = document.getElementById('graphqlProxyUrl');
    if (proxyUrlInput) proxyUrlInput.value = '';
    const proxyUrlContainer = document.getElementById('graphqlProxyUrlContainer');
    if (proxyUrlContainer) proxyUrlContainer.style.display = 'none';
    // Ocultar formulario de import schema
    const schemaImportForm = document.getElementById('graphqlSchemaImportForm');
    if (schemaImportForm) schemaImportForm.style.display = 'none';
    // Colapsar sección de condiciones
    document.querySelector('#divConditions .collapsible-body').style.display = 'block';

    // Resetear scroll del panel de contenido
    const contentPanel = document.getElementById('routeContentPanel');
    if (contentPanel) contentPanel.scrollTop = 0;

    // Marcar item principal como activo
    document.querySelectorAll('.route-nav-item').forEach(item => item.classList.remove('active'));
    const mainNavItem = document.querySelector('.route-nav-main');
    if (mainNavItem) mainNavItem.classList.add('active');

    if (type === 'create') {
      checkRespuesta();
      $("#botoneditar").hide();
      $("#botonguardar").show();
      $("#titleModal").html('<i class="fa fa-plus me-2"></i>Nueva Ruta');
      $("#routesModal").modal('show');
    }
    if (type === 'edit') {
      $("#idmodal").html(objId);
      $("#botoneditar").show();
      $("#botonguardar").hide();
      const obj = Array.from(tabla.rows().data()).find(el => el.id === objId);
      valuesForModal(obj);
      checkRespuesta();
      // Cargar condiciones existentes
      loadConditionsForRoute(objId);
      // Cargar operaciones GraphQL si es tipo graphql
      if (obj && obj.tiporespuesta === 'graphql') {
        loadGraphQLOperationsForRoute(objId).then(() => updateGraphQLProxyUrlVisibility());
        loadGraphQLSchemaForRoute(objId);
        loadGraphQLProxyUrlForRoute(objId);
      }
      $("#titleModal").html('<i class="fa fa-pencil me-2"></i>Editar Ruta');
      $("#routesModal").modal('show');
    }
  }

  function openList() { $("#modalLista").modal('show'); }

  // ===== TOOLS DROPDOWN =====
  function toggleToolsDropdown() {
    const menu = document.getElementById('toolsDropdownMenu');
    menu.classList.toggle('show');
  }

  function closeToolsDropdown() {
    const menu = document.getElementById('toolsDropdownMenu');
    menu.classList.remove('show');
  }

  // Close dropdown when clicking outside
  document.addEventListener('click', function(e) {
    const dropdown = document.querySelector('.dropdown-modern');
    if (dropdown && !dropdown.contains(e.target)) {
      closeToolsDropdown();
    }
  });

  // ===== GLOBAL TAG MANAGER =====
  const globalPredefinedColors = [
    '#6366f1', '#8b5cf6', '#ec4899', '#ef4444', '#f97316', '#f59e0b',
    '#10b981', '#14b8a6', '#06b6d4', '#3b82f6', '#374151', '#1e293b'
  ];

  function openTagManager() {
    renderGlobalTagManager();
    document.getElementById('tagManagerModal').style.display = 'flex';
  }

  function closeTagManager() {
    document.getElementById('tagManagerModal').style.display = 'none';
  }

  function renderGlobalTagManager() {
    const container = document.getElementById('tagManagerList');
    if (!container) return;

    const tags = TagsModule.availableTags;

    if (tags.length === 0) {
      container.innerHTML = `<div class="empty-state"><i class="fa fa-inbox"></i><p>${t('empty.noTags')}</p></div>`;
      return;
    }

    container.innerHTML = tags.map(tag => `
      <div class="tag-manager-item" data-tag-id="${tag.id}">
        <span class="badge-tag" style="background: ${tag.color};">${escapeHtml(tag.name)}</span>
        <div class="tag-manager-actions">
          <input type="color" class="tag-color-picker" value="${tag.color}"
            onchange="updateGlobalTagColor('${tag.id}', this.value)" title="Cambiar color">
          <button type="button" class="btn-tag-delete" onclick="prepareDeleteTag('${tag.id}')" title="${t('buttons.delete')}">
            <i class="fa fa-trash"></i>
          </button>
          <button type="button" class="btn-tag-confirm-delete" style="display: none;" onclick="confirmDeleteTag('${tag.id}')">
            <i class="fa fa-exclamation-triangle"></i> ${t('buttons.delete')}?
          </button>
        </div>
      </div>
    `).join('');
  }

  async function updateGlobalTagColor(tagId, color) {
    try {
      const response = await fetch(`/api/tags/${tagId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ color })
      });
      const data = await response.json();

      if (data.success) {
        const tag = TagsModule.availableTags.find(t => t.id === tagId);
        if (tag) tag.color = color;
        const selectedTag = TagsModule.selectedTags.find(t => t.id === tagId);
        if (selectedTag) selectedTag.color = color;

        const importTag = ImportTagsModule.availableTags.find(t => t.id === tagId);
        if (importTag) importTag.color = color;
        const importSelectedTag = ImportTagsModule.selectedTags.find(t => t.id === tagId);
        if (importSelectedTag) importSelectedTag.color = color;

        renderGlobalTagManager();
        TagsModule.renderTagSelector();
        ImportTagsModule.renderTagSelector();
        initTagFilter();
        tabla.ajax.reload(null, false);
      }
    } catch (e) {
      console.error('Error updating tag color:', e);
    }
  }

  let pendingDeleteTagId = null;

  function prepareDeleteTag(tagId) {
    // Reset any other pending delete
    if (pendingDeleteTagId && pendingDeleteTagId !== tagId) {
      cancelPendingDelete();
    }

    pendingDeleteTagId = tagId;
    const item = document.querySelector(`.tag-manager-item[data-tag-id="${tagId}"]`);
    if (!item) return;

    const deleteBtn = item.querySelector('.btn-tag-delete');
    const confirmBtn = item.querySelector('.btn-tag-confirm-delete');
    if (deleteBtn) deleteBtn.style.display = 'none';
    if (confirmBtn) confirmBtn.style.display = 'inline-flex';

    // Auto-cancel after 3 seconds
    setTimeout(() => {
      if (pendingDeleteTagId === tagId) {
        cancelPendingDelete();
      }
    }, 3000);
  }

  function cancelPendingDelete() {
    if (!pendingDeleteTagId) return;
    const item = document.querySelector(`.tag-manager-item[data-tag-id="${pendingDeleteTagId}"]`);
    if (item) {
      const deleteBtn = item.querySelector('.btn-tag-delete');
      const confirmBtn = item.querySelector('.btn-tag-confirm-delete');
      if (deleteBtn) deleteBtn.style.display = 'inline-flex';
      if (confirmBtn) confirmBtn.style.display = 'none';
    }
    pendingDeleteTagId = null;
  }

  async function confirmDeleteTag(tagId) {
    if (pendingDeleteTagId !== tagId) return;

    try {
      const response = await fetch(`/api/tags/${tagId}`, {
        method: 'DELETE'
      });
      const data = await response.json();

      if (data.success) {
        pendingDeleteTagId = null;
        TagsModule.availableTags = TagsModule.availableTags.filter(t => t.id !== tagId);
        TagsModule.selectedTags = TagsModule.selectedTags.filter(t => t.id !== tagId);
        ImportTagsModule.availableTags = ImportTagsModule.availableTags.filter(t => t.id !== tagId);
        ImportTagsModule.selectedTags = ImportTagsModule.selectedTags.filter(t => t.id !== tagId);

        renderGlobalTagManager();
        TagsModule.renderTagSelector();
        ImportTagsModule.renderTagSelector();
        initTagFilter();
        tabla.ajax.reload(null, false);
      } else {
        showToast(data.error || 'Error eliminando tag', 'error');
      }
    } catch (e) {
      showToast('Error eliminando tag', 'error');
    }
  }

  function openTagCreatorFromManager() {
    document.getElementById('globalNewTagName').value = '';
    document.getElementById('globalCustomTagColor').value = '#6366f1';
    renderGlobalColorPalette();
    document.getElementById('globalTagCreatorPopup').style.display = 'flex';
  }

  function closeGlobalTagCreator() {
    document.getElementById('globalTagCreatorPopup').style.display = 'none';
  }

  function renderGlobalColorPalette() {
    const container = document.getElementById('globalColorPalette');
    if (!container) return;

    container.innerHTML = globalPredefinedColors.map((color, i) => `
      <button type="button" class="color-swatch ${i === 0 ? 'selected' : ''}"
        style="background: ${color};"
        data-color="${color}"
        onclick="selectGlobalColor('${color}')">
      </button>
    `).join('');
  }

  function selectGlobalColor(color) {
    document.querySelectorAll('#globalColorPalette .color-swatch').forEach(el => el.classList.remove('selected'));
    const swatch = document.querySelector(`#globalColorPalette .color-swatch[data-color="${color}"]`);
    if (swatch) swatch.classList.add('selected');
    document.getElementById('globalCustomTagColor').value = color;
  }

  async function createGlobalTag() {
    const name = document.getElementById('globalNewTagName').value.trim();
    const color = document.getElementById('globalCustomTagColor').value;

    if (!name) {
      showToast(t('validation.tagNameRequired'), 'warning');
      return;
    }

    try {
      const response = await fetch('/api/tags', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name, color })
      });
      const data = await response.json();

      if (data.success) {
        TagsModule.availableTags.push(data.tag);
        ImportTagsModule.availableTags.push(data.tag);
        renderGlobalTagManager();
        TagsModule.renderTagSelector();
        ImportTagsModule.renderTagSelector();
        initTagFilter();
        closeGlobalTagCreator();
      } else {
        showToast(data.error || t('errors.creatingTag'), 'error');
      }
    } catch (e) {
      showToast(t('errors.creatingTag'), 'error');
    }
  }

  let deleteRouteId = null;

  function openDeleteModal(id) {
    const obj = Array.from(tabla.rows().data()).find(el => el.id === id);
    if (!obj) return;

    deleteRouteId = id;

    // Llenar información del modal
    document.getElementById('deleteRouteId').textContent = obj.id;
    document.getElementById('deleteRouteMethod').innerHTML = `<span class="badge-modern badge-${obj.tipo}">${obj.tipo.toUpperCase()}</span>`;
    document.getElementById('deleteRoutePath').textContent = obj.ruta;
    document.getElementById('deleteRouteType').textContent = obj.tiporespuesta;
    document.getElementById('deleteRouteCode').textContent = obj.codigo;

    $('#deleteModal').modal('show');
  }

  async function confirmDelete() {
    if (!deleteRouteId) return;

    const btn = document.getElementById('confirmDeleteBtn');
    const originalHtml = btn.innerHTML;
    btn.innerHTML = `<i class="fa fa-spinner fa-spin"></i> ${t('buttons.deleting')}`;
    btn.disabled = true;

    const response = await fetch('/api/delete/' + deleteRouteId.toString(), { method: 'DELETE' });
    if (response.status === 200) {
      tabla.ajax.reload();
      $('#deleteModal').modal('hide');
      $("#routesModal").modal('hide');
    }

    btn.innerHTML = originalHtml;
    btn.disabled = false;
    deleteRouteId = null;
  }

  // Duplicate route functions
  let duplicateRouteId = null;

  function openDuplicateModal(id) {
    const obj = Array.from(tabla.rows().data()).find(el => el.id === id);
    if (!obj) return;

    duplicateRouteId = id;

    document.getElementById('duplicateRouteMethod').innerHTML = `<span class="badge-modern badge-${obj.tipo}">${obj.tipo.toUpperCase()}</span>`;
    document.getElementById('duplicateRouteOriginal').textContent = obj.ruta;
    document.getElementById('duplicateRouteType').textContent = obj.tiporespuesta;
    document.getElementById('duplicateRouteCode').textContent = obj.codigo;
    document.getElementById('duplicateNewRoute').value = obj.ruta;

    $('#duplicateModal').modal('show');

    // Focus en el input de ruta tras abrir el modal
    $('#duplicateModal').on('shown.bs.modal', function () {
      document.getElementById('duplicateNewRoute').focus();
      document.getElementById('duplicateNewRoute').select();
    });
  }

  async function confirmDuplicate() {
    if (!duplicateRouteId) return;

    const newRoute = document.getElementById('duplicateNewRoute').value.trim();
    if (!newRoute) {
      showToast(t('duplicate.routeRequired'), 'error');
      return;
    }

    if (newRoute.startsWith('/api/') || newRoute === '/api') {
      showToast(t('confirm.reservedRoute'), 'warning');
      return;
    }

    const btn = document.getElementById('confirmDuplicateBtn');
    const originalHtml = btn.innerHTML;
    btn.innerHTML = `<i class="fa fa-spinner fa-spin"></i> ${t('duplicate.duplicating')}`;
    btn.disabled = true;

    try {
      const response = await fetch(`/api/duplicate/${duplicateRouteId}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ newRoute })
      });

      if (response.ok) {
        tabla.ajax.reload();
        $('#duplicateModal').modal('hide');
        showToast(t('duplicate.success'), 'success');
      } else {
        const err = await response.json().catch(() => ({}));
        showToast(err.error || t('duplicate.error'), 'error');
      }
    } catch (e) {
      showToast(t('duplicate.error'), 'error');
    }

    btn.innerHTML = originalHtml;
    btn.disabled = false;
    duplicateRouteId = null;
  }

  // Bulk delete functions
  function toggleSelectAllRoutes(checked) {
    document.querySelectorAll('.route-select-check').forEach(cb => {
      cb.checked = checked;
    });
    updateBulkSelection();
  }

  function updateBulkSelection() {
    const checked = document.querySelectorAll('.route-select-check:checked');
    const btn = document.getElementById('bulkDeleteBtn');
    const count = document.getElementById('bulkDeleteCount');
    if (checked.length > 0) {
      btn.style.display = '';
      count.textContent = `${t('bulk.deleteSelected')} (${checked.length})`;
    } else {
      btn.style.display = 'none';
    }
    // Update select all checkbox state
    const all = document.querySelectorAll('.route-select-check');
    const selectAll = document.getElementById('selectAllRoutes');
    if (selectAll) {
      selectAll.checked = all.length > 0 && checked.length === all.length;
      selectAll.indeterminate = checked.length > 0 && checked.length < all.length;
    }
  }

  function openBulkDeleteModal() {
    const checked = document.querySelectorAll('.route-select-check:checked');
    if (checked.length === 0) return;

    const ids = Array.from(checked).map(cb => parseInt(cb.dataset.id));
    const routes = Array.from(tabla.rows().data()).filter(r => ids.includes(r.id));

    const listHtml = routes.map(r =>
      `<div class="delete-info-row">
        <span class="badge-modern badge-${r.tipo}" style="min-width:55px;text-align:center">${r.tipo.toUpperCase()}</span>
        <code class="delete-info-value delete-route-path ms-2">${r.ruta}</code>
      </div>`
    ).join('');

    document.getElementById('bulkDeleteList').innerHTML = listHtml;
    document.getElementById('bulkDeleteConfirmCount').textContent = `${t('buttons.delete')} (${ids.length})`;

    $('#bulkDeleteModal').modal('show');
  }

  async function confirmBulkDelete() {
    const checked = document.querySelectorAll('.route-select-check:checked');
    if (checked.length === 0) return;

    const ids = Array.from(checked).map(cb => parseInt(cb.dataset.id));

    const btn = document.getElementById('confirmBulkDeleteBtn');
    const originalHtml = btn.innerHTML;
    btn.innerHTML = `<i class="fa fa-spinner fa-spin"></i> ${t('buttons.deleting')}`;
    btn.disabled = true;

    try {
      const response = await fetch('/api/delete-bulk', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ ids })
      });
      if (response.ok) {
        tabla.ajax.reload(function() {
          document.getElementById('selectAllRoutes').checked = false;
          updateBulkSelection();
        });
        $('#bulkDeleteModal').modal('hide');
      }
    } catch (err) {
      console.error('Bulk delete error:', err);
    }

    btn.innerHTML = originalHtml;
    btn.disabled = false;
  }

  $("#routesModal").on("hidden.bs.modal", clearModal);

  function clearModal() {
    document.getElementById("tipoSelect").value = 0;
    document.getElementById("ruta").value = '';
    document.getElementById("crespuestaInput").value = '200';
    document.getElementById("respuesta").value = '';
    document.getElementById("destinoProxy").value = '';
    document.getElementById("tiporespuesta").value = 'json';
    document.getElementById("esperaActiva").checked = false;
    document.getElementById("rutaActiva").checked = true;
    document.getElementById("isRegex").checked = false;
    document.getElementById("regexTestUrl").value = '';
    document.getElementById("divRegexValidator").style.display = "none";
    document.getElementById("regexResult").innerHTML = "";
    updateCodeDescription();
    clearHeaders();
    // Limpiar campos de archivo
    clearFileSelection();
    document.getElementById('currentFileInfo').style.display = 'none';
    // Limpiar tags
    TagsModule.clear();
    // Limpiar metadata
    document.getElementById("operationId").value = '';
    document.getElementById("summary").value = '';
    document.getElementById("description").value = '';
    document.getElementById("requestBodyExample").value = '';
    // Limpiar proxy timeout y fallbacks
    document.getElementById("proxyTimeout").value = '30000';
    clearFallbacks();
  }

  function valuesForModal(obj) {
    document.getElementById("tipoSelect").value = [...document.getElementById('tipoSelect').options].findIndex(opt => opt.text.toLowerCase() === obj.tipo);
    document.getElementById("ruta").value = obj.ruta;
    document.getElementById("crespuestaInput").value = obj.codigo;
    if (obj.tiporespuesta === 'proxy') {
      document.getElementById("destinoProxy").value = obj.respuesta || '';
      document.getElementById("respuesta").value = '';
      // Proxy timeout
      document.getElementById("proxyTimeout").value = obj.proxy_timeout || 30000;
    } else {
      document.getElementById("respuesta").value = obj.respuesta || '';
      document.getElementById("destinoProxy").value = '';
    }
    document.getElementById("tiporespuesta").value = obj.tiporespuesta;
    document.getElementById("esperaActiva").checked = obj.esperaActiva ?? false;
    document.getElementById("rutaActiva").checked = obj.activo !== 0;
    document.getElementById("isRegex").checked = obj.isRegex === 1;
    updateCodeDescription();
    toggleRegexMode();
    const headers = obj.customHeaders ? JSON.parse(obj.customHeaders) : null;
    setCustomHeaders(headers);
    // Archivo
    clearFileSelection();
    if (obj.tiporespuesta === 'file' && obj.fileName) {
      setCurrentFileInfo(obj.fileName);
    }
    // Tags
    const tags = obj.tags ? JSON.parse(obj.tags) : [];
    TagsModule.setTags(tags);
    // Metadata
    document.getElementById("operationId").value = obj.operationId || '';
    document.getElementById("summary").value = obj.summary || '';
    document.getElementById("description").value = obj.description || '';
    document.getElementById("requestBodyExample").value = obj.requestBodyExample || '';
    // Fallbacks - limpiar y cargar si es proxy
    clearFallbacks();
    if (obj.tiporespuesta === 'proxy' && obj.id) {
      loadFallbacksForRoute(obj.id);
    }
  }

  async function guardar() {
    const e = document.getElementById("tipoSelect");
    const tipo = e.options[e.selectedIndex].text.toLowerCase();
    const ruta = document.getElementById("ruta").value;

    // Validar que la ruta no comience con /api/
    if (ruta.startsWith('/api/') || ruta === '/api') {
      showToast(t('confirm.reservedRoute'), 'warning');
      return;
    }

    const codigo = document.getElementById("crespuestaInput").value;
    const tiporespuesta = document.getElementById("tiporespuesta").value;
    let respuesta = tiporespuesta === 'proxy'
      ? document.getElementById("destinoProxy").value
      : document.getElementById("respuesta").value;

    if (tiporespuesta === 'proxy' && respuesta && !respuesta.startsWith('http://') && !respuesta.startsWith('https://')) {
      respuesta = 'https://' + respuesta;
      document.getElementById("destinoProxy").value = respuesta;
    }

    const esperaActiva = document.getElementById("esperaActiva").checked;
    const activo = document.getElementById("rutaActiva").checked;
    const isRegex = document.getElementById("isRegex").checked;
    const customHeaders = getCustomHeaders();

    // Usar FormData para soportar archivos
    const formData = new FormData();
    formData.append('tipo', tipo);
    formData.append('ruta', ruta);
    formData.append('codigo', codigo);
    formData.append('respuesta', respuesta);
    formData.append('tiporespuesta', tiporespuesta);
    formData.append('esperaActiva', esperaActiva);
    formData.append('activo', activo);
    formData.append('isRegex', isRegex);
    if (customHeaders) {
      formData.append('customHeaders', JSON.stringify(customHeaders));
    }

    // Tags
    const tags = TagsModule.getTags();
    if (tags.length > 0) {
      formData.append('tags', JSON.stringify(tags));
    }

    // Metadata fields
    const operationId = document.getElementById("operationId").value;
    const summary = document.getElementById("summary").value;
    const description = document.getElementById("description").value;
    const requestBodyExample = document.getElementById("requestBodyExample").value;
    if (operationId) formData.append('operationId', operationId);
    if (summary) formData.append('summary', summary);
    if (description) formData.append('description', description);
    if (requestBodyExample) formData.append('requestBodyExample', requestBodyExample);

    // Proxy timeout
    if (tiporespuesta === 'proxy') {
      const proxyTimeout = document.getElementById("proxyTimeout").value || 30000;
      formData.append('proxyTimeout', proxyTimeout);
    }

    // Añadir archivo si está seleccionado
    if (tiporespuesta === 'file' && selectedFile) {
      formData.append('file', selectedFile);
    }

    const response = await fetch('/api/create', {
      method: 'POST',
      body: formData
    });

    if (response.status === 200) {
      const result = await response.json();

      // Guardar condiciones si hay alguna
      const conditions = getConditions();
      if (conditions.length > 0 && result.id) {
        const condResponse = await fetch(`/api/conditions/${result.id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ conditions })
        });
        if (!condResponse.ok) {
          const err = await condResponse.json().catch(() => ({}));
          showToast(err.error || t('errors.savingConditions'), 'error');
        }
      }

      // Guardar fallbacks si es proxy y hay alguno
      if (tiporespuesta === 'proxy' && result.id) {
        await saveFallbacksForRoute(result.id);
      }

      // Guardar operaciones GraphQL y schema si es tipo graphql
      if (tiporespuesta === 'graphql' && result.id) {
        await saveGraphQLOperationsForRoute(result.id);
        await saveGraphQLSchemaForRoute(result.id);
        await saveGraphQLProxyUrlForRoute(result.id);
      }

      tabla.ajax.reload();
      $("#routesModal").modal('hide');
    }
  }

  async function editar() {
    const id = $("#idmodal").text();
    const e = document.getElementById("tipoSelect");
    const tipo = e.options[e.selectedIndex].text.toLowerCase();
    const ruta = document.getElementById("ruta").value;

    // Validar que la ruta no comience con /api/
    if (ruta.startsWith('/api/') || ruta === '/api') {
      showToast(t('confirm.reservedRoute'), 'warning');
      return;
    }

    const codigo = document.getElementById("crespuestaInput").value;
    const tiporespuesta = document.getElementById("tiporespuesta").value;
    let respuesta = tiporespuesta === 'proxy'
      ? document.getElementById("destinoProxy").value
      : document.getElementById("respuesta").value;

    if (tiporespuesta === 'proxy' && respuesta && !respuesta.startsWith('http://') && !respuesta.startsWith('https://')) {
      respuesta = 'https://' + respuesta;
      document.getElementById("destinoProxy").value = respuesta;
    }

    const esperaActiva = document.getElementById("esperaActiva").checked;
    const activo = document.getElementById("rutaActiva").checked;
    const isRegex = document.getElementById("isRegex").checked;
    const customHeaders = getCustomHeaders();

    // Usar FormData para soportar archivos
    const formData = new FormData();
    formData.append('tipo', tipo);
    formData.append('ruta', ruta);
    formData.append('codigo', codigo);
    formData.append('respuesta', respuesta);
    formData.append('tiporespuesta', tiporespuesta);
    formData.append('esperaActiva', esperaActiva);
    formData.append('activo', activo);
    formData.append('isRegex', isRegex);
    if (customHeaders) {
      formData.append('customHeaders', JSON.stringify(customHeaders));
    }

    // Tags
    const tags = TagsModule.getTags();
    if (tags.length > 0) {
      formData.append('tags', JSON.stringify(tags));
    }

    // Metadata fields
    const operationId = document.getElementById("operationId").value;
    const summary = document.getElementById("summary").value;
    const description = document.getElementById("description").value;
    const requestBodyExample = document.getElementById("requestBodyExample").value;
    if (operationId) formData.append('operationId', operationId);
    if (summary) formData.append('summary', summary);
    if (description) formData.append('description', description);
    if (requestBodyExample) formData.append('requestBodyExample', requestBodyExample);

    // Proxy timeout
    if (tiporespuesta === 'proxy') {
      const proxyTimeout = document.getElementById("proxyTimeout").value || 30000;
      formData.append('proxyTimeout', proxyTimeout);
    }

    // Manejo de archivo
    if (tiporespuesta === 'file') {
      if (selectedFile) {
        formData.append('file', selectedFile);
      } else if (keepExistingFile) {
        formData.append('keepFile', 'true');
      }
    }

    const response = await fetch('/api/update/' + id, {
      method: 'PUT',
      body: formData
    });

    if (response.status === 200) {
      // Guardar condiciones
      const conditions = getConditions();
      if (conditions.length > 0) {
        const condResponse = await fetch(`/api/conditions/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ conditions })
        });
        if (!condResponse.ok) {
          const err = await condResponse.json().catch(() => ({}));
          showToast(err.error || t('errors.savingConditions'), 'error');
        }
      } else {
        // Limpiar condiciones existentes si no hay ninguna
        await fetch(`/api/conditions/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ conditions: [] })
        });
      }

      // Guardar/limpiar fallbacks si es proxy
      if (tiporespuesta === 'proxy') {
        await saveFallbacksForRoute(id);
      }

      // Guardar/limpiar operaciones GraphQL y schema
      if (tiporespuesta === 'graphql') {
        await saveGraphQLOperationsForRoute(id);
        await saveGraphQLSchemaForRoute(id);
        await saveGraphQLProxyUrlForRoute(id);
      }

      tabla.ajax.reload();
      $("#routesModal").modal('hide');
    }
  }

  async function iniciaTarea(id) {
    const item = document.getElementById('pl-' + id);
    const defaults = pendingDefaults[id] || {};

    // Obtener valores de los campos
    const bodyTextarea = document.getElementById('prt-' + id);
    const headersTextarea = document.getElementById('prh-' + id);
    const codeInput = document.getElementById('prc-' + id);
    const typeSelect = document.getElementById('prtype-' + id);

    const customData = {};

    // Body de respuesta
    if (bodyTextarea && bodyTextarea.value.trim()) {
      const defaultResponse = defaults.response || item?.dataset.response || '';
      if (bodyTextarea.value.trim() !== defaultResponse.trim()) {
        customData.body = bodyTextarea.value.trim();
      }
    }

    // Código de respuesta
    if (codeInput) {
      const defaultCode = defaults.code || item?.dataset.code || 200;
      if (parseInt(codeInput.value) !== parseInt(defaultCode)) {
        customData.code = parseInt(codeInput.value);
      }
    }

    // Tipo de respuesta
    if (typeSelect) {
      const defaultType = defaults.type || item?.dataset.type || 'json';
      if (typeSelect.value !== defaultType) {
        customData.type = typeSelect.value;
      }
    }

    // Headers personalizados
    if (headersTextarea && headersTextarea.value.trim()) {
      const defaultHeaders = defaults.headers || item?.dataset.headers || '';
      if (headersTextarea.value.trim() !== defaultHeaders.trim()) {
        customData.headers = headersTextarea.value.trim();
      }
    }

    // Solo enviar customResponse si hay algún cambio
    const hasChanges = Object.keys(customData).length > 0;

    await fetch('/api/initTask', {
      method: 'POST',
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ id, customResponse: hasChanges ? customData : null })
    });
  }

  // Almacena los datos por defecto de cada petición pendiente
  const pendingDefaults = {};

  function addItemToPendingList(item) {
    setTotalPending(1);
    // Guardar datos por defecto
    pendingDefaults[item.id] = {
      response: item.defaultResponse || '',
      code: item.codigo || 200,
      type: item.tiporespuesta || 'json',
      headers: item.customHeaders || ''
    };

    // Ocultar estado vacío si existe
    const emptyState = document.getElementById('pendingEmptyState');
    if (emptyState) emptyState.style.display = 'none';

    const canFormat = ['json', 'xml', 'soap', 'html'].includes(item.tiporespuesta);
    const div = document.createElement("div");
    div.className = 'pending-item';
    div.id = 'pl-' + item.id;
    div.dataset.id = item.id;
    div.dataset.response = item.defaultResponse || '';
    div.dataset.type = item.tiporespuesta || 'json';
    div.dataset.code = item.codigo || 200;
    div.dataset.headers = item.customHeaders || '{}';
    div.dataset.originalResponse = item.originalResponse || '';
    div.dataset.originalType = item.originalType || 'json';
    div.dataset.originalCode = item.originalCode || 200;
    div.dataset.originalHeaders = item.originalHeaders || '{}';
    div.dataset.conditions = item.conditions ? encodeURIComponent(JSON.stringify(item.conditions)) : '';

    // Build request headers HTML
    let requestHeadersHtml = '';
    if (item.requestHeaders && typeof item.requestHeaders === 'object') {
      requestHeadersHtml = Object.entries(item.requestHeaders).map(([key, value]) => `
        <div class="request-header-item">
          <span class="request-header-key">${escapeHtml(key)}:</span>
          <span class="request-header-value">${escapeHtml(String(value))}</span>
        </div>
      `).join('');
    }
    if (!requestHeadersHtml) {
      requestHeadersHtml = `<div class="request-headers-empty">${t('pending.noRequestHeaders')}</div>`;
    }

    // Build condition selector HTML
    let conditionSelectorHtml = '';
    if (item.conditions && item.conditions.length > 0) {
      let optionsHtml = item.conditions.map((cond, index) =>
        `<option value="${index}" data-codigo="${cond.codigo || ''}" data-tipo="${cond.tiporespuesta || ''}" data-respuesta="${encodeURIComponent(cond.respuesta || '')}" data-headers="${encodeURIComponent(cond.customHeaders || '')}">${escapeHtml(cond.nombre)}</option>`
      ).join('');
      conditionSelectorHtml = `
        <div class="form-group-modern pending-condition-selector">
          <label class="form-label-modern">${t('pending.selectCondition')}</label>
          <select class="form-control-modern" id="prcs-${item.id}" onchange="selectConditionResponse('${item.id}', this.value)">
            <option value="current">${t('pending.currentResponse')}</option>
            <option value="original">${t('pending.originalResponse')}</option>
            ${optionsHtml}
          </select>
        </div>
      `;
    }

    const method = item.method || 'GET';
    div.innerHTML = `
      <div class="pending-item-header">
        <div class="pending-item-info">
          <span class="badge-method badge-method-${method.toLowerCase()}">${method}</span>
          <span class="pending-item-url">${escapeHtml(item.url)}</span>
          <span class="pending-item-date">${item.date}</span>
        </div>
        <div class="pending-item-actions">
          <button class="btn-icon btn-icon-info" onclick="toggleRequestHeaders('${item.id}')" title="${t('pending.viewRequestHeaders')}">
            <i class="fa fa-list-ul"></i>
          </button>
          <button class="btn-icon btn-icon-primary" onclick="togglePendingResponse('${item.id}')" title="${t('modal.editResponse')}">
            <i class="fa fa-pencil"></i>
          </button>
          <button class="btn-icon btn-icon-success" onclick="iniciaTarea('${item.id}')" title="${t('modal.releaseRequest')}">
            <i class="fa fa-play"></i>
          </button>
        </div>
      </div>
      <div class="pending-request-headers" id="prqh-${item.id}" style="display: none;">
        <div class="request-headers-title">${t('pending.requestHeaders')}</div>
        <div class="request-headers-list">
          ${requestHeadersHtml}
        </div>
      </div>
      <div class="pending-item-response" id="pr-${item.id}" style="display: none;">
        ${conditionSelectorHtml}
        <div class="pending-response-row">
          <div class="form-group-modern pending-code-group">
            <label class="form-label-modern">${t('pending.code')}</label>
            <input type="number" class="form-control-modern" id="prc-${item.id}" value="${item.codigo || 200}" min="100" max="599">
          </div>
          <div class="form-group-modern pending-type-group">
            <label class="form-label-modern">${t('pending.type')}</label>
            <select class="form-control-modern" id="prtype-${item.id}" onchange="togglePendingFormatBtn('${item.id}')">
              <option value="json" ${item.tiporespuesta === 'json' ? 'selected' : ''}>JSON</option>
              <option value="xml" ${item.tiporespuesta === 'xml' ? 'selected' : ''}>XML</option>
              <option value="soap" ${item.tiporespuesta === 'soap' ? 'selected' : ''}>SOAP</option>
              <option value="text" ${item.tiporespuesta === 'text' ? 'selected' : ''}>Texto</option>
              <option value="html" ${item.tiporespuesta === 'html' ? 'selected' : ''}>HTML</option>
            </select>
          </div>
        </div>
        <div class="form-group-modern">
          <label class="form-label-modern">${t('pending.responseBody')}</label>
          <textarea class="form-control-modern" id="prt-${item.id}" rows="6" placeholder="${t('form.placeholder.leaveEmpty')}">${item.defaultResponse || ''}</textarea>
        </div>
        <div class="form-group-modern">
          <label class="form-label-modern">${t('pending.customHeadersJson')}</label>
          <textarea class="form-control-modern" id="prh-${item.id}" rows="3" placeholder='${t('form.placeholder.headersJson')}'>${item.customHeaders || ''}</textarea>
        </div>
        <div class="pending-response-actions">
          <button class="btn-modern btn-modern-secondary btn-sm" onclick="resetPendingResponse('${item.id}')">
            <i class="fa fa-undo"></i> ${t('buttons.restore')}
          </button>
          <button class="btn-modern btn-modern-primary btn-sm" id="prfmt-${item.id}" onclick="formatPendingContent('${item.id}')" style="${!canFormat ? 'display:none' : ''}">
            <i class="fa fa-align-left"></i> ${t('buttons.format')}
          </button>
        </div>
      </div>
    `;
    document.getElementById('pendingListContainer').appendChild(div);
  }

  function deleteItemFromPendingList(id) {
    setTotalPending(-1);
    delete pendingDefaults[id];
    const el = document.getElementById("pl-" + id);
    if (el) el.remove();

    // Mostrar estado vacío si no hay más elementos
    const container = document.getElementById('pendingListContainer');
    if (container && container.children.length === 0) {
      const emptyState = document.getElementById('pendingEmptyState');
      if (emptyState) emptyState.style.display = 'block';
    }
  }

  function togglePendingResponse(id) {
    const responseDiv = document.getElementById('pr-' + id);
    if (responseDiv) {
      const isHidden = responseDiv.style.display === 'none';
      responseDiv.style.display = isHidden ? 'block' : 'none';
    }
  }

  function toggleRequestHeaders(id) {
    const headersDiv = document.getElementById('prqh-' + id);
    if (headersDiv) {
      const isHidden = headersDiv.style.display === 'none';
      headersDiv.style.display = isHidden ? 'block' : 'none';
    }
  }

  function togglePendingFormatBtn(id) {
    const typeSelect = document.getElementById('prtype-' + id);
    const formatBtn = document.getElementById('prfmt-' + id);
    if (typeSelect && formatBtn) {
      const canFormat = ['json', 'xml', 'soap', 'html'].includes(typeSelect.value);
      formatBtn.style.display = canFormat ? '' : 'none';
    }
  }

  function resetPendingResponse(id) {
    const item = document.getElementById('pl-' + id);
    const defaults = pendingDefaults[id] || {};

    const bodyTextarea = document.getElementById('prt-' + id);
    const headersTextarea = document.getElementById('prh-' + id);
    const codeInput = document.getElementById('prc-' + id);
    const typeSelect = document.getElementById('prtype-' + id);
    const conditionSelect = document.getElementById('prcs-' + id);

    if (bodyTextarea) bodyTextarea.value = defaults.response || item?.dataset.response || '';
    if (headersTextarea) headersTextarea.value = defaults.headers || item?.dataset.headers || '';
    if (codeInput) codeInput.value = defaults.code || item?.dataset.code || 200;
    if (typeSelect) {
      typeSelect.value = defaults.type || item?.dataset.type || 'json';
      togglePendingFormatBtn(id);
    }
    // Reset condition selector to current
    if (conditionSelect) conditionSelect.value = 'current';
  }

  function selectConditionResponse(id, value) {
    const item = document.getElementById('pl-' + id);
    if (!item) return;

    const bodyTextarea = document.getElementById('prt-' + id);
    const headersTextarea = document.getElementById('prh-' + id);
    const codeInput = document.getElementById('prc-' + id);
    const typeSelect = document.getElementById('prtype-' + id);
    const conditionSelect = document.getElementById('prcs-' + id);

    let newCode, newType, newBody, newHeaders;

    if (value === 'current') {
      // Restore to the evaluated response (what's stored in pendingDefaults)
      const defaults = pendingDefaults[id] || {};
      newCode = defaults.code || item.dataset.code || 200;
      newType = defaults.type || item.dataset.type || 'json';
      newBody = defaults.response || item.dataset.response || '';
      newHeaders = defaults.headers || item.dataset.headers || '';
    } else if (value === 'original') {
      // Restore to original route response (before criteria evaluation)
      newCode = item.dataset.originalCode || 200;
      newType = item.dataset.originalType || 'json';
      newBody = item.dataset.originalResponse || '';
      newHeaders = item.dataset.originalHeaders || '';
    } else {
      // Load from selected condition
      const selectedOption = conditionSelect.options[conditionSelect.selectedIndex];
      if (selectedOption) {
        newCode = selectedOption.dataset.codigo || item.dataset.code || 200;
        newType = selectedOption.dataset.tipo || item.dataset.type || 'json';
        newBody = selectedOption.dataset.respuesta ? decodeURIComponent(selectedOption.dataset.respuesta) : '';
        newHeaders = selectedOption.dataset.headers ? decodeURIComponent(selectedOption.dataset.headers) : '';
      }
    }

    // Apply the values
    if (codeInput && newCode) codeInput.value = newCode;
    if (typeSelect && newType) {
      typeSelect.value = newType;
      togglePendingFormatBtn(id);
    }
    if (bodyTextarea) bodyTextarea.value = newBody || '';
    if (headersTextarea) headersTextarea.value = newHeaders || '';
  }

  function formatPendingContent(id) {
    const textarea = document.getElementById('prt-' + id);
    const typeSelect = document.getElementById('prtype-' + id);

    if (!textarea || !textarea.value.trim()) return;

    const tipo = typeSelect ? typeSelect.value : 'json';

    try {
      if (tipo === 'json') {
        const parsed = JSON.parse(textarea.value);
        textarea.value = JSON.stringify(parsed, null, 2);
      } else if (tipo === 'xml' || tipo === 'soap') {
        textarea.value = formatXml(textarea.value);
      } else if (tipo === 'html') {
        textarea.value = formatHtml(textarea.value);
      }
    } catch (e) {
      showToast(`${t('responseTypes.' + tipo) || tipo.toUpperCase()} ${t('validation.' + tipo + 'Invalid')}: ${e.message}`, 'error');
    }
  }

  function setTotalPending(number) {
    totalPending = totalPending + number;
    const badge = document.getElementById('pendingBadge');
    badge.textContent = totalPending;
    badge.style.display = totalPending > 0 ? 'flex' : 'none';
  }

  // ===== TOGGLE ACTIVO =====
  async function toggleActivo(id, activo) {
    const response = await fetch('/api/toggle-active/' + id, {
      method: 'PUT',
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ activo })
    });
    if (response.status === 200) {
      tabla.ajax.reload();
    }
  }

  async function toggleEsperaActiva(id, esperaActiva) {
    const response = await fetch('/api/toggle-wait/' + id, {
      method: 'PUT',
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ esperaActiva })
    });
    if (response.status === 200) {
      tabla.ajax.reload();
    }
  }

  // ===== CURL MODAL =====
  let currentCurlRoute = null;

  function openCurlModal(id) {
    const obj = Array.from(tabla.rows().data()).find(el => el.id === id);
    if (!obj) return;

    currentCurlRoute = obj;
    const baseUrl = window.location.origin;
    const method = obj.tipo.toUpperCase();
    const isRegex = obj.isRegex === 1;

    // Generar ruta de ejemplo para regex (usar función compartida)
    let exampleRoute = obj.ruta;
    if (isRegex) {
      exampleRoute = regexToSampleUrl(obj.ruta);
    }

    const fullUrl = baseUrl + exampleRoute;
    const cleanRoute = exampleRoute; // Guardar ruta limpia para el botón

    // Actualizar info
    document.getElementById('curlMethod').textContent = method;
    document.getElementById('curlMethod').className = `badge-modern badge-${obj.tipo}`;
    document.getElementById('curlRoute').textContent = isRegex ? `${obj.ruta} (regex)` : obj.ruta;
    document.getElementById('curlFullUrl').textContent = fullUrl;

    // Mostrar metadata si existe
    const operationIdRow = document.getElementById('curlOperationIdRow');
    const summaryRow = document.getElementById('curlSummaryRow');
    const descriptionRow = document.getElementById('curlDescriptionRow');

    if (obj.operationId) {
      document.getElementById('curlOperationId').textContent = obj.operationId;
      operationIdRow.style.display = 'flex';
    } else {
      operationIdRow.style.display = 'none';
    }

    if (obj.summary) {
      document.getElementById('curlSummary').textContent = obj.summary;
      summaryRow.style.display = 'flex';
    } else {
      summaryRow.style.display = 'none';
    }

    if (obj.description) {
      document.getElementById('curlDescription').textContent = obj.description;
      descriptionRow.style.display = 'flex';
    } else {
      descriptionRow.style.display = 'none';
    }

    // Generar comando curl
    let curlCmd = `curl -X ${method} "${fullUrl}"`;

    if (method === 'POST' || method === 'PUT' || method === 'PATCH' || method === 'DELETE') {
      curlCmd += ` \\\n  -H "Content-Type: application/json"`;
      // Use requestBodyExample if available, otherwise use empty object
      if (obj.requestBodyExample) {
        // Escape single quotes for shell and format in one line
        const bodyForCurl = obj.requestBodyExample.replace(/\n/g, '').replace(/'/g, "'\\''");
        curlCmd += ` \\\n  -d '${bodyForCurl}'`;
      } else {
        curlCmd += ` \\\n  -d '{}'`;
      }
    }

    document.getElementById('curlCommand').textContent = curlCmd;

    // Mostrar boton de abrir solo para GET (incluyendo rutas regex)
    const openSection = document.getElementById('curlOpenSection');
    if (method === 'GET') {
      openSection.style.display = 'block';
      // Guardar la ruta limpia para usar en el botón
      openSection.dataset.cleanRoute = cleanRoute;
    } else {
      openSection.style.display = 'none';
    }

    $("#curlModal").modal('show');
  }

  function copyCurl() {
    const curlText = document.getElementById('curlCommand').textContent;
    navigator.clipboard.writeText(curlText).then(() => {
      const btn = document.querySelector('#curlModal .btn-modern-secondary.btn-sm');
      const originalHtml = btn.innerHTML;
      btn.innerHTML = `<i class="fa fa-check"></i> ${t('buttons.copied')}`;
      setTimeout(() => {
        btn.innerHTML = originalHtml;
      }, 2000);
    });
  }

  function openRouteInBrowser() {
    if (currentCurlRoute && currentCurlRoute.tipo === 'get') {
      const openSection = document.getElementById('curlOpenSection');
      const cleanRoute = openSection.dataset.cleanRoute || currentCurlRoute.ruta;
      window.open(cleanRoute, '_blank');
    }
  }

  // ===== OPENAPI IMPORT =====
  let importPreviewData = null;

  // ImportTagsModule - separate module for import modal tags
  const ImportTagsModule = {
    availableTags: [],
    selectedTags: [],
    predefinedColors: [
      '#6366f1', '#8b5cf6', '#ec4899', '#ef4444', '#f97316', '#f59e0b',
      '#10b981', '#14b8a6', '#06b6d4', '#3b82f6', '#374151', '#1e293b'
    ],

    async init() {
      await this.loadTags();
      this.renderColorPalette();
    },

    async loadTags() {
      try {
        const response = await fetch('/api/tags');
        const data = await response.json();
        if (data.success) {
          this.availableTags = data.tags;
          this.renderTagSelector();
        }
      } catch (e) {
        console.error('Error loading tags for import:', e);
      }
    },

    renderTagSelector() {
      const container = document.getElementById('importTagsSelector');
      if (!container) return;

      // Only show selected tags with remove buttons
      if (this.selectedTags.length === 0) {
        container.innerHTML = '<span class="no-tags-msg">' + t('empty.noTags') + '</span>';
        return;
      }

      let html = '<div class="selected-tags-display">';
      this.selectedTags.forEach(tag => {
        html += `<span class="badge-tag badge-tag-removable" style="background: ${tag.color};">
          ${this.escapeHtml(tag.name)}
          <button type="button" class="tag-remove" onclick="ImportTagsModule.removeTag('${tag.id}')" title="Eliminar">
            <i class="fa fa-times"></i>
          </button>
        </span>`;
      });
      html += '</div>';

      container.innerHTML = html;
    },

    removeTag(tagId) {
      const index = this.selectedTags.findIndex(t => t.id === tagId);
      if (index >= 0) {
        this.selectedTags.splice(index, 1);
        this.renderTagSelector();
      }
    },

    addTag(tagId) {
      const tag = this.availableTags.find(t => t.id === tagId);
      if (!tag) return;

      if (this.selectedTags.find(t => t.id === tagId)) {
        this.closeCreator();
        return;
      }

      this.selectedTags.push(tag);
      this.renderTagSelector();
      this.closeCreator();
    },

    getTags() {
      return this.selectedTags;
    },

    clear() {
      this.selectedTags = [];
      this.renderTagSelector();
    },

    renderColorPalette() {
      const container = document.getElementById('importColorPalette');
      if (!container) return;

      container.innerHTML = this.predefinedColors.map((color, i) => `
        <button type="button" class="color-swatch ${i === 0 ? 'selected' : ''}"
          style="background: ${color};"
          data-color="${color}"
          onclick="ImportTagsModule.selectColor('${color}')">
        </button>
      `).join('');
    },

    selectColor(color) {
      document.querySelectorAll('#importColorPalette .color-swatch').forEach(el => el.classList.remove('selected'));
      const swatch = document.querySelector(`#importColorPalette .color-swatch[data-color="${color}"]`);
      if (swatch) swatch.classList.add('selected');
      document.getElementById('importCustomTagColor').value = color;
    },

    async createOrAddTag() {
      const name = document.getElementById('importNewTagName').value.trim();
      const color = document.getElementById('importCustomTagColor').value;

      if (!name) {
        showToast(t('validation.tagNameRequired'), 'warning');
        return;
      }

      // Check if tag already exists
      const existingTag = this.availableTags.find(t =>
        t.name.toLowerCase() === name.toLowerCase()
      );

      if (existingTag) {
        if (!this.selectedTags.find(t => t.id === existingTag.id)) {
          this.selectedTags.push(existingTag);
          this.renderTagSelector();
        }
        this.closeCreator();
        return;
      }

      // Create new tag
      try {
        const response = await fetch('/api/tags', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, color })
        });
        const data = await response.json();

        if (data.success) {
          this.availableTags.push(data.tag);
          this.selectedTags.push(data.tag);
          this.renderTagSelector();
          this.closeCreator();
          TagsModule.availableTags.push(data.tag);
          TagsModule.renderTagSelector();
          initTagFilter();
        } else {
          showToast(data.error || t('errors.creatingTag'), 'error');
        }
      } catch (e) {
        showToast(t('errors.creatingTag'), 'error');
      }
    },

    openCreator() {
      document.getElementById('importNewTagName').value = '';
      document.getElementById('importCustomTagColor').value = '#6366f1';
      this.selectColor('#6366f1');
      this.renderTagSuggestions();
      document.getElementById('importTagCreatorPopup').style.display = 'flex';
    },

    closeCreator() {
      document.getElementById('importTagCreatorPopup').style.display = 'none';
    },

    renderTagSuggestions(filter = '') {
      const container = document.getElementById('importTagSuggestions');
      if (!container) return;

      let availableToAdd = this.availableTags.filter(tag =>
        !this.selectedTags.find(t => t.id === tag.id)
      );

      if (filter) {
        const lowerFilter = filter.toLowerCase();
        availableToAdd = availableToAdd.filter(tag =>
          tag.name.toLowerCase().includes(lowerFilter)
        );
      }

      if (availableToAdd.length === 0) {
        container.innerHTML = filter
          ? `<div class="tag-suggestions-empty">${t('form.noMatchingTags')}</div>`
          : '';
        return;
      }

      container.innerHTML = availableToAdd.map(tag => `
        <button type="button" class="tag-suggestion" style="--tag-color: ${tag.color};"
          onclick="ImportTagsModule.addTag('${tag.id}')">
          <span class="badge-tag" style="background: ${tag.color};">${this.escapeHtml(tag.name)}</span>
        </button>
      `).join('');
    },

    filterSuggestions() {
      const input = document.getElementById('importNewTagName');
      this.renderTagSuggestions(input.value.trim());
    },

    escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
  };

  function openImportModal() {
    importPreviewData = null;
    document.getElementById('importStep1').style.display = 'block';
    document.getElementById('importStep2').style.display = 'none';
    document.getElementById('importLoading').style.display = 'none';
    document.getElementById('importError').style.display = 'none';
    document.getElementById('importPreviewBtn').style.display = 'inline-flex';
    document.getElementById('importBackBtn').style.display = 'none';
    document.getElementById('importConfirmBtn').style.display = 'none';
    document.getElementById('importSpecFile').value = '';
    document.getElementById('importSpecUrl').value = '';
    document.getElementById('importSpecContent').value = '';
    document.getElementById('importBasePath').value = '';
    // Initialize import tags module
    ImportTagsModule.clear();
    ImportTagsModule.init();
    $('#importOpenApiModal').modal('show');
  }

  async function previewImport() {
    const formData = new FormData();
    const fileInput = document.getElementById('importSpecFile');
    const contentInput = document.getElementById('importSpecContent');
    const urlInput = document.getElementById('importSpecUrl');
    const basePath = document.getElementById('importBasePath').value;
    const format = document.getElementById('importSpecFormat').value;

    const activeTab = document.querySelector('#importOpenApiModal .nav-link.active');
    const activeTarget = activeTab.getAttribute('data-bs-target');

    if (activeTarget === '#importTabFile' && fileInput.files.length > 0) {
      formData.append('specFile', fileInput.files[0]);
    } else if (activeTarget === '#importTabUrl' && urlInput.value.trim()) {
      formData.append('specUrl', urlInput.value.trim());
    } else if (activeTarget === '#importTabPaste' && contentInput.value.trim()) {
      formData.append('content', contentInput.value.trim());
      formData.append('format', format);
    } else {
      showImportError(t('import.noSpecProvided'));
      return;
    }

    formData.append('basePath', basePath);

    document.getElementById('importStep1').style.display = 'none';
    document.getElementById('importLoading').style.display = 'block';
    document.getElementById('importError').style.display = 'none';
    document.getElementById('importPreviewBtn').style.display = 'none';

    try {
      const response = await fetch('/api/import-openapi/preview', {
        method: 'POST',
        body: formData
      });
      const data = await response.json();

      if (!data.success) {
        showImportError(data.error);
        importGoBack();
        return;
      }

      importPreviewData = data;
      renderImportPreview(data);
    } catch (err) {
      showImportError(err.message);
      importGoBack();
    }
  }

  function renderImportPreview(data) {
    document.getElementById('importLoading').style.display = 'none';
    document.getElementById('importStep2').style.display = 'block';
    document.getElementById('importBackBtn').style.display = 'inline-flex';
    document.getElementById('importConfirmBtn').style.display = 'inline-flex';

    document.getElementById('importSpecTitle').textContent =
      `${data.specInfo.title} v${data.specInfo.version}`;
    document.getElementById('importSpecDetails').textContent =
      `${data.specInfo.format} | ${data.specInfo.pathCount} paths | ${data.specInfo.operationCount} operations`;

    const tbody = document.getElementById('importRoutesPreview');
    tbody.innerHTML = '';

    data.routes.forEach((route, index) => {
      const methodColors = {
        get: '#61affe', post: '#49cc90', put: '#fca130',
        delete: '#f93e3e', patch: '#50e3c2', options: '#0d5aa7', head: '#9012fe'
      };
      const color = methodColors[route.tipo] || '#999';

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input type="checkbox" class="import-route-check" data-index="${index}" checked onchange="updateImportCount()"></td>
        <td><span style="background: ${color}; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.75em; font-weight: 600;">${route.tipo.toUpperCase()}</span></td>
        <td><code style="font-size: 0.85em;">${escapeHtml(route.ruta)}</code>
          ${route.isRegex ? '<i class="fa fa-asterisk" style="color: var(--warning); font-size: 0.7em;" title="Regex"></i>' : ''}</td>
        <td>${route.codigo}</td>
        <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"
            title="${escapeHtml(route._summary || route._operationId || '')}">
          ${escapeHtml(route._summary || route._operationId || '-')}</td>
        <td>${route._conflict
          ? '<span style="background: var(--warning); color: #000; padding: 2px 8px; border-radius: 4px; font-size: 0.75em;">' + t('import.conflict') + '</span>'
          : '<span style="background: var(--success); color: #fff; padding: 2px 8px; border-radius: 4px; font-size: 0.75em;">' + t('import.new') + '</span>'
        }</td>
      `;
      tbody.appendChild(tr);
    });

    updateImportCount();
  }

  function toggleAllImportRoutes(checked) {
    document.querySelectorAll('.import-route-check').forEach(cb => cb.checked = checked);
    updateImportCount();
  }

  function updateImportCount() {
    const checked = document.querySelectorAll('.import-route-check:checked').length;
    const total = document.querySelectorAll('.import-route-check').length;
    document.getElementById('importSelectedCount').textContent = `(${checked}/${total})`;
  }

  function importGoBack() {
    document.getElementById('importStep1').style.display = 'block';
    document.getElementById('importStep2').style.display = 'none';
    document.getElementById('importLoading').style.display = 'none';
    document.getElementById('importPreviewBtn').style.display = 'inline-flex';
    document.getElementById('importBackBtn').style.display = 'none';
    document.getElementById('importConfirmBtn').style.display = 'none';
  }

  async function confirmImport() {
    if (!importPreviewData) return;

    const selectedRoutes = [];
    document.querySelectorAll('.import-route-check:checked').forEach(cb => {
      const index = parseInt(cb.dataset.index);
      const route = importPreviewData.routes[index];
      selectedRoutes.push({
        tipo: route.tipo,
        ruta: route.ruta,
        codigo: route.codigo,
        tiporespuesta: route.tiporespuesta,
        respuesta: route.respuesta,
        isRegex: route.isRegex,
        operationId: route.operationId,
        summary: route.summary,
        description: route.description,
        requestBodyExample: route.requestBodyExample,
        openApiTags: route.openApiTags
      });
    });

    if (selectedRoutes.length === 0) return;

    const conflictStrategy = document.getElementById('importConflictStrategy').value;
    const importTags = ImportTagsModule.getTags();
    const btn = document.getElementById('importConfirmBtn');
    btn.disabled = true;
    btn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> ' + t('import.importing');

    try {
      const response = await fetch('/api/import-openapi/confirm', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ routes: selectedRoutes, conflictStrategy, tags: importTags })
      });
      const data = await response.json();

      if (data.success) {
        tabla.ajax.reload();
        $('#importOpenApiModal').modal('hide');
        showToast(`${t('import.successMessage')}: ${data.imported} ${t('import.importedCount')}` +
          (data.skipped > 0 ? `, ${data.skipped} ${t('import.skippedCount')}` : ''), 'success');
      } else {
        showImportError(data.error);
      }
    } catch (err) {
      showImportError(err.message);
    } finally {
      btn.disabled = false;
      btn.innerHTML = '<i class="fa fa-download"></i> ' + t('import.importRoutes');
    }
  }

  function showImportError(message) {
    document.getElementById('importError').style.display = 'flex';
    document.getElementById('importErrorMsg').textContent = message;
  }

  function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // ===== REQUEST TESTER (Postman-like) =====
  let testerRowCounter = 0;
  const methodColors = {
    GET: 'badge-get',
    POST: 'badge-post',
    PUT: 'badge-put',
    DELETE: 'badge-delete',
    PATCH: 'badge-patch',
    OPTIONS: 'badge-options',
    HEAD: 'badge-head'
  };

  function regexToSampleUrl(regexPattern) {
    // Convert a regex pattern to a sample URL
    let sample = regexPattern;
    let paramCounter = 0;

    // Handle [^/]+ and [^/]* patterns - the most common path parameter regex
    // We need to look at the preceding path segment to name the parameter
    sample = sample.replace(/(\/[a-zA-Z0-9_-]+)\/\[\^\/\][\+\*]/g, (match, prevSegment) => {
      const segmentName = prevSegment.replace('/', '');
      paramCounter++;
      // Convert plural to singular for parameter name (e.g., /users/[^/]+ -> /users/{userId})
      if (/^[a-zA-Z]+s$/.test(segmentName)) {
        return `${prevSegment}/{${segmentName.slice(0, -1)}Id}`;
      } else if (/^[a-zA-Z]+$/.test(segmentName)) {
        return `${prevSegment}/{${segmentName}Id}`;
      }
      return `${prevSegment}/{param${paramCounter}}`;
    });

    // Handle remaining [^/]+ patterns without clear context
    sample = sample.replace(/\[\^\/\][\+\*]/g, () => {
      paramCounter++;
      return `{param${paramCounter}}`;
    });

    // Common regex pattern replacements for remaining patterns
    const replacements = [
      [/\(\?:[^)]+\)/g, ''],           // Remove non-capturing groups
      [/\([^)]+\)/g, 'value'],         // Replace capturing groups
      [/\\d\+/g, '123'],               // \d+ -> 123
      [/\\d\*/g, '12'],                // \d* -> 12
      [/\\d\{(\d+)\}/g, (m, n) => '1'.repeat(parseInt(n))], // \d{n} -> n digits
      [/\\d\{(\d+),(\d+)\}/g, (m, min) => '1'.repeat(parseInt(min))], // \d{n,m}
      [/\\d/g, '1'],                   // \d -> 1
      [/\\w\+/g, 'example'],           // \w+ -> example
      [/\\w\*/g, 'test'],              // \w* -> test
      [/\\w/g, 'x'],                   // \w -> x
      [/\\s\+/g, ' '],                 // \s+ -> space
      [/\\s\*/g, ''],                  // \s* -> empty
      [/\\s/g, ' '],                   // \s -> space
      [/\.\+/g, 'something'],          // .+ -> something
      [/\.\*/g, ''],                   // .* -> empty
      [/\[([^\]]+)\]/g, (m, chars) => chars.replace(/[^a-zA-Z0-9]/g, '')[0] || 'x'], // [abc] -> a (for remaining brackets)
      [/\{(\d+)\}/g, ''],              // Remove quantifiers like {2}
      [/\{(\d+),(\d+)?\}/g, ''],       // Remove quantifiers like {2,5}
      [/\+/g, ''],                     // Remove +
      [/\*/g, ''],                     // Remove *
      [/\?/g, ''],                     // Remove ?
      [/\^/g, ''],                     // Remove ^
      [/\$/g, ''],                     // Remove $
      [/\|[^/]*/g, ''],                // Remove alternations (keep first option)
      [/\\\//g, '/'],                  // \/ -> /
      [/\\\./g, '.'],                  // \. -> .
      [/\\-/g, '-'],                   // \- -> -
      [/\\_/g, '_'],                   // \_ -> _
      [/\\\\/g, ''],                   // Remove escaped backslashes
    ];

    for (const [pattern, replacement] of replacements) {
      sample = sample.replace(pattern, replacement);
    }

    // Clean up any remaining backslashes
    sample = sample.replace(/\\/g, '');

    // Clean up multiple consecutive slashes
    sample = sample.replace(/\/+/g, '/');

    // Ensure it starts with /
    if (!sample.startsWith('/')) {
      sample = '/' + sample;
    }

    // Remove trailing slash (unless it's the only character)
    if (sample.length > 1 && sample.endsWith('/')) {
      sample = sample.slice(0, -1);
    }

    return sample;
  }

  function openRequestTester(id) {
    const obj = Array.from(tabla.rows().data()).find(el => el.id === id);
    if (!obj) return;

    // Si es ruta GraphQL, abrir GraphiQL en lugar del tester normal
    if (obj.tiporespuesta === 'graphql') {
      openGraphiQLTester(obj);
      return;
    }

    // Reset form
    clearTesterForm();

    // Set method
    const method = obj.tipo.toUpperCase();
    document.getElementById('testerMethod').value = method === 'ANY' ? 'GET' : method;

    // Set URL
    const baseUrl = window.location.origin;
    let route = obj.ruta;
    if (obj.isRegex) {
      // For regex routes, convert to a sample URL
      route = regexToSampleUrl(route);
    }
    document.getElementById('testerUrl').value = baseUrl + route;

    // Pre-fill request body example if available (for POST, PUT, PATCH, DELETE)
    const methodsWithBody = ['POST', 'PUT', 'PATCH', 'DELETE'];
    if (methodsWithBody.includes(method) && obj.requestBodyExample) {
      // Set body type to JSON
      document.querySelector('input[name="bodyType"][value="json"]').checked = true;
      changeBodyType('json');
      // Set the body content
      document.getElementById('testerBodyJson').value = obj.requestBodyExample;
    }

    // Open modal
    const modal = new bootstrap.Modal(document.getElementById('requestTesterModal'));
    modal.show();
  }

  function clearTesterForm() {
    document.getElementById('testerMethod').value = 'GET';
    document.getElementById('testerUrl').value = '';
    document.getElementById('testerParamsContainer').innerHTML = '';
    document.getElementById('testerHeadersContainer').innerHTML = '';
    document.getElementById('testerFormContainer').innerHTML = '';
    document.getElementById('testerUrlencodedContainer').innerHTML = '';
    document.getElementById('testerBodyJson').value = '';
    document.getElementById('testerBodyRaw').value = '';
    document.querySelector('input[name="bodyType"][value="none"]').checked = true;
    changeBodyType('none');
    clearTesterResponse();
    updateTesterCounts();
    document.getElementById('noParamsMsg').style.display = 'block';
    document.getElementById('noHeadersTestMsg').style.display = 'block';
    document.getElementById('noFormMsg').style.display = 'block';
    document.getElementById('noUrlencodedMsg').style.display = 'block';
  }

  function clearTesterResponse() {
    document.getElementById('responseSection').style.display = 'none';
    document.getElementById('responseBody').textContent = '';
    document.getElementById('responseHeaders').innerHTML = '';
    document.getElementById('responseStatus').textContent = '';
    document.getElementById('responseTime').textContent = '';
    document.getElementById('responseSize').textContent = '';
  }

  function addTesterParam(key = '', value = '') {
    addTesterKeyValueRow('testerParamsContainer', 'param', key, value);
    document.getElementById('noParamsMsg').style.display = 'none';
    updateTesterCounts();
  }

  function addTesterHeader(key = '', value = '') {
    addTesterKeyValueRow('testerHeadersContainer', 'header', key, value);
    document.getElementById('noHeadersTestMsg').style.display = 'none';
    updateTesterCounts();
  }

  function addTesterFormField(key = '', value = '') {
    addTesterKeyValueRow('testerFormContainer', 'form', key, value);
    document.getElementById('noFormMsg').style.display = 'none';
  }

  function addTesterUrlencodedField(key = '', value = '') {
    addTesterKeyValueRow('testerUrlencodedContainer', 'urlencoded', key, value);
    document.getElementById('noUrlencodedMsg').style.display = 'none';
  }

  function addTesterKeyValueRow(containerId, type, key = '', value = '') {
    testerRowCounter++;
    const container = document.getElementById(containerId);
    const row = document.createElement('div');
    row.className = 'key-value-row';
    row.id = `tester-row-${testerRowCounter}`;
    row.innerHTML = `
      <input type="checkbox" class="key-value-check" checked>
      <input type="text" class="form-control-modern key-input" placeholder="${t('requestTester.key')}" value="${escapeHtml(key)}">
      <input type="text" class="form-control-modern value-input" placeholder="${t('requestTester.value')}" value="${escapeHtml(value)}">
      <button class="btn-icon btn-icon-danger" onclick="removeTesterRow(${testerRowCounter}, '${containerId}', '${type}')" title="${t('buttons.delete')}">
        <i class="fa fa-trash"></i>
      </button>
    `;
    container.appendChild(row);
  }

  function removeTesterRow(id, containerId, type) {
    document.getElementById(`tester-row-${id}`)?.remove();
    const container = document.getElementById(containerId);
    if (container.children.length === 0) {
      if (type === 'param') document.getElementById('noParamsMsg').style.display = 'block';
      if (type === 'header') document.getElementById('noHeadersTestMsg').style.display = 'block';
      if (type === 'form') document.getElementById('noFormMsg').style.display = 'block';
      if (type === 'urlencoded') document.getElementById('noUrlencodedMsg').style.display = 'block';
    }
    updateTesterCounts();
  }

  function updateTesterCounts() {
    const paramsCount = document.querySelectorAll('#testerParamsContainer .key-value-row').length;
    const headersCount = document.querySelectorAll('#testerHeadersContainer .key-value-row').length;
    document.getElementById('paramsCount').textContent = paramsCount;
    document.getElementById('headersCount').textContent = headersCount;
  }

  function changeBodyType(type) {
    ['bodyNone', 'bodyJson', 'bodyForm', 'bodyUrlencoded', 'bodyRaw'].forEach(id => {
      document.getElementById(id).style.display = 'none';
    });
    document.getElementById('body' + type.charAt(0).toUpperCase() + type.slice(1)).style.display = 'block';
  }

  function formatTesterJson() {
    const textarea = document.getElementById('testerBodyJson');
    try {
      const parsed = JSON.parse(textarea.value);
      textarea.value = JSON.stringify(parsed, null, 2);
    } catch (e) {
      showToast(t('validation.jsonInvalid'), 'error');
    }
  }

  function getKeyValuePairs(containerId) {
    const pairs = {};
    document.querySelectorAll(`#${containerId} .key-value-row`).forEach(row => {
      const checked = row.querySelector('.key-value-check').checked;
      if (!checked) return;
      const key = row.querySelector('.key-input').value.trim();
      const value = row.querySelector('.value-input').value;
      if (key) pairs[key] = value;
    });
    return pairs;
  }

  async function sendTestRequest() {
    const method = document.getElementById('testerMethod').value;
    let url = document.getElementById('testerUrl').value.trim();

    if (!url) {
      showToast(t('requestTester.urlRequired'), 'error');
      return;
    }

    // Add query params to URL
    const params = getKeyValuePairs('testerParamsContainer');
    if (Object.keys(params).length > 0) {
      const urlObj = new URL(url);
      Object.entries(params).forEach(([k, v]) => urlObj.searchParams.append(k, v));
      url = urlObj.toString();
    }

    // Build headers
    const headers = getKeyValuePairs('testerHeadersContainer');

    // Add cache-busting headers to prevent 304 responses
    headers['Cache-Control'] = 'no-cache, no-store, must-revalidate';
    headers['Pragma'] = 'no-cache';
    headers['X-Request-Time'] = Date.now().toString();

    // Build body
    let body = null;
    const bodyType = document.querySelector('input[name="bodyType"]:checked').value;

    if (method !== 'GET' && method !== 'HEAD') {
      if (bodyType === 'json') {
        const jsonBody = document.getElementById('testerBodyJson').value.trim();
        if (jsonBody) {
          body = jsonBody;
          if (!headers['Content-Type']) headers['Content-Type'] = 'application/json';
        }
      } else if (bodyType === 'form') {
        const formData = new FormData();
        document.querySelectorAll('#testerFormContainer .key-value-row').forEach(row => {
          if (!row.querySelector('.key-value-check').checked) return;
          const key = row.querySelector('.key-input').value.trim();
          const value = row.querySelector('.value-input').value;
          if (key) formData.append(key, value);
        });
        body = formData;
        // Don't set Content-Type for FormData, browser will set it with boundary
      } else if (bodyType === 'urlencoded') {
        const urlParams = new URLSearchParams();
        document.querySelectorAll('#testerUrlencodedContainer .key-value-row').forEach(row => {
          if (!row.querySelector('.key-value-check').checked) return;
          const key = row.querySelector('.key-input').value.trim();
          const value = row.querySelector('.value-input').value;
          if (key) urlParams.append(key, value);
        });
        body = urlParams.toString();
        if (!headers['Content-Type']) headers['Content-Type'] = 'application/x-www-form-urlencoded';
      } else if (bodyType === 'raw') {
        body = document.getElementById('testerBodyRaw').value;
      }
    }

    // Show loading
    document.getElementById('requestLoading').style.display = 'flex';
    document.getElementById('responseSection').style.display = 'none';
    document.getElementById('testerSendBtn').disabled = true;

    const startTime = performance.now();

    try {
      const fetchOptions = { method, headers };
      if (body && method !== 'GET' && method !== 'HEAD') {
        fetchOptions.body = body;
      }

      const response = await fetch(url, fetchOptions);
      const endTime = performance.now();
      const duration = Math.round(endTime - startTime);

      // Get response body
      const contentType = response.headers.get('content-type') || '';
      let responseText = await response.text();
      let responseSize = new Blob([responseText]).size;

      // Try to format JSON
      if (contentType.includes('json')) {
        try {
          responseText = JSON.stringify(JSON.parse(responseText), null, 2);
        } catch (e) {}
      }

      // Update response UI
      document.getElementById('responseSection').style.display = 'block';
      document.getElementById('responseBody').textContent = responseText;

      // Status badge
      const statusEl = document.getElementById('responseStatus');
      statusEl.textContent = `${response.status} ${response.statusText}`;
      statusEl.className = 'response-status ' + (response.ok ? 'status-success' : response.status >= 400 ? 'status-error' : 'status-warning');

      // Time and size
      document.getElementById('responseTime').textContent = `${duration}ms`;
      document.getElementById('responseSize').textContent = formatBytes(responseSize);

      // Headers
      const headersHtml = [];
      response.headers.forEach((value, key) => {
        headersHtml.push(`<div class="response-header-row"><span class="header-key">${escapeHtml(key)}:</span> <span class="header-value">${escapeHtml(value)}</span></div>`);
      });
      document.getElementById('responseHeaders').innerHTML = headersHtml.join('');

    } catch (e) {
      document.getElementById('responseSection').style.display = 'block';
      document.getElementById('responseBody').textContent = `Error: ${e.message}`;
      document.getElementById('responseStatus').textContent = 'Error';
      document.getElementById('responseStatus').className = 'response-status status-error';
      document.getElementById('responseTime').textContent = '';
      document.getElementById('responseSize').textContent = '';
      document.getElementById('responseHeaders').innerHTML = '';
    }

    document.getElementById('requestLoading').style.display = 'none';
    document.getElementById('testerSendBtn').disabled = false;
  }

  function formatBytes(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
  }

  // Initialize tooltips
  var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
  tooltipTriggerList.map(el => new bootstrap.Tooltip(el));

  // ===== EXPORT/IMPORT MODULE =====
  let currentImportSource = 'file';

  function openExportImportModal() {
    // Reset to export tab
    const exportTab = document.getElementById('export-tab');
    const exportPane = document.getElementById('exportPane');
    const importTab = document.getElementById('import-tab');
    const importPane = document.getElementById('importPane');

    exportTab.classList.add('active');
    importTab.classList.remove('active');
    exportPane.classList.add('show', 'active');
    importPane.classList.remove('show', 'active');

    // Load export preview
    loadExportPreview();

    // Reset import form
    resetImportForm();
    switchImportSource('file');

    $('#exportImportModal').modal('show');
  }

  function resetImportForm() {
    document.getElementById('importFile').value = '';
    document.getElementById('importFileInfo').style.display = 'none';
    document.getElementById('importResults').style.display = 'none';
    document.getElementById('importBtn').disabled = true;
    document.getElementById('gitRepoUrl').value = '';
    document.getElementById('gitBranch').value = '';
    document.getElementById('gitCommit').value = '';
    document.getElementById('gitSshKey').value = '';
  }

  function switchImportSource(source) {
    currentImportSource = source;

    // Update tabs
    document.querySelectorAll('.import-source-tab').forEach(tab => {
      tab.classList.toggle('active', tab.dataset.source === source);
    });

    // Update content visibility
    document.getElementById('importSourceFile').style.display = source === 'file' ? 'block' : 'none';
    document.getElementById('importSourceGit').style.display = source === 'git' ? 'block' : 'none';
    document.getElementById('importSourceDirectory').style.display = source === 'directory' ? 'block' : 'none';

    // Hide files option for directory import (files are always imported from directory)
    document.getElementById('importFilesOption').style.display = source === 'directory' ? 'none' : 'block';

    // Update import button state
    updateImportButtonState();

    // Load directory files if that source is selected
    if (source === 'directory') {
      loadDirectoryFiles();
    }

    // Hide previous results
    document.getElementById('importResults').style.display = 'none';
  }

  function updateImportButtonState() {
    const importBtn = document.getElementById('importBtn');

    if (currentImportSource === 'file') {
      const file = document.getElementById('importFile').files[0];
      importBtn.disabled = !file;
    } else if (currentImportSource === 'git') {
      const repoUrl = document.getElementById('gitRepoUrl').value.trim();
      importBtn.disabled = !repoUrl;
    } else if (currentImportSource === 'directory') {
      // Check if there are files in the directory
      const filesList = document.getElementById('directoryFilesList');
      const hasFiles = filesList.querySelectorAll('.directory-file-item').length > 0;
      importBtn.disabled = !hasFiles;
    }
  }

  async function loadDirectoryFiles() {
    const listEl = document.getElementById('directoryFilesList');
    listEl.innerHTML = `<div class="directory-loading"><i class="fa fa-spinner fa-spin"></i> ${t('exportImport.loading')}</div>`;

    try {
      const response = await fetch('/api/import/directory');
      const data = await response.json();

      if (data.success) {
        if (data.files.length === 0) {
          listEl.innerHTML = `
            <div class="directory-path">${t('exportImport.directoryPath')}: <code>${data.directory}</code></div>
            <div class="directory-empty">${t('exportImport.noFilesInDirectory')}</div>
          `;
        } else {
          listEl.innerHTML = `
            <div class="directory-path">${t('exportImport.directoryPath')}: <code>${data.directory}</code></div>
            ${data.files.map(file => `
              <div class="directory-file-item">
                <i class="fa fa-file-archive-o"></i>
                <span class="file-name">${escapeHtml(file.path)}</span>
                <span class="file-size">${file.sizeFormatted}</span>
              </div>
            `).join('')}
          `;
        }
        updateImportButtonState();
      } else {
        listEl.innerHTML = `<div class="directory-empty">${data.error || 'Error loading directory'}</div>`;
      }
    } catch (e) {
      listEl.innerHTML = `<div class="directory-empty">${e.message}</div>`;
    }
  }

  async function loadExportPreview() {
    const previewEl = document.getElementById('exportPreview');
    previewEl.innerHTML = `<div class="export-preview-loading"><i class="fa fa-spinner fa-spin"></i> ${t('exportImport.loading')}</div>`;

    try {
      const response = await fetch('/api/export/preview');
      const data = await response.json();

      if (data.success) {
        previewEl.innerHTML = `
          <div class="export-stats">
            <div class="export-stat">
              <div class="export-stat-value">${data.stats.routes}</div>
              <div class="export-stat-label">${t('exportImport.routes')}</div>
            </div>
            <div class="export-stat">
              <div class="export-stat-value">${data.stats.tags}</div>
              <div class="export-stat-label">${t('exportImport.tags')}</div>
            </div>
            <div class="export-stat">
              <div class="export-stat-value">${data.stats.conditions}</div>
              <div class="export-stat-label">${t('exportImport.conditions')}</div>
            </div>
            <div class="export-stat">
              <div class="export-stat-value">${data.stats.files}</div>
              <div class="export-stat-label">${t('exportImport.files')}</div>
            </div>
          </div>
        `;
      } else {
        previewEl.innerHTML = `<div class="alert-modern alert-modern-warning">${data.error || 'Error loading preview'}</div>`;
      }
    } catch (e) {
      previewEl.innerHTML = `<div class="alert-modern alert-modern-warning">${e.message}</div>`;
    }
  }

  async function performExport() {
    const format = document.querySelector('input[name="exportFormat"]:checked').value;
    const includeFiles = document.getElementById('includeFiles').checked;

    // Create download link with query parameters
    const url = `/api/export?format=${format}&includeFiles=${includeFiles}`;

    // Trigger download
    const a = document.createElement('a');
    a.href = url;
    a.download = `mock-server-export-${new Date().toISOString().slice(0, 10)}.zip`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
  }

  function handleImportFileSelect(event) {
    const file = event.target.files[0];
    const fileInfo = document.getElementById('importFileInfo');

    if (file) {
      document.getElementById('importFileName').textContent = file.name;
      document.getElementById('importFileSize').textContent = formatBytes(file.size);
      fileInfo.style.display = 'flex';
    } else {
      fileInfo.style.display = 'none';
    }

    updateImportButtonState();

    // Hide previous results
    document.getElementById('importResults').style.display = 'none';
  }

  // Add input listener for git repo URL
  document.addEventListener('DOMContentLoaded', function() {
    const gitRepoUrl = document.getElementById('gitRepoUrl');
    if (gitRepoUrl) {
      gitRepoUrl.addEventListener('input', updateImportButtonState);
    }
  });

  async function performImport() {
    const importBtn = document.getElementById('importBtn');
    const originalText = importBtn.innerHTML;
    importBtn.disabled = true;
    importBtn.innerHTML = `<i class="fa fa-spinner fa-spin"></i> ${t('exportImport.importing')}`;

    const conflictStrategy = document.getElementById('importConflictStrategy').value;

    try {
      let response;
      let data;

      if (currentImportSource === 'file') {
        const fileInput = document.getElementById('importFile');
        const file = fileInput.files[0];

        if (!file) {
          showToast(t('exportImport.selectFileRequired'), 'warning');
          importBtn.innerHTML = originalText;
          importBtn.disabled = false;
          return;
        }

        const importFiles = document.getElementById('importFilesCheck').checked;
        const formData = new FormData();
        formData.append('file', file);
        formData.append('conflictStrategy', conflictStrategy);
        formData.append('importFiles', importFiles);

        response = await fetch('/api/import', {
          method: 'POST',
          body: formData
        });
        data = await response.json();

      } else if (currentImportSource === 'git') {
        const repoUrl = document.getElementById('gitRepoUrl').value.trim();
        const branch = document.getElementById('gitBranch').value.trim();
        const commit = document.getElementById('gitCommit').value.trim();
        const sshKey = document.getElementById('gitSshKey').value.trim();

        if (!repoUrl) {
          showToast(t('exportImport.gitRepoUrlRequired'), 'warning');
          importBtn.innerHTML = originalText;
          importBtn.disabled = false;
          return;
        }

        response = await fetch('/api/import/git', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            repoUrl,
            branch: branch || null,
            commit: commit || null,
            sshKey: sshKey || null,
            conflictStrategy
          })
        });
        data = await response.json();

      } else if (currentImportSource === 'directory') {
        response = await fetch('/api/import/directory', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ conflictStrategy })
        });
        data = await response.json();
      }

      const resultsEl = document.getElementById('importResults');
      resultsEl.style.display = 'block';

      if (data.success) {
        let resultsHtml = '';

        if (currentImportSource === 'file') {
          resultsHtml = `
            <strong>${t('exportImport.routes')}:</strong> ${data.results.routes?.imported || 0} ${t('exportImport.created')}, ${data.results.routes?.updated || 0} ${t('exportImport.updated')}, ${data.results.routes?.skipped || 0} ${t('exportImport.skipped')}<br>
            <strong>${t('exportImport.tags')}:</strong> ${data.results.tags?.imported || 0} ${t('exportImport.created')}, ${data.results.tags?.skipped || 0} ${t('exportImport.skipped')}<br>
            <strong>${t('exportImport.conditions')}:</strong> ${data.results.conditions?.imported || 0} ${t('exportImport.created')}<br>
            <strong>${t('exportImport.files')}:</strong> ${data.results.files?.imported || 0} ${t('exportImport.imported')}
          `;
        } else {
          resultsHtml = `${t('exportImport.filesImported')}: ${data.results?.imported || 0}`;
          if (data.results?.errors?.length > 0) {
            resultsHtml += `<br>${t('exportImport.errors')}: ${data.results.errors.length}`;
          }
        }

        resultsEl.innerHTML = `
          <div class="alert-modern alert-modern-success">
            <i class="fa fa-check-circle alert-icon"></i>
            <div class="alert-content">
              <div class="alert-title">${t('exportImport.importSuccess')}</div>
              <div class="alert-text">${resultsHtml}</div>
            </div>
          </div>
        `;

        // Reload page after a short delay to show results
        setTimeout(() => {
          window.location.reload();
        }, 2000);
      } else {
        resultsEl.innerHTML = `
          <div class="alert-modern alert-modern-error">
            <i class="fa fa-times-circle alert-icon"></i>
            <div class="alert-content">
              <div class="alert-title">${t('exportImport.importError')}</div>
              <div class="alert-text">${data.error || 'Unknown error'}</div>
            </div>
          </div>
        `;
      }
    } catch (e) {
      document.getElementById('importResults').innerHTML = `
        <div class="alert-modern alert-modern-error">
          <i class="fa fa-times-circle alert-icon"></i>
          <div class="alert-content">
            <div class="alert-title">${t('exportImport.importError')}</div>
            <div class="alert-text">${e.message}</div>
          </div>
        </div>
      `;
      document.getElementById('importResults').style.display = 'block';
    }

    importBtn.innerHTML = originalText;
    importBtn.disabled = false;
  }
</script>
