<div class="main-container">
  <!-- Routes Card -->
  <div class="card-modern animate-fade-in">
    <div class="card-header-modern">
      <h2><i class="fa fa-sitemap"></i> <%= __('routes.title') %></h2>
      <div class="d-flex gap-2">
        <button type="button" class="btn-modern btn-modern-danger" id="bulkDeleteBtn" onclick="openBulkDeleteModal()" style="display: none;">
          <i class="fa fa-trash"></i> <span id="bulkDeleteCount"></span>
        </button>
        <div class="dropdown-modern">
          <button type="button" class="btn-modern btn-modern-secondary dropdown-toggle" onclick="toggleToolsDropdown()">
            <i class="fa fa-cog"></i> <%= __('routes.tools') %>
          </button>
          <div class="dropdown-menu-modern" id="toolsDropdownMenu">
            <button type="button" class="dropdown-item-modern" onclick="normalizeOrder(); closeToolsDropdown();">
              <i class="fa fa-sort-numeric-asc"></i> <%= __('routes.normalize') %>
            </button>
            <button type="button" class="dropdown-item-modern" onclick="openTagManager(); closeToolsDropdown();">
              <i class="fa fa-tags"></i> <%= __('form.manageTags') %>
            </button>
          </div>
        </div>
        <button type="button" class="btn-modern btn-modern-secondary" onclick="openList()" style="position: relative;">
          <i class="fa fa-list"></i> <%= __('routes.pendingList') %>
          <% if (listaEspera.length > 0) { %>
          <span id="pendingBadge" class="pending-badge"><%=listaEspera.length %></span>
          <% } else { %>
          <span id="pendingBadge" class="pending-badge" style="display: none;">0</span>
          <% } %>
        </button>
        <button type="button" class="btn-modern btn-modern-secondary" onclick="openImportModal()">
          <i class="fa fa-upload"></i> <%= __('routes.importOpenApi') %>
        </button>
        <button type="button" class="btn-modern btn-modern-primary" onclick="openModal('create')">
          <i class="fa fa-plus"></i> <%= __('routes.newRoute') %>
        </button>
      </div>
    </div>
    <div class="card-body-modern">
      <!-- Filtros de tabla -->
      <div class="table-filters">
        <div class="filter-group">
          <label class="filter-label" for="filterMethod"><%= __('filters.method') %></label>
          <select id="filterMethod" name="filterMethod" class="filter-select" onchange="applyFilters()">
            <option value=""><%= __('filters.all') %></option>
            <option value="get">GET</option>
            <option value="post">POST</option>
            <option value="put">PUT</option>
            <option value="delete">DELETE</option>
            <option value="patch">PATCH</option>
            <option value="options">OPTIONS</option>
            <option value="head">HEAD</option>
            <option value="any">ANY</option>
          </select>
        </div>
        <div class="filter-group filter-group-large">
          <label class="filter-label" for="filterRouteValue"><%= __('filters.route') %></label>
          <div class="filter-route-wrapper">
            <select id="filterRouteType" name="filterRouteType" class="filter-select filter-route-type" onchange="applyFilters()">
              <option value="contains"><%= __('filters.contains') %></option>
              <option value="startsWith"><%= __('filters.startsWith') %></option>
              <option value="endsWith"><%= __('filters.endsWith') %></option>
              <option value="equals"><%= __('filters.equals') %></option>
              <option value="regex"><%= __('filters.regexOption') %></option>
            </select>
            <input type="text" id="filterRouteValue" name="filterRouteValue" class="filter-input" placeholder="<%= __('filters.searchRoute') %>" oninput="applyFilters()">
          </div>
        </div>
        <div class="filter-group">
          <label class="filter-label" for="filterType"><%= __('filters.responseType') %></label>
          <select id="filterType" name="filterType" class="filter-select" onchange="applyFilters()">
            <option value=""><%= __('filters.all') %></option>
            <option value="json">JSON</option>
            <option value="xml">XML</option>
            <option value="soap">SOAP</option>
            <option value="text">Texto</option>
            <option value="html">HTML</option>
            <option value="page">Page</option>
            <option value="file">Archivo</option>
            <option value="proxy">Proxy</option>
            <option value="empty">Empty</option>
          </select>
        </div>
        <div class="filter-group">
          <label class="filter-label" for="filterCode"><%= __('filters.code') %></label>
          <select id="filterCode" name="filterCode" class="filter-select" onchange="applyFilters()">
            <option value=""><%= __('filters.all') %></option>
            <option value="2xx"><%= __('filters.success2xx') %></option>
            <option value="3xx"><%= __('filters.redirect3xx') %></option>
            <option value="4xx"><%= __('filters.clientError4xx') %></option>
            <option value="5xx"><%= __('filters.serverError5xx') %></option>
          </select>
        </div>
        <div class="filter-group">
          <label class="filter-label" for="filterRegex"><%= __('filters.regex') %></label>
          <select id="filterRegex" name="filterRegex" class="filter-select" onchange="applyFilters()">
            <option value=""><%= __('filters.all') %></option>
            <option value="1"><%= __('filters.yes') %></option>
            <option value="0"><%= __('filters.no') %></option>
          </select>
        </div>
        <div class="filter-group">
          <label class="filter-label" for="filterWait"><%= __('filters.wait') %></label>
          <select id="filterWait" name="filterWait" class="filter-select" onchange="applyFilters()">
            <option value=""><%= __('filters.all') %></option>
            <option value="1"><%= __('filters.yes') %></option>
            <option value="0"><%= __('filters.no') %></option>
          </select>
        </div>
        <div class="filter-group">
          <label class="filter-label" for="filterActivo"><%= __('filters.active') %></label>
          <select id="filterActivo" name="filterActivo" class="filter-select" onchange="applyFilters()">
            <option value=""><%= __('filters.all') %></option>
            <option value="1"><%= __('filters.yes') %></option>
            <option value="0"><%= __('filters.no') %></option>
          </select>
        </div>
        <div class="filter-group">
          <label class="filter-label"><%= __('filters.tags') %></label>
          <div class="tags-filter-dropdown" id="tagsFilterDropdown">
            <button type="button" class="tags-filter-button" onclick="toggleTagsFilterDropdown()">
              <span id="tagsFilterLabel"><%= __('filters.all') %></span>
              <i class="fa fa-chevron-down"></i>
            </button>
            <div class="tags-filter-menu" id="tagsFilterMenu">
              <!-- Options populated by JS -->
            </div>
          </div>
        </div>
        <div class="filter-group filter-actions">
          <button class="btn-filter-clear" onclick="clearFilters()" title="<%= __('filters.clear') %>">
            <i class="fa fa-times"></i> <%= __('filters.clear') %>
          </button>
        </div>
      </div>

      <div class="table-modern-wrapper">
        <table id="dtList" class="table-modern" style="width:100%">
          <thead>
            <tr>
              <th><%= __('table.id') %></th>
              <th><input type="checkbox" id="selectAllRoutes" onchange="toggleSelectAllRoutes(this.checked)" title="<%= __('bulk.selectAll') %>"></th>
              <th><%= __('table.order') %></th>
              <th><%= __('table.method') %></th>
              <th><%= __('table.route') %></th>
              <th><%= __('table.type') %></th>
              <th><%= __('table.code') %></th>
              <th><%= __('table.regex') %></th>
              <th><%= __('table.wait') %></th>
              <th><%= __('table.active') %></th>
              <th><%= __('table.actions') %></th>
            </tr>
          </thead>
          <tbody>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Terminal Card -->
  <div class="card-modern animate-fade-in" style="margin-top: 2rem;">
    <div class="card-body terminal" style="height: 650px; padding: 0; border-radius: var(--border-radius);">
      <div class="terminal-header">
        <div class="dots">
          <span class="dot red"></span>
          <span class="dot yellow"></span>
          <span class="dot green"></span>
        </div>
        <span class="title"><%= __('terminal.title') %></span>
        <div class="terminal-actions">
          <button onclick="Terminal.clear()" title="<%= __('terminal.clearTitle') %>">
            <i class="fa fa-trash"></i> <%= __('buttons.clear') %>
          </button>
          <button onclick="Terminal.toggleAutoScroll()" id="btnAutoScroll" title="<%= __('terminal.autoScrollTitle') %>">
            <i class="fa fa-arrow-down"></i> <%= __('buttons.auto') %>
          </button>
          <button onclick="Terminal.exportLogs()" title="<%= __('terminal.exportTitle') %>">
            <i class="fa fa-download"></i> <%= __('buttons.export') %>
          </button>
        </div>
      </div>
      <div class="console">
        <div class="output" id="salidaconsola">
        </div>
      </div>
    </div>
  </div>
</div>

<%- include('modals/import-openapi') %>

<%- include('modals/route-form') %>

<%- include('modals/pending-list') %>

<%- include('modals/curl-example') %>
<%- include('modals/delete') %>
<%- include('modals/bulk-delete') %>
<%- include('modals/connection') %>
<%- include('modals/duplicate') %>
<%- include('modals/criteria-help') %>
<%- include('modals/request-tester') %>
<%- include('modals/tag-manager') %>

<script src="/js/socket.io.js"></script>

<script>
  let totalPending = Number('<%=listaEspera.length %>');
  // Socket.io usa el mismo puerto que la web
  const socket = io();

  // ===== TERMINAL MODULE =====
  const Terminal = {
    container: null,
    autoScroll: true,
    logs: [],
    maxLogs: 1000,

    init() {
      this.container = document.getElementById("salidaconsola");
      this.updateAutoScrollButton();
    },

    addEntry(data) {
      const entry = document.createElement('div');
      entry.className = `log-entry ${data.type || 'info'}`;

      let message = data.texto || data;
      let timestamp = '';

      const timestampMatch = message.match(/^\[(\d{2}:\d{2}:\d{2}\.\d{3})\]\s*/);
      if (timestampMatch) {
        timestamp = timestampMatch[1];
        message = message.replace(timestampMatch[0], '');
      }

      // Si es un log colapsable (proxy detallado)
      if (data.collapsible && data.details) {
        const detailsId = 'proxy-details-' + Date.now();
        entry.classList.add('log-collapsible');
        entry.innerHTML = `
          ${timestamp ? `<span class="timestamp">${timestamp}</span>` : ''}
          <span class="message">${this.escapeHtml(message)}</span>
          <button class="log-toggle-btn" onclick="Terminal.toggleDetails('${detailsId}')" title="Ver detalles">
            <i class="fa fa-chevron-down"></i>
          </button>
          <div id="${detailsId}" class="log-details" style="display: none;">
            ${this.renderProxyDetails(data.details)}
          </div>
        `;
      } else {
        entry.innerHTML = `
          ${timestamp ? `<span class="timestamp">${timestamp}</span>` : ''}
          <span class="message">${this.escapeHtml(message)}</span>
        `;
      }

      this.container.appendChild(entry);
      this.logs.push({ timestamp: new Date(), type: data.type, message, details: data.details });

      if (this.logs.length > this.maxLogs) {
        this.logs.shift();
        if (this.container.firstChild) {
          this.container.removeChild(this.container.firstChild);
        }
      }

      if (this.autoScroll) {
        this.scrollToBottom();
      }
    },

    toggleDetails(id) {
      const details = document.getElementById(id);
      const btn = details.previousElementSibling;
      if (details.style.display === 'none') {
        details.style.display = 'block';
        btn.innerHTML = '<i class="fa fa-chevron-up"></i>';
        btn.classList.add('active');
      } else {
        details.style.display = 'none';
        btn.innerHTML = '<i class="fa fa-chevron-down"></i>';
        btn.classList.remove('active');
      }
    },

    renderProxyDetails(details) {
      const { request, response } = details;
      return `
        <div class="proxy-details-container">
          <div class="proxy-details-section">
            <div class="proxy-details-header" onclick="this.parentElement.classList.toggle('expanded')">
              <i class="fa fa-arrow-up"></i> Outgoing Request
              <i class="fa fa-chevron-right toggle-icon"></i>
            </div>
            <div class="proxy-details-content">
              <div class="proxy-details-row">
                <span class="proxy-details-label">URL:</span>
                <code class="proxy-details-value">${this.escapeHtml(request.target || request.url)}</code>
              </div>
              <div class="proxy-details-row">
                <span class="proxy-details-label">Method:</span>
                <span class="proxy-details-value">${request.method}</span>
              </div>
              <div class="proxy-details-subsection">
                <div class="proxy-details-subheader" onclick="this.parentElement.classList.toggle('expanded')">
                  <i class="fa fa-list"></i> Headers
                  <i class="fa fa-chevron-right toggle-icon"></i>
                </div>
                <div class="proxy-details-subcontent">
                  <pre class="proxy-details-pre">${this.escapeHtml(JSON.stringify(request.headers, null, 2))}</pre>
                </div>
              </div>
              ${request.body ? `
              <div class="proxy-details-subsection">
                <div class="proxy-details-subheader" onclick="this.parentElement.classList.toggle('expanded')">
                  <i class="fa fa-file-text-o"></i> Body
                  <i class="fa fa-chevron-right toggle-icon"></i>
                </div>
                <div class="proxy-details-subcontent">
                  <pre class="proxy-details-pre">${this.escapeHtml(typeof request.body === 'object' ? JSON.stringify(request.body, null, 2) : request.body)}</pre>
                </div>
              </div>
              ` : ''}
            </div>
          </div>
          <div class="proxy-details-section">
            <div class="proxy-details-header" onclick="this.parentElement.classList.toggle('expanded')">
              <i class="fa fa-arrow-down"></i> Incoming Response
              <span class="proxy-status-badge status-${Math.floor(response.statusCode / 100)}xx">${response.statusCode}</span>
              <i class="fa fa-chevron-right toggle-icon"></i>
            </div>
            <div class="proxy-details-content">
              <div class="proxy-details-subsection">
                <div class="proxy-details-subheader" onclick="this.parentElement.classList.toggle('expanded')">
                  <i class="fa fa-list"></i> Headers
                  <i class="fa fa-chevron-right toggle-icon"></i>
                </div>
                <div class="proxy-details-subcontent">
                  <pre class="proxy-details-pre">${this.escapeHtml(JSON.stringify(response.headers, null, 2))}</pre>
                </div>
              </div>
              ${response.body ? `
              <div class="proxy-details-subsection">
                <div class="proxy-details-subheader" onclick="this.parentElement.classList.toggle('expanded')">
                  <i class="fa fa-file-text-o"></i> Body ${response.body.truncated ? '<span class="truncated-badge">(truncado)</span>' : ''}
                  <i class="fa fa-chevron-right toggle-icon"></i>
                </div>
                <div class="proxy-details-subcontent">
                  <pre class="proxy-details-pre ${response.body.type === 'json' ? 'json-body' : ''}">${this.escapeHtml(
                    response.body.type === 'json'
                      ? JSON.stringify(response.body.data, null, 2)
                      : (response.body.data || '')
                  )}</pre>
                </div>
              </div>
              ` : ''}
            </div>
          </div>
        </div>
      `;
    },

    clear() {
      this.container.innerHTML = '';
      this.logs = [];
      this.addEntry({ texto: t('terminal.cleared'), type: 'info' });
    },

    toggleAutoScroll() {
      this.autoScroll = !this.autoScroll;
      this.updateAutoScrollButton();
      if (this.autoScroll) {
        this.scrollToBottom();
      }
    },

    updateAutoScrollButton() {
      const btn = document.getElementById('btnAutoScroll');
      if (btn) {
        btn.style.background = this.autoScroll ? 'rgba(39, 202, 64, 0.3)' : 'rgba(255, 255, 255, 0.1)';
      }
    },

    scrollToBottom() {
      const consoleEl = this.container.parentElement;
      consoleEl.scrollTo({ top: consoleEl.scrollHeight, behavior: 'smooth' });
    },

    exportLogs() {
      const content = this.logs.map(l =>
        `[${l.timestamp.toISOString()}] [${l.type}] ${l.message}`
      ).join('\n');

      const blob = new Blob([content], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `mockserver-logs-${new Date().toISOString().slice(0,10)}.txt`;
      a.click();
      URL.revokeObjectURL(url);
    },

    escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
  };

  document.addEventListener('DOMContentLoaded', () => Terminal.init());

  // ===== CONNECTION METRICS MODULE =====
  const ConnectionMetrics = {
    status: 'disconnected',
    connectedSince: null,
    messagesReceived: 0,
    messagesSent: 0,
    consoleEvents: 0,
    reconnects: 0,
    lastReconnect: null,
    latency: null,
    pingInterval: null,
    durationInterval: null,

    init() {
      this.startPingInterval();
    },

    startPingInterval() {
      // Medir latencia cada 5 segundos
      this.pingInterval = setInterval(() => {
        if (this.status === 'connected') {
          const start = Date.now();
          socket.emit('ping', () => {
            this.latency = Date.now() - start;
            this.updateModalLatency();
          });
        }
      }, 5000);

      // Actualizar duración cada segundo
      this.durationInterval = setInterval(() => {
        this.updateModalDuration();
      }, 1000);
    },

    setStatus(status) {
      this.status = status;
      if (status === 'connected' && !this.connectedSince) {
        this.connectedSince = new Date();
      } else if (status === 'disconnected') {
        this.connectedSince = null;
        this.latency = null;
      }
      this.updateNavbarStatus();
      this.updateModalStatus();
    },

    incrementReceived() {
      this.messagesReceived++;
      this.updateElement('connMsgReceived', this.messagesReceived);
    },

    incrementSent() {
      this.messagesSent++;
      this.updateElement('connMsgSent', this.messagesSent);
    },

    incrementConsoleEvents() {
      this.consoleEvents++;
      this.updateElement('connConsoleEvents', this.consoleEvents);
    },

    incrementReconnects() {
      this.reconnects++;
      this.lastReconnect = new Date();
      this.updateElement('connReconnects', this.reconnects);
      this.updateElement('connLastReconnect', this.formatTime(this.lastReconnect));
    },

    updateNavbarStatus() {
      const statusDot = document.getElementById('statusDot');
      const statusText = document.getElementById('statusText');
      const serverStatus = document.getElementById('serverStatus');

      if (!statusDot || !statusText) return;

      serverStatus.classList.remove('status-connected', 'status-disconnected', 'status-reconnecting');

      switch(this.status) {
        case 'connected':
          statusDot.style.background = 'var(--success)';
          statusDot.style.boxShadow = '0 0 8px var(--success)';
          statusText.textContent = t('nav.serverActive');
          serverStatus.classList.add('status-connected');
          break;
        case 'disconnected':
          statusDot.style.background = 'var(--danger)';
          statusDot.style.boxShadow = '0 0 8px var(--danger)';
          statusText.textContent = t('nav.serverInactive');
          serverStatus.classList.add('status-disconnected');
          break;
        case 'reconnecting':
          statusDot.style.background = 'var(--warning)';
          statusDot.style.boxShadow = '0 0 8px var(--warning)';
          statusText.textContent = t('nav.reconnecting');
          serverStatus.classList.add('status-reconnecting');
          break;
      }
    },

    updateModalStatus() {
      const connDot = document.getElementById('connDot');
      const connLabel = document.getElementById('connLabel');

      if (!connDot || !connLabel) return;

      connDot.classList.remove('connected', 'disconnected', 'reconnecting');

      switch(this.status) {
        case 'connected':
          connDot.classList.add('connected');
          connLabel.textContent = t('connection.connected');
          break;
        case 'disconnected':
          connDot.classList.add('disconnected');
          connLabel.textContent = t('connection.disconnected');
          break;
        case 'reconnecting':
          connDot.classList.add('reconnecting');
          connLabel.textContent = t('connection.reconnecting');
          break;
      }

      // Actualizar info general
      this.updateElement('connType', socket.io?.engine?.transport?.name || 'WebSocket');
      this.updateElement('connUrl', window.location.origin);
      this.updateElement('connSessionId', socket.id || '-');
      this.updateElement('connSince', this.connectedSince ? this.formatTime(this.connectedSince) : '-');
    },

    updateModalLatency() {
      this.updateElement('connLatency', this.latency !== null ? `${this.latency} ms` : '-');
    },

    updateModalDuration() {
      if (this.connectedSince && this.status === 'connected') {
        const duration = Date.now() - this.connectedSince.getTime();
        this.updateElement('connDuration', this.formatDuration(duration));
      } else {
        this.updateElement('connDuration', '-');
      }
    },

    updateElement(id, value) {
      const el = document.getElementById(id);
      if (el) el.textContent = value;
    },

    formatTime(date) {
      return date.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
    },

    formatDuration(ms) {
      const seconds = Math.floor(ms / 1000);
      const minutes = Math.floor(seconds / 60);
      const hours = Math.floor(minutes / 60);

      if (hours > 0) {
        return `${hours}h ${minutes % 60}m ${seconds % 60}s`;
      } else if (minutes > 0) {
        return `${minutes}m ${seconds % 60}s`;
      } else {
        return `${seconds}s`;
      }
    }
  };

  // Inicializar métricas
  ConnectionMetrics.init();

  function openConnectionModal() {
    ConnectionMetrics.updateModalStatus();
    ConnectionMetrics.updateModalDuration();
    ConnectionMetrics.updateModalLatency();
    $('#connectionModal').modal('show');
  }

  // ===== CONNECTION STATUS =====
  // Nota: El mensaje "Conectado al servidor" lo envía el backend via socket
  socket.on('connect', function() {
    ConnectionMetrics.setStatus('connected');
    ConnectionMetrics.incrementReceived();
  });

  socket.on('disconnect', function() {
    ConnectionMetrics.setStatus('disconnected');
    ConnectionMetrics.incrementReceived();
    Terminal.addEntry({ texto: t('terminal.disconnected'), type: 'error' });
  });

  socket.on('reconnecting', function() {
    ConnectionMetrics.setStatus('reconnecting');
    ConnectionMetrics.incrementReceived();
    Terminal.addEntry({ texto: t('terminal.reconnecting'), type: 'warning' });
  });

  socket.on('reconnect', function() {
    ConnectionMetrics.setStatus('connected');
    ConnectionMetrics.incrementReconnects();
    ConnectionMetrics.incrementReceived();
  });

  socket.on('reconnect_failed', function() {
    ConnectionMetrics.setStatus('disconnected');
    ConnectionMetrics.incrementReceived();
    Terminal.addEntry({ texto: t('terminal.reconnectFailed'), type: 'error' });
  });

  // ===== SOCKET EVENTS =====
  socket.on("console", (arg) => {
    Terminal.addEntry(arg);
    ConnectionMetrics.incrementReceived();
    ConnectionMetrics.incrementConsoleEvents();
  });
  socket.on("addItem", (arg) => {
    addItemToPendingList(arg);
    ConnectionMetrics.incrementReceived();
  });
  socket.on("deleteItem", (arg) => {
    deleteItemFromPendingList(arg);
    ConnectionMetrics.incrementReceived();
  });

  // ===== DATATABLE =====
  let tabla = $('#dtList').DataTable({
    ajax: {
      type: "GET",
      url: '/api/routes',
      dataType: 'json',
      dataSrc: ''
    },
    language: {
      search: t('table.search'),
      lengthMenu: t('table.showEntries'),
      info: t('table.info'),
      infoEmpty: t('table.noResults'),
      emptyTable: t('table.emptyTable'),
      paginate: { first: "<<", previous: "<", next: ">", last: ">>" }
    },
    dom: '<"top"l>rt<"bottom"ip>', // Ocultar busqueda global, usamos filtros custom
    order: [[2, 'asc']], // Ordenar por columna orden (índice 2) por defecto
    columnDefs: [
      { target: 0, visible: false, searchable: false },
      { "width": "3%", "targets": 1, "orderable": false, "searchable": false }, // Checkbox
      { "width": "7%", "targets": 2, "type": "num" }, // Orden - tipo numérico para ordenar correctamente
      { "width": "7%", "targets": 3 },
      { "width": "28%", "targets": 4 },
      { "width": "8%", "targets": 5 },
      { "width": "7%", "targets": 6 },
      { "width": "5%", "targets": 7 },
      { "width": "5%", "targets": 8 },
      { "width": "5%", "targets": 9 },
      { "width": "19%", "targets": 10 },
      { "className": "dt-center", "targets": [1,2,3,5,6,7,8,9,10] }
    ],
    columns: [
      { data: 'id' },
      { data: null, render: function(data) {
        return `<input type="checkbox" class="route-select-check" data-id="${data.id}" onchange="updateBulkSelection()">`;
      }},
      {
        data: 'orden', // Usar el campo orden para ordenar numéricamente
        render: function (data, type, row) {
          const orden = row.orden || row.id;
          // Para ordenación, devolver el número directamente
          if (type === 'sort' || type === 'type') {
            return orden;
          }
          // Para display, devolver el HTML con controles
          return `<div class="order-controls">
            <button class="btn-order btn-order-up" onclick="moveUp(${row.id})" title="Subir prioridad"><i class="fa fa-chevron-up"></i></button>
            <input type="number" class="order-input" value="${orden}" min="1"
              onchange="updateOrden(${row.id}, this.value)"
              onclick="this.select()"
              title="Editar orden manualmente">
            <button class="btn-order btn-order-down" onclick="moveDown(${row.id})" title="Bajar prioridad"><i class="fa fa-chevron-down"></i></button>
          </div>`;
        }
      },
      { data: null, render: function (data) {
        return `<span class="badge-modern badge-${data.tipo}">${data.tipo.toUpperCase()}</span>`;
      }},
      { data: null, render: function (data) {
        let html = `<div class="route-cell">`;
        html += `<span class="route-path">${escapeHtml(data.ruta)}</span>`;

        // Parse and render tags
        if (data.tags) {
          try {
            const tags = JSON.parse(data.tags);
            if (tags.length > 0) {
              html += `<div class="route-tags">`;
              tags.forEach(tag => {
                html += `<span class="badge-tag badge-tag-sm" style="background: ${tag.color};">${escapeHtml(tag.name)}</span>`;
              });
              html += `</div>`;
            }
          } catch (e) {}
        }

        html += `</div>`;
        return html;
      }},
      { data: null, render: function (data) {
        const icons = { json: 'fa-code', xml: 'fa-file-code-o', soap: 'fa-envelope-o', text: 'fa-align-left', html: 'fa-html5', page: 'fa-file-text-o', file: 'fa-file-o', proxy: 'fa-exchange', empty: 'fa-circle-o' };
        return `<span class="response-type type-${data.tiporespuesta}"><i class="fa ${icons[data.tiporespuesta] || 'fa-question'}"></i> ${data.tiporespuesta}</span>`;
      }},
      { data: null, render: function (data) {
        let badgeClass = 'badge-status-2xx';
        if (data.codigo >= 300 && data.codigo < 400) badgeClass = 'badge-status-3xx';
        if (data.codigo >= 400 && data.codigo < 500) badgeClass = 'badge-status-4xx';
        if (data.codigo >= 500) badgeClass = 'badge-status-5xx';
        return `<span class="badge-modern ${badgeClass}">${data.codigo}</span>`;
      }},
      { data: null, render: function (data) {
        return data.isRegex === 1
          ? '<span class="badge-modern badge-regex">.*</span>'
          : '<span class="badge-modern badge-inactive">-</span>';
      }},
      { data: null, render: function (data) {
        const isWait = data.esperaActiva === 1;
        const isProxy = data.tiporespuesta === 'proxy';

        // Los proxy no pueden tener espera activa
        if (isProxy) {
          return `<span class="badge-modern badge-na" title="Los proxy no soportan espera activa">-</span>`;
        }

        return isWait
          ? `<span class="badge-modern badge-wait badge-clickable" onclick="toggleEsperaActiva(${data.id}, false)" title="Desactivar espera activa"><i class="fa fa-pause"></i></span>`
          : `<span class="badge-modern badge-inactive badge-clickable" onclick="toggleEsperaActiva(${data.id}, true)" title="Activar espera activa">-</span>`;
      }},
      { data: null, render: function (data) {
        const isActive = data.activo !== 0;
        return isActive
          ? `<span class="badge-modern badge-active badge-clickable" onclick="toggleActivo(${data.id}, false)" title="Desactivar ruta"><i class="fa fa-check"></i></span>`
          : `<span class="badge-modern badge-disabled badge-clickable" onclick="toggleActivo(${data.id}, true)" title="Activar ruta"><i class="fa fa-ban"></i></span>`;
      }},
      { data: null, render: function (data) {
        return `<div class="btn-group-modern">
          <button class="btn-icon btn-icon-primary" onclick="openCurlModal(${data.id})" title="${t('actions.viewExample')}"><i class="fa fa-terminal"></i></button>
          <button class="btn-icon btn-icon-success" onclick="openRequestTester(${data.id})" title="${t('actions.testRequest')}"><i class="fa fa-paper-plane"></i></button>
          <button class="btn-icon btn-icon-info" onclick="openDuplicateModal(${data.id})" title="${t('actions.duplicate')}"><i class="fa fa-copy"></i></button>
          <button class="btn-icon btn-icon-warning" onclick="openModal('edit', ${data.id})" title="${t('actions.edit')}"><i class="fa fa-pencil"></i></button>
          <button class="btn-icon btn-icon-danger" onclick="openDeleteModal(${data.id})" title="${t('actions.deleteRoute')}"><i class="fa fa-trash"></i></button>
        </div>`;
      }}
    ]
  });

  // ===== FILTROS PERSONALIZADOS =====
  // Filtro custom para DataTables
  $.fn.dataTable.ext.search.push(function(settings, data, dataIndex) {
    const rowData = tabla.row(dataIndex).data();
    if (!rowData) return true;

    // Filtro Metodo
    const filterMethod = document.getElementById('filterMethod').value;
    if (filterMethod && rowData.tipo !== filterMethod) return false;

    // Filtro Ruta
    const filterRouteType = document.getElementById('filterRouteType').value;
    const filterRouteValue = document.getElementById('filterRouteValue').value.toLowerCase();
    if (filterRouteValue) {
      const ruta = rowData.ruta.toLowerCase();
      switch (filterRouteType) {
        case 'contains':
          if (!ruta.includes(filterRouteValue)) return false;
          break;
        case 'startsWith':
          if (!ruta.startsWith(filterRouteValue)) return false;
          break;
        case 'endsWith':
          if (!ruta.endsWith(filterRouteValue)) return false;
          break;
        case 'equals':
          if (ruta !== filterRouteValue) return false;
          break;
        case 'regex':
          try {
            const regex = new RegExp(filterRouteValue, 'i');
            if (!regex.test(rowData.ruta)) return false;
          } catch (e) {
            // Regex invalida, no filtrar
          }
          break;
      }
    }

    // Filtro Tipo Respuesta
    const filterType = document.getElementById('filterType').value;
    if (filterType && rowData.tiporespuesta !== filterType) return false;

    // Filtro Codigo
    const filterCode = document.getElementById('filterCode').value;
    if (filterCode) {
      const code = parseInt(rowData.codigo);
      switch (filterCode) {
        case '2xx': if (code < 200 || code >= 300) return false; break;
        case '3xx': if (code < 300 || code >= 400) return false; break;
        case '4xx': if (code < 400 || code >= 500) return false; break;
        case '5xx': if (code < 500 || code >= 600) return false; break;
      }
    }

    // Filtro Regex
    const filterRegex = document.getElementById('filterRegex').value;
    if (filterRegex !== '') {
      const isRegex = rowData.isRegex === 1 ? '1' : '0';
      if (isRegex !== filterRegex) return false;
    }

    // Filtro Espera
    const filterWait = document.getElementById('filterWait').value;
    if (filterWait !== '') {
      const esperaActiva = rowData.esperaActiva === 1 ? '1' : '0';
      if (esperaActiva !== filterWait) return false;
    }

    // Filtro Activo
    const filterActivo = document.getElementById('filterActivo').value;
    if (filterActivo !== '') {
      const activo = rowData.activo !== 0 ? '1' : '0';
      if (activo !== filterActivo) return false;
    }

    // Filtro Tags
    const filterTags = getSelectedFilterTags();
    if (filterTags.length > 0) {
      let routeTags = [];
      try {
        routeTags = rowData.tags ? JSON.parse(rowData.tags).map(t => t.id) : [];
      } catch (e) {}

      // OR logic - route matches if it has ANY of the selected tags
      const hasMatch = filterTags.some(tagId => routeTags.includes(tagId));
      if (!hasMatch) return false;
    }

    return true;
  });

  function applyFilters() {
    tabla.draw();
    updateActiveFiltersCount();
  }

  function clearFilters() {
    document.getElementById('filterMethod').value = '';
    document.getElementById('filterRouteType').value = 'contains';
    document.getElementById('filterRouteValue').value = '';
    document.getElementById('filterType').value = '';
    document.getElementById('filterCode').value = '';
    document.getElementById('filterRegex').value = '';
    document.getElementById('filterWait').value = '';
    document.getElementById('filterActivo').value = '';
    // Clear tags filter dropdown
    clearTagFilter();
    applyFilters();
  }

  function updateActiveFiltersCount() {
    let count = 0;
    if (document.getElementById('filterMethod').value) count++;
    if (document.getElementById('filterRouteValue').value) count++;
    if (document.getElementById('filterType').value) count++;
    if (document.getElementById('filterCode').value) count++;
    if (document.getElementById('filterRegex').value) count++;
    if (document.getElementById('filterWait').value) count++;
    if (document.getElementById('filterActivo').value) count++;
    // Count selected tags from dropdown
    if (getSelectedFilterTags().length > 0) count++;

    const btn = document.querySelector('.btn-filter-clear');
    if (count > 0) {
      btn.innerHTML = `<i class="fa fa-times"></i> Limpiar (${count})`;
      btn.classList.add('has-filters');
    } else {
      btn.innerHTML = `<i class="fa fa-times"></i> Limpiar`;
      btn.classList.remove('has-filters');
    }
  }

  // Tags filter state
  let selectedFilterTags = [];
  let allFilterTags = [];

  // Initialize tag filter options
  async function initTagFilter() {
    const menu = document.getElementById('tagsFilterMenu');
    if (!menu) return;

    try {
      const response = await fetch('/api/tags');
      const data = await response.json();

      if (data.success) {
        allFilterTags = data.tags;
        renderTagFilterMenu();
      }
    } catch (e) {
      console.error('Error loading tag filter:', e);
    }
  }

  function renderTagFilterMenu() {
    const menu = document.getElementById('tagsFilterMenu');
    if (!menu) return;

    if (allFilterTags.length === 0) {
      menu.innerHTML = '<div style="padding: 0.75rem; color: var(--text-muted); text-align: center;">No tags</div>';
      return;
    }

    menu.innerHTML = allFilterTags.map(tag => `
      <label class="tags-filter-option">
        <input type="checkbox" value="${tag.id}"
          ${selectedFilterTags.includes(tag.id) ? 'checked' : ''}
          onchange="toggleTagFilter('${tag.id}')">
        <span class="badge-tag badge-tag-sm" style="background: ${tag.color};">${escapeHtml(tag.name)}</span>
      </label>
    `).join('');
  }

  function toggleTagsFilterDropdown() {
    const menu = document.getElementById('tagsFilterMenu');
    menu.classList.toggle('show');
  }

  function toggleTagFilter(tagId) {
    const index = selectedFilterTags.indexOf(tagId);
    if (index >= 0) {
      selectedFilterTags.splice(index, 1);
    } else {
      selectedFilterTags.push(tagId);
    }
    updateTagFilterLabel();
    applyFilters();
  }

  function updateTagFilterLabel() {
    const label = document.getElementById('tagsFilterLabel');
    if (!label) return;

    if (selectedFilterTags.length === 0) {
      label.innerHTML = '<%= __("filters.all") %>';
    } else {
      label.innerHTML = `${selectedFilterTags.length} <span class="selected-count">${selectedFilterTags.length}</span>`;
    }
  }

  function getSelectedFilterTags() {
    return selectedFilterTags;
  }

  function clearTagFilter() {
    selectedFilterTags = [];
    renderTagFilterMenu();
    updateTagFilterLabel();
  }

  // Close dropdown when clicking outside
  document.addEventListener('click', function(e) {
    const dropdown = document.getElementById('tagsFilterDropdown');
    if (dropdown && !dropdown.contains(e.target)) {
      document.getElementById('tagsFilterMenu').classList.remove('show');
    }
  });

  // Initialize tag filter on page load
  document.addEventListener('DOMContentLoaded', initTagFilter);

  // ===== FORM FUNCTIONS =====
  const responsePlaceholders = {
    json: '{"message": "Hello World", "status": "ok"}',
    xml: '<?xml version="1.0" encoding="UTF-8"?>\n<response>\n  <message>Hello World</message>\n  <status>ok</status>\n</response>',
    soap: '<?xml version="1.0" encoding="UTF-8"?>\n<soap:Envelope xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/">\n  <soap:Body>\n    <Response>\n      <Message>Hello World</Message>\n    </Response>\n  </soap:Body>\n</soap:Envelope>',
    html: '<!DOCTYPE html>\n<html>\n<head>\n  <title>Mock Response</title>\n</head>\n<body>\n  <h1>Hello World</h1>\n</body>\n</html>',
    text: 'Hello World',
    page: '<h1>Hello World</h1>\n<p>This is a rendered page.</p>',
    empty: '',
    proxy: ''
  };

  function checkRespuesta() {
    const tipoResp = document.getElementById("tiporespuesta").value;
    showElements(['#divtresp', '#divtipo', '#divruta', '#divcodresp', '#divresp', '#divEsperaActiva']);
    hideElements(['#divDestino', '#divFile']);

    if (tipoResp === 'proxy') {
      hideElements(['#divtipo', '#divcodresp', '#divEsperaActiva', '#divresp', '#divFile']);
      showElements(['#divDestino']);
    } else if (tipoResp === 'file') {
      hideElements(['#divresp']);
      showElements(['#divFile']);
    } else if (tipoResp === 'empty') {
      hideElements(['#divresp', '#divFile']);
    }

    // Actualizar placeholder según tipo
    const textarea = document.getElementById('respuesta');
    if (textarea) {
      textarea.placeholder = responsePlaceholders[tipoResp] || '';
    }

    // Mostrar/ocultar botón formatear
    const formatBtn = document.getElementById('btnFormatJson');
    if (formatBtn) {
      const canFormat = ['json', 'xml', 'soap', 'html'].includes(tipoResp);
      formatBtn.style.display = canFormat ? '' : 'none';
    }
  }

  function formatResponseJson() {
    const textarea = document.getElementById('respuesta');
    const tipoResp = document.getElementById('tiporespuesta').value;

    if (!textarea || !textarea.value.trim()) return;

    try {
      if (tipoResp === 'json') {
        const parsed = JSON.parse(textarea.value);
        textarea.value = JSON.stringify(parsed, null, 2);
      } else if (tipoResp === 'xml' || tipoResp === 'soap') {
        textarea.value = formatXml(textarea.value);
      } else if (tipoResp === 'html') {
        textarea.value = formatHtml(textarea.value);
      }
    } catch (e) {
      showToast(`${t('responseTypes.' + tipoResp) || tipoResp.toUpperCase()} ${t('validation.' + tipoResp + 'Invalid')}: ${e.message}`, 'error');
    }
  }

  // Usar httpCodes de las traducciones
  const httpCodes = t('httpCodes') || {};

  function updateCodeDescription() {
    const code = document.getElementById("crespuestaInput").value;
    document.getElementById("codeDescription").textContent = httpCodes[code] || 'Custom';
  }

  // ===== ORDER FUNCTIONS =====
  async function normalizeOrder() {
    if (!confirm(t('confirm.normalizeOrder'))) {
      return;
    }

    try {
      const response = await fetch('/api/normalize-order', { method: 'POST' });
      const data = await response.json();
      if (data.success) {
        tabla.ajax.reload(null, false);
        console.log(`Normalizado: ${data.rutas} rutas, ${data.proxies} proxies`);
      } else {
        showToast(data.error || t('errors.normalizing'), 'error');
      }
    } catch (e) {
      console.error(t('errors.normalizing') + ':', e);
    }
  }

  async function moveUp(id) {
    try {
      const response = await fetch(`/api/move-up/${id}`, { method: 'PUT' });
      const data = await response.json();
      if (data.success) {
        tabla.ajax.reload(null, false);
      }
    } catch (e) {
      console.error('Error moviendo ruta:', e);
    }
  }

  async function moveDown(id) {
    try {
      const response = await fetch(`/api/move-down/${id}`, { method: 'PUT' });
      const data = await response.json();
      if (data.success) {
        tabla.ajax.reload(null, false);
      }
    } catch (e) {
      console.error('Error moviendo ruta:', e);
    }
  }

  async function updateOrden(id, orden) {
    const ordenNum = parseInt(orden);
    if (isNaN(ordenNum) || ordenNum < 1) {
      showToast(t('validation.orderPositive'), 'warning');
      tabla.ajax.reload(null, false);
      return;
    }

    try {
      const response = await fetch(`/api/update-order/${id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ orden: ordenNum })
      });
      const data = await response.json();
      if (data.success) {
        tabla.ajax.reload(null, false);
      } else {
        showToast(data.error || t('errors.updatingOrder'), 'error');
      }
    } catch (e) {
      console.error(t('errors.updatingOrder') + ':', e);
    }
  }

  function toggleRegexMode() {
    const isRegex = document.getElementById("isRegex").checked;
    document.getElementById("divRegexValidator").style.display = isRegex ? "block" : "none";
    if (isRegex) validateRegexIfEnabled();
    else document.getElementById("regexResult").innerHTML = "";
  }

  function validateRegexIfEnabled() {
    if (document.getElementById("isRegex").checked) testRegex();
  }

  async function testRegex() {
    const regex = document.getElementById("ruta").value;
    const testUrl = document.getElementById("regexTestUrl").value;
    const resultDiv = document.getElementById("regexResult");

    if (!regex) {
      resultDiv.innerHTML = `<span style="color: var(--text-muted);">${t('validation.enterRegex')}</span>`;
      return;
    }

    try {
      const response = await fetch('/api/validateRegex', {
        method: 'POST',
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ regex, testUrl })
      });
      const data = await response.json();

      if (data.valid) {
        let html = `<span class="badge-modern" style="background: var(--success); color: white;">${t('validation.regexValid')}</span>`;
        if (testUrl) {
          html += data.matches
            ? ` <span class="badge-modern" style="background: var(--info); color: white;">${t('validation.urlMatches')}</span>`
            : ` <span class="badge-modern" style="background: var(--warning); color: white;">${t('validation.urlNoMatch')}</span>`;
        }
        resultDiv.innerHTML = html;
      } else {
        resultDiv.innerHTML = `<span class="badge-modern" style="background: var(--danger); color: white;">${t('validation.regexInvalid')}</span> <small style="color: var(--danger);">${data.error}</small>`;
      }
    } catch (e) {
      resultDiv.innerHTML = `<span class="badge-modern" style="background: var(--danger); color: white;">${t('validation.errorValidating')}</span>`;
    }
  }

  // ===== XML/SOAP UTILITIES =====
  function validateXml(xmlString) {
    const parser = new DOMParser();
    const doc = parser.parseFromString(xmlString, 'application/xml');
    const parseError = doc.querySelector('parsererror');
    if (parseError) {
      return { valid: false, error: parseError.textContent };
    }
    return { valid: true, doc };
  }

  function formatXml(xmlString, indent = 2) {
    const result = validateXml(xmlString);
    if (!result.valid) {
      throw new Error(result.error);
    }

    // Serializar y formatear
    const serializer = new XMLSerializer();
    let xml = serializer.serializeToString(result.doc);

    // Formateo manual con indentación
    const PADDING = ' '.repeat(indent);
    let formatted = '';
    let pad = 0;

    xml = xml.replace(/(>)(<)(\/*)/g, '$1\n$2$3');
    xml.split('\n').forEach(node => {
      let indentLevel = 0;
      if (node.match(/.+<\/\w[^>]*>$/)) {
        indentLevel = 0;
      } else if (node.match(/^<\/\w/) && pad > 0) {
        pad -= 1;
      } else if (node.match(/^<\w[^>]*[^\/]>.*$/)) {
        indentLevel = 1;
      } else {
        indentLevel = 0;
      }
      formatted += PADDING.repeat(pad) + node + '\n';
      pad += indentLevel;
    });

    return formatted.trim();
  }

  function formatHtml(htmlString) {
    // Validar que sea HTML básico
    const parser = new DOMParser();
    const doc = parser.parseFromString(htmlString, 'text/html');

    // Si el parseador genera errores significativos, lanzar error
    const body = doc.body;
    if (!body || (body.children.length === 0 && !body.textContent.trim())) {
      throw new Error('HTML vacío o inválido');
    }

    // Formateo manual con indentación
    const PADDING = '  ';
    let formatted = '';
    let pad = 0;

    // Normalizar y dividir por tags
    let html = htmlString.trim();
    html = html.replace(/(>)\s*(<)/g, '$1\n$2');

    const lines = html.split('\n');
    lines.forEach(line => {
      line = line.trim();
      if (!line) return;

      // Tag de cierre
      if (line.match(/^<\/\w/)) {
        pad = Math.max(0, pad - 1);
      }

      formatted += PADDING.repeat(pad) + line + '\n';

      // Tag de apertura (no auto-cerrado y no cierre)
      if (line.match(/^<\w[^>]*[^\/]>$/) && !line.match(/^<(br|hr|img|input|meta|link|area|base|col|embed|param|source|track|wbr)/i)) {
        pad += 1;
      }
    });

    return formatted.trim();
  }

  // ===== HEADERS =====
  let headerCounter = 0;

  function addHeaderRow(name = '', value = '', action = 'set') {
    headerCounter++;
    const container = document.getElementById('headersContainer');
    document.getElementById('noHeadersMsg').style.display = 'none';

    const row = document.createElement('div');
    row.className = 'd-flex gap-2 mb-2 align-items-center';
    row.id = `header-row-${headerCounter}`;
    row.innerHTML = `
      <select class="form-control-modern form-select-modern" style="width: 100px;" id="header-action-${headerCounter}">
        <option value="set" ${action === 'set' ? 'selected' : ''}>Set</option>
        <option value="remove" ${action === 'remove' ? 'selected' : ''}>Remove</option>
      </select>
      <input type="text" class="form-control-modern" placeholder="Header name" id="header-name-${headerCounter}" value="${escapeHtml(name)}" style="width: 180px;">
      <input type="text" class="form-control-modern" placeholder="Header value" id="header-value-${headerCounter}" value="${escapeHtml(value)}" style="flex: 1;">
      <button class="btn-icon btn-icon-danger" type="button" onclick="removeHeaderRow(${headerCounter})">
        <i class="fa fa-trash"></i>
      </button>
    `;
    container.appendChild(row);
    updateHeaderValueVisibility(headerCounter);

    document.getElementById(`header-action-${headerCounter}`).addEventListener('change', function() {
      updateHeaderValueVisibility(this.id.replace('header-action-', ''));
    });
  }

  function updateHeaderValueVisibility(rowId) {
    const action = document.getElementById(`header-action-${rowId}`).value;
    const valueInput = document.getElementById(`header-value-${rowId}`);
    valueInput.style.display = action === 'remove' ? 'none' : 'block';
    if (action === 'remove') valueInput.value = '';
  }

  function removeHeaderRow(id) {
    const row = document.getElementById(`header-row-${id}`);
    if (row) row.remove();

    const container = document.getElementById('headersContainer');
    if (container.children.length === 0) {
      document.getElementById('noHeadersMsg').style.display = 'block';
    }
  }

  function getCustomHeaders() {
    const headers = [];
    const rows = document.getElementById('headersContainer').querySelectorAll('[id^="header-row-"]');
    rows.forEach(row => {
      const id = row.id.replace('header-row-', '');
      const action = document.getElementById(`header-action-${id}`).value;
      const name = document.getElementById(`header-name-${id}`).value.trim();
      const value = document.getElementById(`header-value-${id}`).value;
      if (name) headers.push({ action, name, value });
    });
    return headers.length > 0 ? headers : null;
  }

  function setCustomHeaders(headers) {
    clearHeaders();
    if (headers && Array.isArray(headers)) {
      headers.forEach(h => addHeaderRow(h.name, h.value, h.action));
    }
  }

  function clearHeaders() {
    document.getElementById('headersContainer').innerHTML = '';
    document.getElementById('noHeadersMsg').style.display = 'block';
    headerCounter = 0;
  }

  // ===== TAGS MODULE =====
  const TagsModule = {
    availableTags: [],
    selectedTags: [],
    predefinedColors: [
      '#6366f1', '#8b5cf6', '#ec4899', '#ef4444', '#f97316', '#f59e0b',
      '#10b981', '#14b8a6', '#06b6d4', '#3b82f6', '#374151', '#1e293b'
    ],

    async init() {
      await this.loadTags();
      this.renderColorPalette();
    },

    async loadTags() {
      try {
        const response = await fetch('/api/tags');
        const data = await response.json();
        if (data.success) {
          this.availableTags = data.tags;
          this.renderTagSelector();
        }
      } catch (e) {
        console.error('Error loading tags:', e);
      }
    },

    renderTagSelector() {
      const container = document.getElementById('tagsSelector');
      const noTagsMsg = document.getElementById('noTagsMsg');
      if (!container) return;

      // Only show selected tags with remove buttons
      if (this.selectedTags.length === 0) {
        container.innerHTML = '';
        if (noTagsMsg) noTagsMsg.style.display = 'block';
        return;
      }

      if (noTagsMsg) noTagsMsg.style.display = 'none';

      let html = '<div class="selected-tags-display">';
      this.selectedTags.forEach(tag => {
        html += `<span class="badge-tag badge-tag-removable" style="background: ${tag.color};">
          ${this.escapeHtml(tag.name)}
          <button type="button" class="tag-remove" onclick="TagsModule.removeTag('${tag.id}')" title="Eliminar">
            <i class="fa fa-times"></i>
          </button>
        </span>`;
      });
      html += '</div>';

      container.innerHTML = html;
    },

    removeTag(tagId) {
      const index = this.selectedTags.findIndex(t => t.id === tagId);
      if (index >= 0) {
        this.selectedTags.splice(index, 1);
        this.renderTagSelector();
      }
    },

    addTag(tagId) {
      const tag = this.availableTags.find(t => t.id === tagId);
      if (!tag) return;

      // Don't add if already selected
      if (this.selectedTags.find(t => t.id === tagId)) {
        this.closeCreator();
        return;
      }

      this.selectedTags.push(tag);
      this.renderTagSelector();
      this.closeCreator();
    },

    setTags(tags) {
      this.selectedTags = tags || [];
      this.renderTagSelector();
    },

    getTags() {
      return this.selectedTags;
    },

    clear() {
      this.selectedTags = [];
      this.renderTagSelector();
    },

    renderColorPalette() {
      const container = document.getElementById('colorPalette');
      if (!container) return;

      container.innerHTML = this.predefinedColors.map((color, i) => `
        <button type="button" class="color-swatch ${i === 0 ? 'selected' : ''}"
          style="background: ${color};"
          data-color="${color}"
          onclick="TagsModule.selectColor('${color}')">
        </button>
      `).join('');
    },

    selectColor(color) {
      document.querySelectorAll('.color-swatch').forEach(el => el.classList.remove('selected'));
      const swatch = document.querySelector(`.color-swatch[data-color="${color}"]`);
      if (swatch) swatch.classList.add('selected');
      document.getElementById('customTagColor').value = color;
    },

    async createOrAddTag() {
      const name = document.getElementById('newTagName').value.trim();
      const color = document.getElementById('customTagColor').value;

      if (!name) {
        showToast(t('validation.tagNameRequired'), 'warning');
        return;
      }

      // Check if tag already exists (case insensitive)
      const existingTag = this.availableTags.find(t =>
        t.name.toLowerCase() === name.toLowerCase()
      );

      if (existingTag) {
        // Tag exists, just add it to selected
        if (!this.selectedTags.find(t => t.id === existingTag.id)) {
          this.selectedTags.push(existingTag);
          this.renderTagSelector();
        }
        this.closeCreator();
        return;
      }

      // Create new tag
      try {
        const response = await fetch('/api/tags', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, color })
        });
        const data = await response.json();

        if (data.success) {
          this.availableTags.push(data.tag);
          this.selectedTags.push(data.tag);
          this.renderTagSelector();
          this.closeCreator();
          initTagFilter();
        } else {
          showToast(data.error || t('errors.creatingTag'), 'error');
        }
      } catch (e) {
        showToast(t('errors.creatingTag'), 'error');
      }
    },

    openCreator() {
      document.getElementById('newTagName').value = '';
      document.getElementById('customTagColor').value = '#6366f1';
      this.selectColor('#6366f1');
      this.renderTagSuggestions();
      document.getElementById('tagCreatorPopup').style.display = 'flex';
    },

    closeCreator() {
      document.getElementById('tagCreatorPopup').style.display = 'none';
    },

    renderTagSuggestions(filter = '') {
      const container = document.getElementById('tagSuggestions');
      if (!container) return;

      // Filter tags that are not already selected
      let availableToAdd = this.availableTags.filter(tag =>
        !this.selectedTags.find(t => t.id === tag.id)
      );

      // Apply text filter if provided
      if (filter) {
        const lowerFilter = filter.toLowerCase();
        availableToAdd = availableToAdd.filter(tag =>
          tag.name.toLowerCase().includes(lowerFilter)
        );
      }

      if (availableToAdd.length === 0) {
        container.innerHTML = filter
          ? `<div class="tag-suggestions-empty">${t('form.noMatchingTags')}</div>`
          : '';
        return;
      }

      container.innerHTML = availableToAdd.map(tag => `
        <button type="button" class="tag-suggestion" style="--tag-color: ${tag.color};"
          onclick="TagsModule.addTag('${tag.id}')">
          <span class="badge-tag" style="background: ${tag.color};">${this.escapeHtml(tag.name)}</span>
        </button>
      `).join('');
    },

    filterSuggestions() {
      const input = document.getElementById('newTagName');
      this.renderTagSuggestions(input.value.trim());
    },

    escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
  };

  function toggleTagsSection() {
    const body = document.querySelector('#divTags .collapsible-body');
    body.style.display = body.style.display === 'none' ? 'block' : 'none';
  }

  function toggleMetadataSection() {
    const body = document.querySelector('#divMetadata .collapsible-body');
    body.style.display = body.style.display === 'none' ? 'block' : 'none';
  }

  // Initialize TagsModule on page load
  document.addEventListener('DOMContentLoaded', () => TagsModule.init());

  // ===== CONDITIONAL RESPONSES =====
  let conditionCounter = 0;

  function toggleConditionsSection() {
    const body = document.querySelector('#divConditions .collapsible-body');
    body.style.display = body.style.display === 'none' ? 'block' : 'none';
  }

  function showCriteriaHelp() {
    // Quitar foco del elemento actual para evitar warning de aria-hidden
    if (document.activeElement) {
      document.activeElement.blur();
    }
    const modal = new bootstrap.Modal(document.getElementById('criteriaHelpModal'));
    modal.show();
  }

  function addConditionRow(data = {}) {
    conditionCounter++;
    const container = document.getElementById('conditionsContainer');
    document.getElementById('noConditionsMsg').style.display = 'none';

    const card = document.createElement('div');
    card.className = 'condition-card';
    card.id = `condition-${conditionCounter}`;
    card.dataset.order = conditionCounter;

    card.innerHTML = `
      <div class="condition-header">
        <div class="condition-drag-handle" title="${t('actions.moveUp')}/${t('actions.moveDown')}">
          <i class="fa fa-bars"></i>
        </div>
        <input type="text" class="form-control-modern condition-name"
               placeholder="${t('form.conditionName')}"
               id="condition-name-${conditionCounter}"
               value="${escapeHtml(data.nombre || '')}">
        <label class="switch-modern" style="margin-left: auto;">
          <input type="checkbox" id="condition-active-${conditionCounter}" ${data.activo !== false ? 'checked' : ''}>
          <span class="slider"></span>
        </label>
        <button class="btn-icon btn-icon-danger" type="button" onclick="removeConditionRow(${conditionCounter})" title="${t('buttons.delete')}">
          <i class="fa fa-trash"></i>
        </button>
      </div>
      <div class="condition-body">
        <div class="form-group-modern">
          <label class="form-label-modern">${t('form.criteria')} <span style="color: var(--danger);">*</span></label>
          <div class="d-flex gap-2">
            <textarea class="form-control-modern condition-criteria"
                      id="condition-criteria-${conditionCounter}"
                      placeholder="${t('form.placeholder.criteria')}"
                      rows="2">${escapeHtml(data.criteria || '')}</textarea>
            <button class="btn-modern btn-modern-secondary" type="button"
                    onclick="validateConditionCriteria(${conditionCounter})"
                    title="${t('buttons.validate')}" style="align-self: flex-start;">
              <i class="fa fa-check"></i>
            </button>
          </div>
          <div id="condition-validation-${conditionCounter}" class="condition-validation"></div>
        </div>

        <div class="condition-overrides">
          <div class="override-row">
            <div class="form-group-modern" style="flex: 0 0 100px;">
              <label class="form-label-modern">${t('table.code')}</label>
              <input type="text" class="form-control-modern"
                     id="condition-code-${conditionCounter}"
                     placeholder="-"
                     value="${escapeHtml(data.codigo || '')}">
            </div>
            <div class="form-group-modern" style="flex: 0 0 150px;">
              <label class="form-label-modern">${t('table.type')}</label>
              <select class="form-control-modern form-select-modern"
                      id="condition-type-${conditionCounter}">
                <option value="">${t('form.useDefault')}</option>
                <option value="json" ${data.tiporespuesta === 'json' ? 'selected' : ''}>JSON</option>
                <option value="xml" ${data.tiporespuesta === 'xml' ? 'selected' : ''}>XML</option>
                <option value="text" ${data.tiporespuesta === 'text' ? 'selected' : ''}>Text</option>
                <option value="html" ${data.tiporespuesta === 'html' ? 'selected' : ''}>HTML</option>
                <option value="empty" ${data.tiporespuesta === 'empty' ? 'selected' : ''}>Empty</option>
              </select>
            </div>
          </div>

          <div class="form-group-modern">
            <label class="form-label-modern">${t('form.response')}</label>
            <textarea class="form-control-modern"
                      id="condition-response-${conditionCounter}"
                      placeholder="${t('form.placeholder.leaveEmpty')}"
                      rows="3">${escapeHtml(data.respuesta || '')}</textarea>
          </div>
        </div>
      </div>
    `;

    container.appendChild(card);

    // Inicializar sortable si es la primera condición
    if (container.children.length === 1 && typeof Sortable !== 'undefined') {
      new Sortable(container, {
        handle: '.condition-drag-handle',
        animation: 150,
        ghostClass: 'condition-ghost',
        onEnd: function() {
          Array.from(container.children).forEach((el, idx) => {
            el.dataset.order = idx + 1;
          });
        }
      });
    }
  }

  function removeConditionRow(id) {
    const card = document.getElementById(`condition-${id}`);
    if (card) card.remove();

    const container = document.getElementById('conditionsContainer');
    if (container.children.length === 0) {
      document.getElementById('noConditionsMsg').style.display = 'block';
    }
  }

  async function validateConditionCriteria(id) {
    const criteria = document.getElementById(`condition-criteria-${id}`).value;
    const resultDiv = document.getElementById(`condition-validation-${id}`);

    if (!criteria.trim()) {
      resultDiv.innerHTML = `<span class="text-warning"><i class="fa fa-warning"></i> ${t('validation.enterCriteria')}</span>`;
      return;
    }

    try {
      const response = await fetch('/api/validateCriteria', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ criteria })
      });
      const result = await response.json();

      if (result.valid) {
        resultDiv.innerHTML = `<span class="text-success"><i class="fa fa-check"></i> ${t('validation.criteriaValid')}</span>`;
      } else {
        resultDiv.innerHTML = `<span class="text-danger"><i class="fa fa-times"></i> ${result.error}</span>`;
      }
    } catch (e) {
      resultDiv.innerHTML = `<span class="text-danger"><i class="fa fa-times"></i> ${t('validation.errorValidating')}</span>`;
    }
  }

  function getConditions() {
    const conditions = [];
    const container = document.getElementById('conditionsContainer');
    const cards = Array.from(container.querySelectorAll('.condition-card'))
      .sort((a, b) => (parseInt(a.dataset.order) || 0) - (parseInt(b.dataset.order) || 0));

    cards.forEach((card, idx) => {
      const id = card.id.replace('condition-', '');
      const criteria = document.getElementById(`condition-criteria-${id}`).value.trim();

      if (!criteria) return; // Saltar condiciones vacías

      conditions.push({
        orden: idx,
        nombre: document.getElementById(`condition-name-${id}`).value.trim() || null,
        criteria: criteria,
        codigo: document.getElementById(`condition-code-${id}`).value.trim() || null,
        tiporespuesta: document.getElementById(`condition-type-${id}`).value || null,
        respuesta: document.getElementById(`condition-response-${id}`).value || null,
        customHeaders: null, // Se podría expandir para headers por condición
        activo: document.getElementById(`condition-active-${id}`).checked
      });
    });

    return conditions;
  }

  function setConditions(conditions) {
    clearConditions();
    if (conditions && Array.isArray(conditions)) {
      conditions.forEach(c => addConditionRow(c));
    }
  }

  function clearConditions() {
    document.getElementById('conditionsContainer').innerHTML = '';
    document.getElementById('noConditionsMsg').style.display = 'block';
    conditionCounter = 0;
  }

  async function loadConditionsForRoute(routeId) {
    try {
      const response = await fetch(`/api/conditions/${routeId}`);
      const data = await response.json();
      if (data.success && data.conditions) {
        setConditions(data.conditions);
        // Mostrar la sección si hay condiciones
        if (data.conditions.length > 0) {
          document.querySelector('#divConditions .collapsible-body').style.display = 'block';
        }
      }
    } catch (e) {
      console.error('Error cargando condiciones:', e);
    }
  }

  function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  function showElements(list) { list.forEach(el => $(el).show()); }
  function hideElements(list) { list.forEach(el => $(el).hide()); }

  // ===== FILE UPLOAD FUNCTIONS =====
  let selectedFile = null;
  let keepExistingFile = false;

  function handleFileSelect(event) {
    const file = event.target.files[0];
    if (file) {
      selectedFile = file;
      keepExistingFile = false;
      document.getElementById('fileInfo').style.display = 'flex';
      document.getElementById('fileName').textContent = file.name;
      document.getElementById('fileSize').textContent = formatFileSize(file.size);
      document.getElementById('currentFileInfo').style.display = 'none';
    }
  }

  function clearFileSelection() {
    selectedFile = null;
    keepExistingFile = false;
    document.getElementById('fileUpload').value = '';
    document.getElementById('fileInfo').style.display = 'none';
    document.getElementById('fileName').textContent = '';
    document.getElementById('fileSize').textContent = '';
  }

  function setCurrentFileInfo(fileName, fileSize) {
    if (fileName) {
      keepExistingFile = true;
      document.getElementById('currentFileInfo').style.display = 'flex';
      document.getElementById('currentFileName').textContent = fileName;
      document.getElementById('currentFileSize').textContent = fileSize ? formatFileSize(fileSize) : '';
    } else {
      document.getElementById('currentFileInfo').style.display = 'none';
    }
  }

  function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
  }

  // ===== MODAL FUNCTIONS =====
  function openModal(type = 'create', objId) {
    // Limpiar condiciones siempre al abrir
    clearConditions();
    // Colapsar sección de condiciones
    document.querySelector('#divConditions .collapsible-body').style.display = 'none';

    if (type === 'create') {
      checkRespuesta();
      $("#botoneditar").hide();
      $("#botonguardar").show();
      $("#titleModal").html('<i class="fa fa-plus me-2"></i>Nueva Ruta');
      $("#routesModal").modal('show');
    }
    if (type === 'edit') {
      $("#idmodal").html(objId);
      $("#botoneditar").show();
      $("#botonguardar").hide();
      const obj = Array.from(tabla.rows().data()).find(el => el.id === objId);
      valuesForModal(obj);
      checkRespuesta();
      // Cargar condiciones existentes
      loadConditionsForRoute(objId);
      $("#titleModal").html('<i class="fa fa-pencil me-2"></i>Editar Ruta');
      $("#routesModal").modal('show');
    }
  }

  function openList() { $("#modalLista").modal('show'); }

  // ===== TOOLS DROPDOWN =====
  function toggleToolsDropdown() {
    const menu = document.getElementById('toolsDropdownMenu');
    menu.classList.toggle('show');
  }

  function closeToolsDropdown() {
    const menu = document.getElementById('toolsDropdownMenu');
    menu.classList.remove('show');
  }

  // Close dropdown when clicking outside
  document.addEventListener('click', function(e) {
    const dropdown = document.querySelector('.dropdown-modern');
    if (dropdown && !dropdown.contains(e.target)) {
      closeToolsDropdown();
    }
  });

  // ===== GLOBAL TAG MANAGER =====
  const globalPredefinedColors = [
    '#6366f1', '#8b5cf6', '#ec4899', '#ef4444', '#f97316', '#f59e0b',
    '#10b981', '#14b8a6', '#06b6d4', '#3b82f6', '#374151', '#1e293b'
  ];

  function openTagManager() {
    renderGlobalTagManager();
    document.getElementById('tagManagerModal').style.display = 'flex';
  }

  function closeTagManager() {
    document.getElementById('tagManagerModal').style.display = 'none';
  }

  function renderGlobalTagManager() {
    const container = document.getElementById('tagManagerList');
    if (!container) return;

    const tags = TagsModule.availableTags;

    if (tags.length === 0) {
      container.innerHTML = `<div class="empty-state"><i class="fa fa-inbox"></i><p>${t('empty.noTags')}</p></div>`;
      return;
    }

    container.innerHTML = tags.map(tag => `
      <div class="tag-manager-item" data-tag-id="${tag.id}">
        <span class="badge-tag" style="background: ${tag.color};">${escapeHtml(tag.name)}</span>
        <div class="tag-manager-actions">
          <input type="color" class="tag-color-picker" value="${tag.color}"
            onchange="updateGlobalTagColor('${tag.id}', this.value)" title="Cambiar color">
          <button type="button" class="btn-tag-delete" onclick="prepareDeleteTag('${tag.id}')" title="${t('buttons.delete')}">
            <i class="fa fa-trash"></i>
          </button>
          <button type="button" class="btn-tag-confirm-delete" style="display: none;" onclick="confirmDeleteTag('${tag.id}')">
            <i class="fa fa-exclamation-triangle"></i> ${t('buttons.delete')}?
          </button>
        </div>
      </div>
    `).join('');
  }

  async function updateGlobalTagColor(tagId, color) {
    try {
      const response = await fetch(`/api/tags/${tagId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ color })
      });
      const data = await response.json();

      if (data.success) {
        const tag = TagsModule.availableTags.find(t => t.id === tagId);
        if (tag) tag.color = color;
        const selectedTag = TagsModule.selectedTags.find(t => t.id === tagId);
        if (selectedTag) selectedTag.color = color;

        const importTag = ImportTagsModule.availableTags.find(t => t.id === tagId);
        if (importTag) importTag.color = color;
        const importSelectedTag = ImportTagsModule.selectedTags.find(t => t.id === tagId);
        if (importSelectedTag) importSelectedTag.color = color;

        renderGlobalTagManager();
        TagsModule.renderTagSelector();
        ImportTagsModule.renderTagSelector();
        initTagFilter();
        tabla.ajax.reload(null, false);
      }
    } catch (e) {
      console.error('Error updating tag color:', e);
    }
  }

  let pendingDeleteTagId = null;

  function prepareDeleteTag(tagId) {
    // Reset any other pending delete
    if (pendingDeleteTagId && pendingDeleteTagId !== tagId) {
      cancelPendingDelete();
    }

    pendingDeleteTagId = tagId;
    const item = document.querySelector(`.tag-manager-item[data-tag-id="${tagId}"]`);
    if (!item) return;

    const deleteBtn = item.querySelector('.btn-tag-delete');
    const confirmBtn = item.querySelector('.btn-tag-confirm-delete');
    if (deleteBtn) deleteBtn.style.display = 'none';
    if (confirmBtn) confirmBtn.style.display = 'inline-flex';

    // Auto-cancel after 3 seconds
    setTimeout(() => {
      if (pendingDeleteTagId === tagId) {
        cancelPendingDelete();
      }
    }, 3000);
  }

  function cancelPendingDelete() {
    if (!pendingDeleteTagId) return;
    const item = document.querySelector(`.tag-manager-item[data-tag-id="${pendingDeleteTagId}"]`);
    if (item) {
      const deleteBtn = item.querySelector('.btn-tag-delete');
      const confirmBtn = item.querySelector('.btn-tag-confirm-delete');
      if (deleteBtn) deleteBtn.style.display = 'inline-flex';
      if (confirmBtn) confirmBtn.style.display = 'none';
    }
    pendingDeleteTagId = null;
  }

  async function confirmDeleteTag(tagId) {
    if (pendingDeleteTagId !== tagId) return;

    try {
      const response = await fetch(`/api/tags/${tagId}`, {
        method: 'DELETE'
      });
      const data = await response.json();

      if (data.success) {
        pendingDeleteTagId = null;
        TagsModule.availableTags = TagsModule.availableTags.filter(t => t.id !== tagId);
        TagsModule.selectedTags = TagsModule.selectedTags.filter(t => t.id !== tagId);
        ImportTagsModule.availableTags = ImportTagsModule.availableTags.filter(t => t.id !== tagId);
        ImportTagsModule.selectedTags = ImportTagsModule.selectedTags.filter(t => t.id !== tagId);

        renderGlobalTagManager();
        TagsModule.renderTagSelector();
        ImportTagsModule.renderTagSelector();
        initTagFilter();
        tabla.ajax.reload(null, false);
      } else {
        showToast(data.error || 'Error eliminando tag', 'error');
      }
    } catch (e) {
      showToast('Error eliminando tag', 'error');
    }
  }

  function openTagCreatorFromManager() {
    document.getElementById('globalNewTagName').value = '';
    document.getElementById('globalCustomTagColor').value = '#6366f1';
    renderGlobalColorPalette();
    document.getElementById('globalTagCreatorPopup').style.display = 'flex';
  }

  function closeGlobalTagCreator() {
    document.getElementById('globalTagCreatorPopup').style.display = 'none';
  }

  function renderGlobalColorPalette() {
    const container = document.getElementById('globalColorPalette');
    if (!container) return;

    container.innerHTML = globalPredefinedColors.map((color, i) => `
      <button type="button" class="color-swatch ${i === 0 ? 'selected' : ''}"
        style="background: ${color};"
        data-color="${color}"
        onclick="selectGlobalColor('${color}')">
      </button>
    `).join('');
  }

  function selectGlobalColor(color) {
    document.querySelectorAll('#globalColorPalette .color-swatch').forEach(el => el.classList.remove('selected'));
    const swatch = document.querySelector(`#globalColorPalette .color-swatch[data-color="${color}"]`);
    if (swatch) swatch.classList.add('selected');
    document.getElementById('globalCustomTagColor').value = color;
  }

  async function createGlobalTag() {
    const name = document.getElementById('globalNewTagName').value.trim();
    const color = document.getElementById('globalCustomTagColor').value;

    if (!name) {
      showToast(t('validation.tagNameRequired'), 'warning');
      return;
    }

    try {
      const response = await fetch('/api/tags', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name, color })
      });
      const data = await response.json();

      if (data.success) {
        TagsModule.availableTags.push(data.tag);
        ImportTagsModule.availableTags.push(data.tag);
        renderGlobalTagManager();
        TagsModule.renderTagSelector();
        ImportTagsModule.renderTagSelector();
        initTagFilter();
        closeGlobalTagCreator();
      } else {
        showToast(data.error || t('errors.creatingTag'), 'error');
      }
    } catch (e) {
      showToast(t('errors.creatingTag'), 'error');
    }
  }

  let deleteRouteId = null;

  function openDeleteModal(id) {
    const obj = Array.from(tabla.rows().data()).find(el => el.id === id);
    if (!obj) return;

    deleteRouteId = id;

    // Llenar información del modal
    document.getElementById('deleteRouteId').textContent = obj.id;
    document.getElementById('deleteRouteMethod').innerHTML = `<span class="badge-modern badge-${obj.tipo}">${obj.tipo.toUpperCase()}</span>`;
    document.getElementById('deleteRoutePath').textContent = obj.ruta;
    document.getElementById('deleteRouteType').textContent = obj.tiporespuesta;
    document.getElementById('deleteRouteCode').textContent = obj.codigo;

    $('#deleteModal').modal('show');
  }

  async function confirmDelete() {
    if (!deleteRouteId) return;

    const btn = document.getElementById('confirmDeleteBtn');
    const originalHtml = btn.innerHTML;
    btn.innerHTML = `<i class="fa fa-spinner fa-spin"></i> ${t('buttons.deleting')}`;
    btn.disabled = true;

    const response = await fetch('/api/delete/' + deleteRouteId.toString(), { method: 'DELETE' });
    if (response.status === 200) {
      tabla.ajax.reload();
      $('#deleteModal').modal('hide');
      $("#routesModal").modal('hide');
    }

    btn.innerHTML = originalHtml;
    btn.disabled = false;
    deleteRouteId = null;
  }

  // Duplicate route functions
  let duplicateRouteId = null;

  function openDuplicateModal(id) {
    const obj = Array.from(tabla.rows().data()).find(el => el.id === id);
    if (!obj) return;

    duplicateRouteId = id;

    document.getElementById('duplicateRouteMethod').innerHTML = `<span class="badge-modern badge-${obj.tipo}">${obj.tipo.toUpperCase()}</span>`;
    document.getElementById('duplicateRouteOriginal').textContent = obj.ruta;
    document.getElementById('duplicateRouteType').textContent = obj.tiporespuesta;
    document.getElementById('duplicateRouteCode').textContent = obj.codigo;
    document.getElementById('duplicateNewRoute').value = obj.ruta;

    $('#duplicateModal').modal('show');

    // Focus en el input de ruta tras abrir el modal
    $('#duplicateModal').on('shown.bs.modal', function () {
      document.getElementById('duplicateNewRoute').focus();
      document.getElementById('duplicateNewRoute').select();
    });
  }

  async function confirmDuplicate() {
    if (!duplicateRouteId) return;

    const newRoute = document.getElementById('duplicateNewRoute').value.trim();
    if (!newRoute) {
      showToast(t('duplicate.routeRequired'), 'error');
      return;
    }

    if (newRoute.startsWith('/api/') || newRoute === '/api') {
      showToast(t('confirm.reservedRoute'), 'warning');
      return;
    }

    const btn = document.getElementById('confirmDuplicateBtn');
    const originalHtml = btn.innerHTML;
    btn.innerHTML = `<i class="fa fa-spinner fa-spin"></i> ${t('duplicate.duplicating')}`;
    btn.disabled = true;

    try {
      const response = await fetch(`/api/duplicate/${duplicateRouteId}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ newRoute })
      });

      if (response.ok) {
        tabla.ajax.reload();
        $('#duplicateModal').modal('hide');
        showToast(t('duplicate.success'), 'success');
      } else {
        const err = await response.json().catch(() => ({}));
        showToast(err.error || t('duplicate.error'), 'error');
      }
    } catch (e) {
      showToast(t('duplicate.error'), 'error');
    }

    btn.innerHTML = originalHtml;
    btn.disabled = false;
    duplicateRouteId = null;
  }

  // Bulk delete functions
  function toggleSelectAllRoutes(checked) {
    document.querySelectorAll('.route-select-check').forEach(cb => {
      cb.checked = checked;
    });
    updateBulkSelection();
  }

  function updateBulkSelection() {
    const checked = document.querySelectorAll('.route-select-check:checked');
    const btn = document.getElementById('bulkDeleteBtn');
    const count = document.getElementById('bulkDeleteCount');
    if (checked.length > 0) {
      btn.style.display = '';
      count.textContent = `${t('bulk.deleteSelected')} (${checked.length})`;
    } else {
      btn.style.display = 'none';
    }
    // Update select all checkbox state
    const all = document.querySelectorAll('.route-select-check');
    const selectAll = document.getElementById('selectAllRoutes');
    if (selectAll) {
      selectAll.checked = all.length > 0 && checked.length === all.length;
      selectAll.indeterminate = checked.length > 0 && checked.length < all.length;
    }
  }

  function openBulkDeleteModal() {
    const checked = document.querySelectorAll('.route-select-check:checked');
    if (checked.length === 0) return;

    const ids = Array.from(checked).map(cb => parseInt(cb.dataset.id));
    const routes = Array.from(tabla.rows().data()).filter(r => ids.includes(r.id));

    const listHtml = routes.map(r =>
      `<div class="delete-info-row">
        <span class="badge-modern badge-${r.tipo}" style="min-width:55px;text-align:center">${r.tipo.toUpperCase()}</span>
        <code class="delete-info-value delete-route-path ms-2">${r.ruta}</code>
      </div>`
    ).join('');

    document.getElementById('bulkDeleteList').innerHTML = listHtml;
    document.getElementById('bulkDeleteConfirmCount').textContent = `${t('buttons.delete')} (${ids.length})`;

    $('#bulkDeleteModal').modal('show');
  }

  async function confirmBulkDelete() {
    const checked = document.querySelectorAll('.route-select-check:checked');
    if (checked.length === 0) return;

    const ids = Array.from(checked).map(cb => parseInt(cb.dataset.id));

    const btn = document.getElementById('confirmBulkDeleteBtn');
    const originalHtml = btn.innerHTML;
    btn.innerHTML = `<i class="fa fa-spinner fa-spin"></i> ${t('buttons.deleting')}`;
    btn.disabled = true;

    try {
      const response = await fetch('/api/delete-bulk', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ ids })
      });
      if (response.ok) {
        tabla.ajax.reload(function() {
          document.getElementById('selectAllRoutes').checked = false;
          updateBulkSelection();
        });
        $('#bulkDeleteModal').modal('hide');
      }
    } catch (err) {
      console.error('Bulk delete error:', err);
    }

    btn.innerHTML = originalHtml;
    btn.disabled = false;
  }

  $("#routesModal").on("hidden.bs.modal", clearModal);

  function clearModal() {
    document.getElementById("tipoSelect").value = 0;
    document.getElementById("ruta").value = '';
    document.getElementById("crespuestaInput").value = '200';
    document.getElementById("respuesta").value = '';
    document.getElementById("destinoProxy").value = '';
    document.getElementById("tiporespuesta").value = 'json';
    document.getElementById("esperaActiva").checked = false;
    document.getElementById("rutaActiva").checked = true;
    document.getElementById("isRegex").checked = false;
    document.getElementById("regexTestUrl").value = '';
    document.getElementById("divRegexValidator").style.display = "none";
    document.getElementById("regexResult").innerHTML = "";
    updateCodeDescription();
    clearHeaders();
    // Limpiar campos de archivo
    clearFileSelection();
    document.getElementById('currentFileInfo').style.display = 'none';
    // Limpiar tags
    TagsModule.clear();
    // Limpiar metadata
    document.getElementById("operationId").value = '';
    document.getElementById("summary").value = '';
    document.getElementById("description").value = '';
  }

  function valuesForModal(obj) {
    document.getElementById("tipoSelect").value = [...document.getElementById('tipoSelect').options].findIndex(opt => opt.text.toLowerCase() === obj.tipo);
    document.getElementById("ruta").value = obj.ruta;
    document.getElementById("crespuestaInput").value = obj.codigo;
    if (obj.tiporespuesta === 'proxy') {
      document.getElementById("destinoProxy").value = obj.respuesta || '';
      document.getElementById("respuesta").value = '';
    } else {
      document.getElementById("respuesta").value = obj.respuesta || '';
      document.getElementById("destinoProxy").value = '';
    }
    document.getElementById("tiporespuesta").value = obj.tiporespuesta;
    document.getElementById("esperaActiva").checked = obj.esperaActiva ?? false;
    document.getElementById("rutaActiva").checked = obj.activo !== 0;
    document.getElementById("isRegex").checked = obj.isRegex === 1;
    updateCodeDescription();
    toggleRegexMode();
    const headers = obj.customHeaders ? JSON.parse(obj.customHeaders) : null;
    setCustomHeaders(headers);
    // Archivo
    clearFileSelection();
    if (obj.tiporespuesta === 'file' && obj.fileName) {
      setCurrentFileInfo(obj.fileName);
    }
    // Tags
    const tags = obj.tags ? JSON.parse(obj.tags) : [];
    TagsModule.setTags(tags);
    // Metadata
    document.getElementById("operationId").value = obj.operationId || '';
    document.getElementById("summary").value = obj.summary || '';
    document.getElementById("description").value = obj.description || '';
  }

  async function guardar() {
    const e = document.getElementById("tipoSelect");
    const tipo = e.options[e.selectedIndex].text.toLowerCase();
    const ruta = document.getElementById("ruta").value;

    // Validar que la ruta no comience con /api/
    if (ruta.startsWith('/api/') || ruta === '/api') {
      showToast(t('confirm.reservedRoute'), 'warning');
      return;
    }

    const codigo = document.getElementById("crespuestaInput").value;
    const tiporespuesta = document.getElementById("tiporespuesta").value;
    let respuesta = tiporespuesta === 'proxy'
      ? document.getElementById("destinoProxy").value
      : document.getElementById("respuesta").value;

    if (tiporespuesta === 'proxy' && respuesta && !respuesta.startsWith('http://') && !respuesta.startsWith('https://')) {
      respuesta = 'https://' + respuesta;
      document.getElementById("destinoProxy").value = respuesta;
    }

    const esperaActiva = document.getElementById("esperaActiva").checked;
    const activo = document.getElementById("rutaActiva").checked;
    const isRegex = document.getElementById("isRegex").checked;
    const customHeaders = getCustomHeaders();

    // Usar FormData para soportar archivos
    const formData = new FormData();
    formData.append('tipo', tipo);
    formData.append('ruta', ruta);
    formData.append('codigo', codigo);
    formData.append('respuesta', respuesta);
    formData.append('tiporespuesta', tiporespuesta);
    formData.append('esperaActiva', esperaActiva);
    formData.append('activo', activo);
    formData.append('isRegex', isRegex);
    if (customHeaders) {
      formData.append('customHeaders', JSON.stringify(customHeaders));
    }

    // Tags
    const tags = TagsModule.getTags();
    if (tags.length > 0) {
      formData.append('tags', JSON.stringify(tags));
    }

    // Metadata fields
    const operationId = document.getElementById("operationId").value;
    const summary = document.getElementById("summary").value;
    const description = document.getElementById("description").value;
    if (operationId) formData.append('operationId', operationId);
    if (summary) formData.append('summary', summary);
    if (description) formData.append('description', description);

    // Añadir archivo si está seleccionado
    if (tiporespuesta === 'file' && selectedFile) {
      formData.append('file', selectedFile);
    }

    const response = await fetch('/api/create', {
      method: 'POST',
      body: formData
    });

    if (response.status === 200) {
      const result = await response.json();

      // Guardar condiciones si hay alguna
      const conditions = getConditions();
      if (conditions.length > 0 && result.id) {
        const condResponse = await fetch(`/api/conditions/${result.id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ conditions })
        });
        if (!condResponse.ok) {
          const err = await condResponse.json().catch(() => ({}));
          showToast(err.error || t('errors.savingConditions'), 'error');
        }
      }

      tabla.ajax.reload();
      $("#routesModal").modal('hide');
    }
  }

  async function editar() {
    const id = $("#idmodal").text();
    const e = document.getElementById("tipoSelect");
    const tipo = e.options[e.selectedIndex].text.toLowerCase();
    const ruta = document.getElementById("ruta").value;

    // Validar que la ruta no comience con /api/
    if (ruta.startsWith('/api/') || ruta === '/api') {
      showToast(t('confirm.reservedRoute'), 'warning');
      return;
    }

    const codigo = document.getElementById("crespuestaInput").value;
    const tiporespuesta = document.getElementById("tiporespuesta").value;
    let respuesta = tiporespuesta === 'proxy'
      ? document.getElementById("destinoProxy").value
      : document.getElementById("respuesta").value;

    if (tiporespuesta === 'proxy' && respuesta && !respuesta.startsWith('http://') && !respuesta.startsWith('https://')) {
      respuesta = 'https://' + respuesta;
      document.getElementById("destinoProxy").value = respuesta;
    }

    const esperaActiva = document.getElementById("esperaActiva").checked;
    const activo = document.getElementById("rutaActiva").checked;
    const isRegex = document.getElementById("isRegex").checked;
    const customHeaders = getCustomHeaders();

    // Usar FormData para soportar archivos
    const formData = new FormData();
    formData.append('tipo', tipo);
    formData.append('ruta', ruta);
    formData.append('codigo', codigo);
    formData.append('respuesta', respuesta);
    formData.append('tiporespuesta', tiporespuesta);
    formData.append('esperaActiva', esperaActiva);
    formData.append('activo', activo);
    formData.append('isRegex', isRegex);
    if (customHeaders) {
      formData.append('customHeaders', JSON.stringify(customHeaders));
    }

    // Tags
    const tags = TagsModule.getTags();
    if (tags.length > 0) {
      formData.append('tags', JSON.stringify(tags));
    }

    // Metadata fields
    const operationId = document.getElementById("operationId").value;
    const summary = document.getElementById("summary").value;
    const description = document.getElementById("description").value;
    if (operationId) formData.append('operationId', operationId);
    if (summary) formData.append('summary', summary);
    if (description) formData.append('description', description);

    // Manejo de archivo
    if (tiporespuesta === 'file') {
      if (selectedFile) {
        formData.append('file', selectedFile);
      } else if (keepExistingFile) {
        formData.append('keepFile', 'true');
      }
    }

    const response = await fetch('/api/update/' + id, {
      method: 'PUT',
      body: formData
    });

    if (response.status === 200) {
      // Guardar condiciones
      const conditions = getConditions();
      if (conditions.length > 0) {
        const condResponse = await fetch(`/api/conditions/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ conditions })
        });
        if (!condResponse.ok) {
          const err = await condResponse.json().catch(() => ({}));
          showToast(err.error || t('errors.savingConditions'), 'error');
        }
      } else {
        // Limpiar condiciones existentes si no hay ninguna
        await fetch(`/api/conditions/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ conditions: [] })
        });
      }

      tabla.ajax.reload();
      $("#routesModal").modal('hide');
    }
  }

  async function iniciaTarea(id) {
    const item = document.getElementById('pl-' + id);
    const defaults = pendingDefaults[id] || {};

    // Obtener valores de los campos
    const bodyTextarea = document.getElementById('prt-' + id);
    const headersTextarea = document.getElementById('prh-' + id);
    const codeInput = document.getElementById('prc-' + id);
    const typeSelect = document.getElementById('prtype-' + id);

    const customData = {};

    // Body de respuesta
    if (bodyTextarea && bodyTextarea.value.trim()) {
      const defaultResponse = defaults.response || item?.dataset.response || '';
      if (bodyTextarea.value.trim() !== defaultResponse.trim()) {
        customData.body = bodyTextarea.value.trim();
      }
    }

    // Código de respuesta
    if (codeInput) {
      const defaultCode = defaults.code || item?.dataset.code || 200;
      if (parseInt(codeInput.value) !== parseInt(defaultCode)) {
        customData.code = parseInt(codeInput.value);
      }
    }

    // Tipo de respuesta
    if (typeSelect) {
      const defaultType = defaults.type || item?.dataset.type || 'json';
      if (typeSelect.value !== defaultType) {
        customData.type = typeSelect.value;
      }
    }

    // Headers personalizados
    if (headersTextarea && headersTextarea.value.trim()) {
      const defaultHeaders = defaults.headers || item?.dataset.headers || '';
      if (headersTextarea.value.trim() !== defaultHeaders.trim()) {
        customData.headers = headersTextarea.value.trim();
      }
    }

    // Solo enviar customResponse si hay algún cambio
    const hasChanges = Object.keys(customData).length > 0;

    await fetch('/api/initTask', {
      method: 'POST',
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ id, customResponse: hasChanges ? customData : null })
    });
  }

  // Almacena los datos por defecto de cada petición pendiente
  const pendingDefaults = {};

  function addItemToPendingList(item) {
    setTotalPending(1);
    // Guardar datos por defecto
    pendingDefaults[item.id] = {
      response: item.defaultResponse || '',
      code: item.codigo || 200,
      type: item.tiporespuesta || 'json',
      headers: item.customHeaders || ''
    };

    // Ocultar estado vacío si existe
    const emptyState = document.getElementById('pendingEmptyState');
    if (emptyState) emptyState.style.display = 'none';

    const canFormat = ['json', 'xml', 'soap', 'html'].includes(item.tiporespuesta);
    const div = document.createElement("div");
    div.className = 'pending-item';
    div.id = 'pl-' + item.id;
    div.dataset.id = item.id;
    div.dataset.response = item.defaultResponse || '';
    div.dataset.type = item.tiporespuesta || 'json';
    div.dataset.code = item.codigo || 200;
    div.dataset.headers = item.customHeaders || '{}';
    div.dataset.originalResponse = item.originalResponse || '';
    div.dataset.originalType = item.originalType || 'json';
    div.dataset.originalCode = item.originalCode || 200;
    div.dataset.originalHeaders = item.originalHeaders || '{}';
    div.dataset.conditions = item.conditions ? encodeURIComponent(JSON.stringify(item.conditions)) : '';

    // Build request headers HTML
    let requestHeadersHtml = '';
    if (item.requestHeaders && typeof item.requestHeaders === 'object') {
      requestHeadersHtml = Object.entries(item.requestHeaders).map(([key, value]) => `
        <div class="request-header-item">
          <span class="request-header-key">${escapeHtml(key)}:</span>
          <span class="request-header-value">${escapeHtml(String(value))}</span>
        </div>
      `).join('');
    }
    if (!requestHeadersHtml) {
      requestHeadersHtml = `<div class="request-headers-empty">${t('pending.noRequestHeaders')}</div>`;
    }

    // Build condition selector HTML
    let conditionSelectorHtml = '';
    if (item.conditions && item.conditions.length > 0) {
      let optionsHtml = item.conditions.map((cond, index) =>
        `<option value="${index}" data-codigo="${cond.codigo || ''}" data-tipo="${cond.tiporespuesta || ''}" data-respuesta="${encodeURIComponent(cond.respuesta || '')}" data-headers="${encodeURIComponent(cond.customHeaders || '')}">${escapeHtml(cond.nombre)}</option>`
      ).join('');
      conditionSelectorHtml = `
        <div class="form-group-modern pending-condition-selector">
          <label class="form-label-modern">${t('pending.selectCondition')}</label>
          <select class="form-control-modern" id="prcs-${item.id}" onchange="selectConditionResponse('${item.id}', this.value)">
            <option value="current">${t('pending.currentResponse')}</option>
            <option value="original">${t('pending.originalResponse')}</option>
            ${optionsHtml}
          </select>
        </div>
      `;
    }

    const method = item.method || 'GET';
    div.innerHTML = `
      <div class="pending-item-header">
        <div class="pending-item-info">
          <span class="badge-method badge-method-${method.toLowerCase()}">${method}</span>
          <span class="pending-item-url">${escapeHtml(item.url)}</span>
          <span class="pending-item-date">${item.date}</span>
        </div>
        <div class="pending-item-actions">
          <button class="btn-icon btn-icon-info" onclick="toggleRequestHeaders('${item.id}')" title="${t('pending.viewRequestHeaders')}">
            <i class="fa fa-list-ul"></i>
          </button>
          <button class="btn-icon btn-icon-primary" onclick="togglePendingResponse('${item.id}')" title="${t('modal.editResponse')}">
            <i class="fa fa-pencil"></i>
          </button>
          <button class="btn-icon btn-icon-success" onclick="iniciaTarea('${item.id}')" title="${t('modal.releaseRequest')}">
            <i class="fa fa-play"></i>
          </button>
        </div>
      </div>
      <div class="pending-request-headers" id="prqh-${item.id}" style="display: none;">
        <div class="request-headers-title">${t('pending.requestHeaders')}</div>
        <div class="request-headers-list">
          ${requestHeadersHtml}
        </div>
      </div>
      <div class="pending-item-response" id="pr-${item.id}" style="display: none;">
        ${conditionSelectorHtml}
        <div class="pending-response-row">
          <div class="form-group-modern pending-code-group">
            <label class="form-label-modern">${t('pending.code')}</label>
            <input type="number" class="form-control-modern" id="prc-${item.id}" value="${item.codigo || 200}" min="100" max="599">
          </div>
          <div class="form-group-modern pending-type-group">
            <label class="form-label-modern">${t('pending.type')}</label>
            <select class="form-control-modern" id="prtype-${item.id}" onchange="togglePendingFormatBtn('${item.id}')">
              <option value="json" ${item.tiporespuesta === 'json' ? 'selected' : ''}>JSON</option>
              <option value="xml" ${item.tiporespuesta === 'xml' ? 'selected' : ''}>XML</option>
              <option value="soap" ${item.tiporespuesta === 'soap' ? 'selected' : ''}>SOAP</option>
              <option value="text" ${item.tiporespuesta === 'text' ? 'selected' : ''}>Texto</option>
              <option value="html" ${item.tiporespuesta === 'html' ? 'selected' : ''}>HTML</option>
            </select>
          </div>
        </div>
        <div class="form-group-modern">
          <label class="form-label-modern">${t('pending.responseBody')}</label>
          <textarea class="form-control-modern" id="prt-${item.id}" rows="6" placeholder="${t('form.placeholder.leaveEmpty')}">${item.defaultResponse || ''}</textarea>
        </div>
        <div class="form-group-modern">
          <label class="form-label-modern">${t('pending.customHeadersJson')}</label>
          <textarea class="form-control-modern" id="prh-${item.id}" rows="3" placeholder='${t('form.placeholder.headersJson')}'>${item.customHeaders || ''}</textarea>
        </div>
        <div class="pending-response-actions">
          <button class="btn-modern btn-modern-secondary btn-sm" onclick="resetPendingResponse('${item.id}')">
            <i class="fa fa-undo"></i> ${t('buttons.restore')}
          </button>
          <button class="btn-modern btn-modern-primary btn-sm" id="prfmt-${item.id}" onclick="formatPendingContent('${item.id}')" style="${!canFormat ? 'display:none' : ''}">
            <i class="fa fa-align-left"></i> ${t('buttons.format')}
          </button>
        </div>
      </div>
    `;
    document.getElementById('pendingListContainer').appendChild(div);
  }

  function deleteItemFromPendingList(id) {
    setTotalPending(-1);
    delete pendingDefaults[id];
    const el = document.getElementById("pl-" + id);
    if (el) el.remove();

    // Mostrar estado vacío si no hay más elementos
    const container = document.getElementById('pendingListContainer');
    if (container && container.children.length === 0) {
      const emptyState = document.getElementById('pendingEmptyState');
      if (emptyState) emptyState.style.display = 'block';
    }
  }

  function togglePendingResponse(id) {
    const responseDiv = document.getElementById('pr-' + id);
    if (responseDiv) {
      const isHidden = responseDiv.style.display === 'none';
      responseDiv.style.display = isHidden ? 'block' : 'none';
    }
  }

  function toggleRequestHeaders(id) {
    const headersDiv = document.getElementById('prqh-' + id);
    if (headersDiv) {
      const isHidden = headersDiv.style.display === 'none';
      headersDiv.style.display = isHidden ? 'block' : 'none';
    }
  }

  function togglePendingFormatBtn(id) {
    const typeSelect = document.getElementById('prtype-' + id);
    const formatBtn = document.getElementById('prfmt-' + id);
    if (typeSelect && formatBtn) {
      const canFormat = ['json', 'xml', 'soap', 'html'].includes(typeSelect.value);
      formatBtn.style.display = canFormat ? '' : 'none';
    }
  }

  function resetPendingResponse(id) {
    const item = document.getElementById('pl-' + id);
    const defaults = pendingDefaults[id] || {};

    const bodyTextarea = document.getElementById('prt-' + id);
    const headersTextarea = document.getElementById('prh-' + id);
    const codeInput = document.getElementById('prc-' + id);
    const typeSelect = document.getElementById('prtype-' + id);
    const conditionSelect = document.getElementById('prcs-' + id);

    if (bodyTextarea) bodyTextarea.value = defaults.response || item?.dataset.response || '';
    if (headersTextarea) headersTextarea.value = defaults.headers || item?.dataset.headers || '';
    if (codeInput) codeInput.value = defaults.code || item?.dataset.code || 200;
    if (typeSelect) {
      typeSelect.value = defaults.type || item?.dataset.type || 'json';
      togglePendingFormatBtn(id);
    }
    // Reset condition selector to current
    if (conditionSelect) conditionSelect.value = 'current';
  }

  function selectConditionResponse(id, value) {
    const item = document.getElementById('pl-' + id);
    if (!item) return;

    const bodyTextarea = document.getElementById('prt-' + id);
    const headersTextarea = document.getElementById('prh-' + id);
    const codeInput = document.getElementById('prc-' + id);
    const typeSelect = document.getElementById('prtype-' + id);
    const conditionSelect = document.getElementById('prcs-' + id);

    let newCode, newType, newBody, newHeaders;

    if (value === 'current') {
      // Restore to the evaluated response (what's stored in pendingDefaults)
      const defaults = pendingDefaults[id] || {};
      newCode = defaults.code || item.dataset.code || 200;
      newType = defaults.type || item.dataset.type || 'json';
      newBody = defaults.response || item.dataset.response || '';
      newHeaders = defaults.headers || item.dataset.headers || '';
    } else if (value === 'original') {
      // Restore to original route response (before criteria evaluation)
      newCode = item.dataset.originalCode || 200;
      newType = item.dataset.originalType || 'json';
      newBody = item.dataset.originalResponse || '';
      newHeaders = item.dataset.originalHeaders || '';
    } else {
      // Load from selected condition
      const selectedOption = conditionSelect.options[conditionSelect.selectedIndex];
      if (selectedOption) {
        newCode = selectedOption.dataset.codigo || item.dataset.code || 200;
        newType = selectedOption.dataset.tipo || item.dataset.type || 'json';
        newBody = selectedOption.dataset.respuesta ? decodeURIComponent(selectedOption.dataset.respuesta) : '';
        newHeaders = selectedOption.dataset.headers ? decodeURIComponent(selectedOption.dataset.headers) : '';
      }
    }

    // Apply the values
    if (codeInput && newCode) codeInput.value = newCode;
    if (typeSelect && newType) {
      typeSelect.value = newType;
      togglePendingFormatBtn(id);
    }
    if (bodyTextarea) bodyTextarea.value = newBody || '';
    if (headersTextarea) headersTextarea.value = newHeaders || '';
  }

  function formatPendingContent(id) {
    const textarea = document.getElementById('prt-' + id);
    const typeSelect = document.getElementById('prtype-' + id);

    if (!textarea || !textarea.value.trim()) return;

    const tipo = typeSelect ? typeSelect.value : 'json';

    try {
      if (tipo === 'json') {
        const parsed = JSON.parse(textarea.value);
        textarea.value = JSON.stringify(parsed, null, 2);
      } else if (tipo === 'xml' || tipo === 'soap') {
        textarea.value = formatXml(textarea.value);
      } else if (tipo === 'html') {
        textarea.value = formatHtml(textarea.value);
      }
    } catch (e) {
      showToast(`${t('responseTypes.' + tipo) || tipo.toUpperCase()} ${t('validation.' + tipo + 'Invalid')}: ${e.message}`, 'error');
    }
  }

  function setTotalPending(number) {
    totalPending = totalPending + number;
    const badge = document.getElementById('pendingBadge');
    badge.textContent = totalPending;
    badge.style.display = totalPending > 0 ? 'flex' : 'none';
  }

  // ===== TOGGLE ACTIVO =====
  async function toggleActivo(id, activo) {
    const response = await fetch('/api/toggle-active/' + id, {
      method: 'PUT',
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ activo })
    });
    if (response.status === 200) {
      tabla.ajax.reload();
    }
  }

  async function toggleEsperaActiva(id, esperaActiva) {
    const response = await fetch('/api/toggle-wait/' + id, {
      method: 'PUT',
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ esperaActiva })
    });
    if (response.status === 200) {
      tabla.ajax.reload();
    }
  }

  // ===== CURL MODAL =====
  let currentCurlRoute = null;

  function openCurlModal(id) {
    const obj = Array.from(tabla.rows().data()).find(el => el.id === id);
    if (!obj) return;

    currentCurlRoute = obj;
    const baseUrl = window.location.origin;
    const method = obj.tipo.toUpperCase();
    const isRegex = obj.isRegex === 1;

    // Generar ruta de ejemplo para regex (usar función compartida)
    let exampleRoute = obj.ruta;
    if (isRegex) {
      exampleRoute = regexToSampleUrl(obj.ruta);
    }

    const fullUrl = baseUrl + exampleRoute;
    const cleanRoute = exampleRoute; // Guardar ruta limpia para el botón

    // Actualizar info
    document.getElementById('curlMethod').textContent = method;
    document.getElementById('curlMethod').className = `badge-modern badge-${obj.tipo}`;
    document.getElementById('curlRoute').textContent = isRegex ? `${obj.ruta} (regex)` : obj.ruta;
    document.getElementById('curlFullUrl').textContent = fullUrl;

    // Mostrar metadata si existe
    const operationIdRow = document.getElementById('curlOperationIdRow');
    const summaryRow = document.getElementById('curlSummaryRow');
    const descriptionRow = document.getElementById('curlDescriptionRow');

    if (obj.operationId) {
      document.getElementById('curlOperationId').textContent = obj.operationId;
      operationIdRow.style.display = 'flex';
    } else {
      operationIdRow.style.display = 'none';
    }

    if (obj.summary) {
      document.getElementById('curlSummary').textContent = obj.summary;
      summaryRow.style.display = 'flex';
    } else {
      summaryRow.style.display = 'none';
    }

    if (obj.description) {
      document.getElementById('curlDescription').textContent = obj.description;
      descriptionRow.style.display = 'flex';
    } else {
      descriptionRow.style.display = 'none';
    }

    // Generar comando curl
    let curlCmd = `curl -X ${method} "${fullUrl}"`;

    if (method === 'POST' || method === 'PUT' || method === 'PATCH') {
      curlCmd += ` \\\n  -H "Content-Type: application/json" \\\n  -d '{}'`;
    }

    document.getElementById('curlCommand').textContent = curlCmd;

    // Mostrar boton de abrir solo para GET (incluyendo rutas regex)
    const openSection = document.getElementById('curlOpenSection');
    if (method === 'GET') {
      openSection.style.display = 'block';
      // Guardar la ruta limpia para usar en el botón
      openSection.dataset.cleanRoute = cleanRoute;
    } else {
      openSection.style.display = 'none';
    }

    $("#curlModal").modal('show');
  }

  function copyCurl() {
    const curlText = document.getElementById('curlCommand').textContent;
    navigator.clipboard.writeText(curlText).then(() => {
      const btn = document.querySelector('#curlModal .btn-modern-secondary.btn-sm');
      const originalHtml = btn.innerHTML;
      btn.innerHTML = `<i class="fa fa-check"></i> ${t('buttons.copied')}`;
      setTimeout(() => {
        btn.innerHTML = originalHtml;
      }, 2000);
    });
  }

  function openRouteInBrowser() {
    if (currentCurlRoute && currentCurlRoute.tipo === 'get') {
      const openSection = document.getElementById('curlOpenSection');
      const cleanRoute = openSection.dataset.cleanRoute || currentCurlRoute.ruta;
      window.open(cleanRoute, '_blank');
    }
  }

  // ===== OPENAPI IMPORT =====
  let importPreviewData = null;

  // ImportTagsModule - separate module for import modal tags
  const ImportTagsModule = {
    availableTags: [],
    selectedTags: [],
    predefinedColors: [
      '#6366f1', '#8b5cf6', '#ec4899', '#ef4444', '#f97316', '#f59e0b',
      '#10b981', '#14b8a6', '#06b6d4', '#3b82f6', '#374151', '#1e293b'
    ],

    async init() {
      await this.loadTags();
      this.renderColorPalette();
    },

    async loadTags() {
      try {
        const response = await fetch('/api/tags');
        const data = await response.json();
        if (data.success) {
          this.availableTags = data.tags;
          this.renderTagSelector();
        }
      } catch (e) {
        console.error('Error loading tags for import:', e);
      }
    },

    renderTagSelector() {
      const container = document.getElementById('importTagsSelector');
      if (!container) return;

      // Only show selected tags with remove buttons
      if (this.selectedTags.length === 0) {
        container.innerHTML = '<span class="no-tags-msg">' + t('empty.noTags') + '</span>';
        return;
      }

      let html = '<div class="selected-tags-display">';
      this.selectedTags.forEach(tag => {
        html += `<span class="badge-tag badge-tag-removable" style="background: ${tag.color};">
          ${this.escapeHtml(tag.name)}
          <button type="button" class="tag-remove" onclick="ImportTagsModule.removeTag('${tag.id}')" title="Eliminar">
            <i class="fa fa-times"></i>
          </button>
        </span>`;
      });
      html += '</div>';

      container.innerHTML = html;
    },

    removeTag(tagId) {
      const index = this.selectedTags.findIndex(t => t.id === tagId);
      if (index >= 0) {
        this.selectedTags.splice(index, 1);
        this.renderTagSelector();
      }
    },

    addTag(tagId) {
      const tag = this.availableTags.find(t => t.id === tagId);
      if (!tag) return;

      if (this.selectedTags.find(t => t.id === tagId)) {
        this.closeCreator();
        return;
      }

      this.selectedTags.push(tag);
      this.renderTagSelector();
      this.closeCreator();
    },

    getTags() {
      return this.selectedTags;
    },

    clear() {
      this.selectedTags = [];
      this.renderTagSelector();
    },

    renderColorPalette() {
      const container = document.getElementById('importColorPalette');
      if (!container) return;

      container.innerHTML = this.predefinedColors.map((color, i) => `
        <button type="button" class="color-swatch ${i === 0 ? 'selected' : ''}"
          style="background: ${color};"
          data-color="${color}"
          onclick="ImportTagsModule.selectColor('${color}')">
        </button>
      `).join('');
    },

    selectColor(color) {
      document.querySelectorAll('#importColorPalette .color-swatch').forEach(el => el.classList.remove('selected'));
      const swatch = document.querySelector(`#importColorPalette .color-swatch[data-color="${color}"]`);
      if (swatch) swatch.classList.add('selected');
      document.getElementById('importCustomTagColor').value = color;
    },

    async createOrAddTag() {
      const name = document.getElementById('importNewTagName').value.trim();
      const color = document.getElementById('importCustomTagColor').value;

      if (!name) {
        showToast(t('validation.tagNameRequired'), 'warning');
        return;
      }

      // Check if tag already exists
      const existingTag = this.availableTags.find(t =>
        t.name.toLowerCase() === name.toLowerCase()
      );

      if (existingTag) {
        if (!this.selectedTags.find(t => t.id === existingTag.id)) {
          this.selectedTags.push(existingTag);
          this.renderTagSelector();
        }
        this.closeCreator();
        return;
      }

      // Create new tag
      try {
        const response = await fetch('/api/tags', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, color })
        });
        const data = await response.json();

        if (data.success) {
          this.availableTags.push(data.tag);
          this.selectedTags.push(data.tag);
          this.renderTagSelector();
          this.closeCreator();
          TagsModule.availableTags.push(data.tag);
          TagsModule.renderTagSelector();
          initTagFilter();
        } else {
          showToast(data.error || t('errors.creatingTag'), 'error');
        }
      } catch (e) {
        showToast(t('errors.creatingTag'), 'error');
      }
    },

    openCreator() {
      document.getElementById('importNewTagName').value = '';
      document.getElementById('importCustomTagColor').value = '#6366f1';
      this.selectColor('#6366f1');
      this.renderTagSuggestions();
      document.getElementById('importTagCreatorPopup').style.display = 'flex';
    },

    closeCreator() {
      document.getElementById('importTagCreatorPopup').style.display = 'none';
    },

    renderTagSuggestions(filter = '') {
      const container = document.getElementById('importTagSuggestions');
      if (!container) return;

      let availableToAdd = this.availableTags.filter(tag =>
        !this.selectedTags.find(t => t.id === tag.id)
      );

      if (filter) {
        const lowerFilter = filter.toLowerCase();
        availableToAdd = availableToAdd.filter(tag =>
          tag.name.toLowerCase().includes(lowerFilter)
        );
      }

      if (availableToAdd.length === 0) {
        container.innerHTML = filter
          ? `<div class="tag-suggestions-empty">${t('form.noMatchingTags')}</div>`
          : '';
        return;
      }

      container.innerHTML = availableToAdd.map(tag => `
        <button type="button" class="tag-suggestion" style="--tag-color: ${tag.color};"
          onclick="ImportTagsModule.addTag('${tag.id}')">
          <span class="badge-tag" style="background: ${tag.color};">${this.escapeHtml(tag.name)}</span>
        </button>
      `).join('');
    },

    filterSuggestions() {
      const input = document.getElementById('importNewTagName');
      this.renderTagSuggestions(input.value.trim());
    },

    escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
  };

  function openImportModal() {
    importPreviewData = null;
    document.getElementById('importStep1').style.display = 'block';
    document.getElementById('importStep2').style.display = 'none';
    document.getElementById('importLoading').style.display = 'none';
    document.getElementById('importError').style.display = 'none';
    document.getElementById('importPreviewBtn').style.display = 'inline-flex';
    document.getElementById('importBackBtn').style.display = 'none';
    document.getElementById('importConfirmBtn').style.display = 'none';
    document.getElementById('importSpecFile').value = '';
    document.getElementById('importSpecUrl').value = '';
    document.getElementById('importSpecContent').value = '';
    document.getElementById('importBasePath').value = '';
    // Initialize import tags module
    ImportTagsModule.clear();
    ImportTagsModule.init();
    $('#importOpenApiModal').modal('show');
  }

  async function previewImport() {
    const formData = new FormData();
    const fileInput = document.getElementById('importSpecFile');
    const contentInput = document.getElementById('importSpecContent');
    const urlInput = document.getElementById('importSpecUrl');
    const basePath = document.getElementById('importBasePath').value;
    const format = document.getElementById('importSpecFormat').value;

    const activeTab = document.querySelector('#importOpenApiModal .nav-link.active');
    const activeTarget = activeTab.getAttribute('data-bs-target');

    if (activeTarget === '#importTabFile' && fileInput.files.length > 0) {
      formData.append('specFile', fileInput.files[0]);
    } else if (activeTarget === '#importTabUrl' && urlInput.value.trim()) {
      formData.append('specUrl', urlInput.value.trim());
    } else if (activeTarget === '#importTabPaste' && contentInput.value.trim()) {
      formData.append('content', contentInput.value.trim());
      formData.append('format', format);
    } else {
      showImportError(t('import.noSpecProvided'));
      return;
    }

    formData.append('basePath', basePath);

    document.getElementById('importStep1').style.display = 'none';
    document.getElementById('importLoading').style.display = 'block';
    document.getElementById('importError').style.display = 'none';
    document.getElementById('importPreviewBtn').style.display = 'none';

    try {
      const response = await fetch('/api/import-openapi/preview', {
        method: 'POST',
        body: formData
      });
      const data = await response.json();

      if (!data.success) {
        showImportError(data.error);
        importGoBack();
        return;
      }

      importPreviewData = data;
      renderImportPreview(data);
    } catch (err) {
      showImportError(err.message);
      importGoBack();
    }
  }

  function renderImportPreview(data) {
    document.getElementById('importLoading').style.display = 'none';
    document.getElementById('importStep2').style.display = 'block';
    document.getElementById('importBackBtn').style.display = 'inline-flex';
    document.getElementById('importConfirmBtn').style.display = 'inline-flex';

    document.getElementById('importSpecTitle').textContent =
      `${data.specInfo.title} v${data.specInfo.version}`;
    document.getElementById('importSpecDetails').textContent =
      `${data.specInfo.format} | ${data.specInfo.pathCount} paths | ${data.specInfo.operationCount} operations`;

    const tbody = document.getElementById('importRoutesPreview');
    tbody.innerHTML = '';

    data.routes.forEach((route, index) => {
      const methodColors = {
        get: '#61affe', post: '#49cc90', put: '#fca130',
        delete: '#f93e3e', patch: '#50e3c2', options: '#0d5aa7', head: '#9012fe'
      };
      const color = methodColors[route.tipo] || '#999';

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input type="checkbox" class="import-route-check" data-index="${index}" checked onchange="updateImportCount()"></td>
        <td><span style="background: ${color}; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.75em; font-weight: 600;">${route.tipo.toUpperCase()}</span></td>
        <td><code style="font-size: 0.85em;">${escapeHtml(route.ruta)}</code>
          ${route.isRegex ? '<i class="fa fa-asterisk" style="color: var(--warning); font-size: 0.7em;" title="Regex"></i>' : ''}</td>
        <td>${route.codigo}</td>
        <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"
            title="${escapeHtml(route._summary || route._operationId || '')}">
          ${escapeHtml(route._summary || route._operationId || '-')}</td>
        <td>${route._conflict
          ? '<span style="background: var(--warning); color: #000; padding: 2px 8px; border-radius: 4px; font-size: 0.75em;">' + t('import.conflict') + '</span>'
          : '<span style="background: var(--success); color: #fff; padding: 2px 8px; border-radius: 4px; font-size: 0.75em;">' + t('import.new') + '</span>'
        }</td>
      `;
      tbody.appendChild(tr);
    });

    updateImportCount();
  }

  function toggleAllImportRoutes(checked) {
    document.querySelectorAll('.import-route-check').forEach(cb => cb.checked = checked);
    updateImportCount();
  }

  function updateImportCount() {
    const checked = document.querySelectorAll('.import-route-check:checked').length;
    const total = document.querySelectorAll('.import-route-check').length;
    document.getElementById('importSelectedCount').textContent = `(${checked}/${total})`;
  }

  function importGoBack() {
    document.getElementById('importStep1').style.display = 'block';
    document.getElementById('importStep2').style.display = 'none';
    document.getElementById('importLoading').style.display = 'none';
    document.getElementById('importPreviewBtn').style.display = 'inline-flex';
    document.getElementById('importBackBtn').style.display = 'none';
    document.getElementById('importConfirmBtn').style.display = 'none';
  }

  async function confirmImport() {
    if (!importPreviewData) return;

    const selectedRoutes = [];
    document.querySelectorAll('.import-route-check:checked').forEach(cb => {
      const index = parseInt(cb.dataset.index);
      const route = importPreviewData.routes[index];
      selectedRoutes.push({
        tipo: route.tipo,
        ruta: route.ruta,
        codigo: route.codigo,
        tiporespuesta: route.tiporespuesta,
        respuesta: route.respuesta,
        isRegex: route.isRegex,
        operationId: route.operationId,
        summary: route.summary,
        description: route.description,
        openApiTags: route.openApiTags
      });
    });

    if (selectedRoutes.length === 0) return;

    const conflictStrategy = document.getElementById('importConflictStrategy').value;
    const importTags = ImportTagsModule.getTags();
    const btn = document.getElementById('importConfirmBtn');
    btn.disabled = true;
    btn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> ' + t('import.importing');

    try {
      const response = await fetch('/api/import-openapi/confirm', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ routes: selectedRoutes, conflictStrategy, tags: importTags })
      });
      const data = await response.json();

      if (data.success) {
        tabla.ajax.reload();
        $('#importOpenApiModal').modal('hide');
        showToast(`${t('import.successMessage')}: ${data.imported} ${t('import.importedCount')}` +
          (data.skipped > 0 ? `, ${data.skipped} ${t('import.skippedCount')}` : ''), 'success');
      } else {
        showImportError(data.error);
      }
    } catch (err) {
      showImportError(err.message);
    } finally {
      btn.disabled = false;
      btn.innerHTML = '<i class="fa fa-download"></i> ' + t('import.importRoutes');
    }
  }

  function showImportError(message) {
    document.getElementById('importError').style.display = 'flex';
    document.getElementById('importErrorMsg').textContent = message;
  }

  function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // ===== REQUEST TESTER (Postman-like) =====
  let testerRowCounter = 0;
  const methodColors = {
    GET: 'badge-get',
    POST: 'badge-post',
    PUT: 'badge-put',
    DELETE: 'badge-delete',
    PATCH: 'badge-patch',
    OPTIONS: 'badge-options',
    HEAD: 'badge-head'
  };

  function regexToSampleUrl(regexPattern) {
    // Convert a regex pattern to a sample URL
    let sample = regexPattern;
    let paramCounter = 0;

    // Handle [^/]+ and [^/]* patterns - the most common path parameter regex
    // We need to look at the preceding path segment to name the parameter
    sample = sample.replace(/(\/[a-zA-Z0-9_-]+)\/\[\^\/\][\+\*]/g, (match, prevSegment) => {
      const segmentName = prevSegment.replace('/', '');
      paramCounter++;
      // Convert plural to singular for parameter name (e.g., /users/[^/]+ -> /users/{userId})
      if (/^[a-zA-Z]+s$/.test(segmentName)) {
        return `${prevSegment}/{${segmentName.slice(0, -1)}Id}`;
      } else if (/^[a-zA-Z]+$/.test(segmentName)) {
        return `${prevSegment}/{${segmentName}Id}`;
      }
      return `${prevSegment}/{param${paramCounter}}`;
    });

    // Handle remaining [^/]+ patterns without clear context
    sample = sample.replace(/\[\^\/\][\+\*]/g, () => {
      paramCounter++;
      return `{param${paramCounter}}`;
    });

    // Common regex pattern replacements for remaining patterns
    const replacements = [
      [/\(\?:[^)]+\)/g, ''],           // Remove non-capturing groups
      [/\([^)]+\)/g, 'value'],         // Replace capturing groups
      [/\\d\+/g, '123'],               // \d+ -> 123
      [/\\d\*/g, '12'],                // \d* -> 12
      [/\\d\{(\d+)\}/g, (m, n) => '1'.repeat(parseInt(n))], // \d{n} -> n digits
      [/\\d\{(\d+),(\d+)\}/g, (m, min) => '1'.repeat(parseInt(min))], // \d{n,m}
      [/\\d/g, '1'],                   // \d -> 1
      [/\\w\+/g, 'example'],           // \w+ -> example
      [/\\w\*/g, 'test'],              // \w* -> test
      [/\\w/g, 'x'],                   // \w -> x
      [/\\s\+/g, ' '],                 // \s+ -> space
      [/\\s\*/g, ''],                  // \s* -> empty
      [/\\s/g, ' '],                   // \s -> space
      [/\.\+/g, 'something'],          // .+ -> something
      [/\.\*/g, ''],                   // .* -> empty
      [/\[([^\]]+)\]/g, (m, chars) => chars.replace(/[^a-zA-Z0-9]/g, '')[0] || 'x'], // [abc] -> a (for remaining brackets)
      [/\{(\d+)\}/g, ''],              // Remove quantifiers like {2}
      [/\{(\d+),(\d+)?\}/g, ''],       // Remove quantifiers like {2,5}
      [/\+/g, ''],                     // Remove +
      [/\*/g, ''],                     // Remove *
      [/\?/g, ''],                     // Remove ?
      [/\^/g, ''],                     // Remove ^
      [/\$/g, ''],                     // Remove $
      [/\|[^/]*/g, ''],                // Remove alternations (keep first option)
      [/\\\//g, '/'],                  // \/ -> /
      [/\\\./g, '.'],                  // \. -> .
      [/\\-/g, '-'],                   // \- -> -
      [/\\_/g, '_'],                   // \_ -> _
      [/\\\\/g, ''],                   // Remove escaped backslashes
    ];

    for (const [pattern, replacement] of replacements) {
      sample = sample.replace(pattern, replacement);
    }

    // Clean up any remaining backslashes
    sample = sample.replace(/\\/g, '');

    // Clean up multiple consecutive slashes
    sample = sample.replace(/\/+/g, '/');

    // Ensure it starts with /
    if (!sample.startsWith('/')) {
      sample = '/' + sample;
    }

    // Remove trailing slash (unless it's the only character)
    if (sample.length > 1 && sample.endsWith('/')) {
      sample = sample.slice(0, -1);
    }

    return sample;
  }

  function openRequestTester(id) {
    const obj = Array.from(tabla.rows().data()).find(el => el.id === id);
    if (!obj) return;

    // Reset form
    clearTesterForm();

    // Set method
    const method = obj.tipo.toUpperCase();
    document.getElementById('testerMethod').value = method === 'ANY' ? 'GET' : method;

    // Set URL
    const baseUrl = window.location.origin;
    let route = obj.ruta;
    if (obj.isRegex) {
      // For regex routes, convert to a sample URL
      route = regexToSampleUrl(route);
    }
    document.getElementById('testerUrl').value = baseUrl + route;

    // Open modal
    const modal = new bootstrap.Modal(document.getElementById('requestTesterModal'));
    modal.show();
  }

  function clearTesterForm() {
    document.getElementById('testerMethod').value = 'GET';
    document.getElementById('testerUrl').value = '';
    document.getElementById('testerParamsContainer').innerHTML = '';
    document.getElementById('testerHeadersContainer').innerHTML = '';
    document.getElementById('testerFormContainer').innerHTML = '';
    document.getElementById('testerUrlencodedContainer').innerHTML = '';
    document.getElementById('testerBodyJson').value = '';
    document.getElementById('testerBodyRaw').value = '';
    document.querySelector('input[name="bodyType"][value="none"]').checked = true;
    changeBodyType('none');
    clearTesterResponse();
    updateTesterCounts();
    document.getElementById('noParamsMsg').style.display = 'block';
    document.getElementById('noHeadersTestMsg').style.display = 'block';
    document.getElementById('noFormMsg').style.display = 'block';
    document.getElementById('noUrlencodedMsg').style.display = 'block';
  }

  function clearTesterResponse() {
    document.getElementById('responseSection').style.display = 'none';
    document.getElementById('responseBody').textContent = '';
    document.getElementById('responseHeaders').innerHTML = '';
    document.getElementById('responseStatus').textContent = '';
    document.getElementById('responseTime').textContent = '';
    document.getElementById('responseSize').textContent = '';
  }

  function addTesterParam(key = '', value = '') {
    addTesterKeyValueRow('testerParamsContainer', 'param', key, value);
    document.getElementById('noParamsMsg').style.display = 'none';
    updateTesterCounts();
  }

  function addTesterHeader(key = '', value = '') {
    addTesterKeyValueRow('testerHeadersContainer', 'header', key, value);
    document.getElementById('noHeadersTestMsg').style.display = 'none';
    updateTesterCounts();
  }

  function addTesterFormField(key = '', value = '') {
    addTesterKeyValueRow('testerFormContainer', 'form', key, value);
    document.getElementById('noFormMsg').style.display = 'none';
  }

  function addTesterUrlencodedField(key = '', value = '') {
    addTesterKeyValueRow('testerUrlencodedContainer', 'urlencoded', key, value);
    document.getElementById('noUrlencodedMsg').style.display = 'none';
  }

  function addTesterKeyValueRow(containerId, type, key = '', value = '') {
    testerRowCounter++;
    const container = document.getElementById(containerId);
    const row = document.createElement('div');
    row.className = 'key-value-row';
    row.id = `tester-row-${testerRowCounter}`;
    row.innerHTML = `
      <input type="checkbox" class="key-value-check" checked>
      <input type="text" class="form-control-modern key-input" placeholder="${t('requestTester.key')}" value="${escapeHtml(key)}">
      <input type="text" class="form-control-modern value-input" placeholder="${t('requestTester.value')}" value="${escapeHtml(value)}">
      <button class="btn-icon btn-icon-danger" onclick="removeTesterRow(${testerRowCounter}, '${containerId}', '${type}')" title="${t('buttons.delete')}">
        <i class="fa fa-trash"></i>
      </button>
    `;
    container.appendChild(row);
  }

  function removeTesterRow(id, containerId, type) {
    document.getElementById(`tester-row-${id}`)?.remove();
    const container = document.getElementById(containerId);
    if (container.children.length === 0) {
      if (type === 'param') document.getElementById('noParamsMsg').style.display = 'block';
      if (type === 'header') document.getElementById('noHeadersTestMsg').style.display = 'block';
      if (type === 'form') document.getElementById('noFormMsg').style.display = 'block';
      if (type === 'urlencoded') document.getElementById('noUrlencodedMsg').style.display = 'block';
    }
    updateTesterCounts();
  }

  function updateTesterCounts() {
    const paramsCount = document.querySelectorAll('#testerParamsContainer .key-value-row').length;
    const headersCount = document.querySelectorAll('#testerHeadersContainer .key-value-row').length;
    document.getElementById('paramsCount').textContent = paramsCount;
    document.getElementById('headersCount').textContent = headersCount;
  }

  function changeBodyType(type) {
    ['bodyNone', 'bodyJson', 'bodyForm', 'bodyUrlencoded', 'bodyRaw'].forEach(id => {
      document.getElementById(id).style.display = 'none';
    });
    document.getElementById('body' + type.charAt(0).toUpperCase() + type.slice(1)).style.display = 'block';
  }

  function formatTesterJson() {
    const textarea = document.getElementById('testerBodyJson');
    try {
      const parsed = JSON.parse(textarea.value);
      textarea.value = JSON.stringify(parsed, null, 2);
    } catch (e) {
      showToast(t('validation.jsonInvalid'), 'error');
    }
  }

  function getKeyValuePairs(containerId) {
    const pairs = {};
    document.querySelectorAll(`#${containerId} .key-value-row`).forEach(row => {
      const checked = row.querySelector('.key-value-check').checked;
      if (!checked) return;
      const key = row.querySelector('.key-input').value.trim();
      const value = row.querySelector('.value-input').value;
      if (key) pairs[key] = value;
    });
    return pairs;
  }

  async function sendTestRequest() {
    const method = document.getElementById('testerMethod').value;
    let url = document.getElementById('testerUrl').value.trim();

    if (!url) {
      showToast(t('requestTester.urlRequired'), 'error');
      return;
    }

    // Add query params to URL
    const params = getKeyValuePairs('testerParamsContainer');
    if (Object.keys(params).length > 0) {
      const urlObj = new URL(url);
      Object.entries(params).forEach(([k, v]) => urlObj.searchParams.append(k, v));
      url = urlObj.toString();
    }

    // Build headers
    const headers = getKeyValuePairs('testerHeadersContainer');

    // Add cache-busting headers to prevent 304 responses
    headers['Cache-Control'] = 'no-cache, no-store, must-revalidate';
    headers['Pragma'] = 'no-cache';
    headers['X-Request-Time'] = Date.now().toString();

    // Build body
    let body = null;
    const bodyType = document.querySelector('input[name="bodyType"]:checked').value;

    if (method !== 'GET' && method !== 'HEAD') {
      if (bodyType === 'json') {
        const jsonBody = document.getElementById('testerBodyJson').value.trim();
        if (jsonBody) {
          body = jsonBody;
          if (!headers['Content-Type']) headers['Content-Type'] = 'application/json';
        }
      } else if (bodyType === 'form') {
        const formData = new FormData();
        document.querySelectorAll('#testerFormContainer .key-value-row').forEach(row => {
          if (!row.querySelector('.key-value-check').checked) return;
          const key = row.querySelector('.key-input').value.trim();
          const value = row.querySelector('.value-input').value;
          if (key) formData.append(key, value);
        });
        body = formData;
        // Don't set Content-Type for FormData, browser will set it with boundary
      } else if (bodyType === 'urlencoded') {
        const urlParams = new URLSearchParams();
        document.querySelectorAll('#testerUrlencodedContainer .key-value-row').forEach(row => {
          if (!row.querySelector('.key-value-check').checked) return;
          const key = row.querySelector('.key-input').value.trim();
          const value = row.querySelector('.value-input').value;
          if (key) urlParams.append(key, value);
        });
        body = urlParams.toString();
        if (!headers['Content-Type']) headers['Content-Type'] = 'application/x-www-form-urlencoded';
      } else if (bodyType === 'raw') {
        body = document.getElementById('testerBodyRaw').value;
      }
    }

    // Show loading
    document.getElementById('requestLoading').style.display = 'flex';
    document.getElementById('responseSection').style.display = 'none';
    document.getElementById('testerSendBtn').disabled = true;

    const startTime = performance.now();

    try {
      const fetchOptions = { method, headers };
      if (body && method !== 'GET' && method !== 'HEAD') {
        fetchOptions.body = body;
      }

      const response = await fetch(url, fetchOptions);
      const endTime = performance.now();
      const duration = Math.round(endTime - startTime);

      // Get response body
      const contentType = response.headers.get('content-type') || '';
      let responseText = await response.text();
      let responseSize = new Blob([responseText]).size;

      // Try to format JSON
      if (contentType.includes('json')) {
        try {
          responseText = JSON.stringify(JSON.parse(responseText), null, 2);
        } catch (e) {}
      }

      // Update response UI
      document.getElementById('responseSection').style.display = 'block';
      document.getElementById('responseBody').textContent = responseText;

      // Status badge
      const statusEl = document.getElementById('responseStatus');
      statusEl.textContent = `${response.status} ${response.statusText}`;
      statusEl.className = 'response-status ' + (response.ok ? 'status-success' : response.status >= 400 ? 'status-error' : 'status-warning');

      // Time and size
      document.getElementById('responseTime').textContent = `${duration}ms`;
      document.getElementById('responseSize').textContent = formatBytes(responseSize);

      // Headers
      const headersHtml = [];
      response.headers.forEach((value, key) => {
        headersHtml.push(`<div class="response-header-row"><span class="header-key">${escapeHtml(key)}:</span> <span class="header-value">${escapeHtml(value)}</span></div>`);
      });
      document.getElementById('responseHeaders').innerHTML = headersHtml.join('');

    } catch (e) {
      document.getElementById('responseSection').style.display = 'block';
      document.getElementById('responseBody').textContent = `Error: ${e.message}`;
      document.getElementById('responseStatus').textContent = 'Error';
      document.getElementById('responseStatus').className = 'response-status status-error';
      document.getElementById('responseTime').textContent = '';
      document.getElementById('responseSize').textContent = '';
      document.getElementById('responseHeaders').innerHTML = '';
    }

    document.getElementById('requestLoading').style.display = 'none';
    document.getElementById('testerSendBtn').disabled = false;
  }

  function formatBytes(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
  }

  // Initialize tooltips
  var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
  tooltipTriggerList.map(el => new bootstrap.Tooltip(el));
</script>
